# データベースマイグレーション手順

## 紙のトリアージタッグ詳細項目追加

### 実行するSQLファイル
- `add-triage-tag-fields.sql`

### 実行方法

#### 方法1: Supabase Dashboard（推奨）

1. Supabaseダッシュボードにログイン
   - https://supabase.com/dashboard

2. プロジェクトを選択

3. 左サイドバーから「SQL Editor」を選択

4. 「New query」をクリック

5. `add-triage-tag-fields.sql` の内容をコピー&ペースト

6. 「Run」ボタンをクリックして実行

7. 成功メッセージを確認

#### 方法2: Supabase CLI

```bash
# Supabase CLIがインストールされている場合
supabase db push
```

### 追加されるカラム

| カラム名 | 型 | 説明 |
|---------|-----|------|
| conveyer | TEXT | 搬送機関名 |
| execution_places | TEXT[] | トリアージ実施場所（配列） |
| execution_place_other | TEXT | トリアージ実施場所のその他詳細 |
| rescue_place | TEXT | 救出場所 |
| enforcement_organization | TEXT | トリアージ実施機関 |
| enforcement_organization_other | TEXT | トリアージ実施機関のその他詳細 |
| conditions | TEXT[] | 症状・傷病名（配列） |
| condition_other | TEXT | 症状・傷病名のその他詳細 |
| vital_signs_records | JSONB | バイタルサイン複数回記録 |

### バイタルサイン記録のデータ構造

```json
{
  "first": {
    "judger_name": "判定者名",
    "judgment_location": "判定場所",
    "judgment_time": "HH:MM",
    "consciousness": "I|II|III",
    "respiratory_rate": 20,
    "pulse_rate": 80,
    "blood_pressure": {
      "systolic": 120,
      "diastolic": 80
    },
    "temperature": 36.5
  },
  "second": { ... },
  "third": { ... }
}
```

### ロールバック方法

問題が発生した場合、以下のSQLで追加したカラムを削除できます：

```sql
ALTER TABLE triage_tags
  DROP COLUMN IF EXISTS conveyer,
  DROP COLUMN IF EXISTS execution_places,
  DROP COLUMN IF EXISTS execution_place_other,
  DROP COLUMN IF EXISTS rescue_place,
  DROP COLUMN IF EXISTS enforcement_organization,
  DROP COLUMN IF EXISTS enforcement_organization_other,
  DROP COLUMN IF EXISTS conditions,
  DROP COLUMN IF EXISTS condition_other,
  DROP COLUMN IF EXISTS vital_signs_records;

-- インデックスも削除
DROP INDEX IF EXISTS idx_triage_tags_conveyer;
DROP INDEX IF EXISTS idx_triage_tags_rescue_place;
DROP INDEX IF EXISTS idx_triage_tags_enforcement_organization;
DROP INDEX IF EXISTS idx_triage_tags_execution_places;
DROP INDEX IF EXISTS idx_triage_tags_conditions;
DROP INDEX IF EXISTS idx_triage_tags_vital_signs_records;
```

### 確認方法

マイグレーション後、以下のSQLでカラムが追加されたことを確認できます：

```sql
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'triage_tags'
  AND column_name IN (
    'conveyer',
    'execution_places',
    'execution_place_other',
    'rescue_place',
    'enforcement_organization',
    'enforcement_organization_other',
    'conditions',
    'condition_other',
    'vital_signs_records'
  )
ORDER BY column_name;
```

### 注意事項

1. **既存データへの影響**
   - 新規カラムは全て NULL 許可
   - 既存データには影響なし
   - 既存のアプリケーション動作に影響なし

2. **実行タイミング**
   - 本番環境での実行は、利用者が少ない時間帯を推奨
   - 開発環境で事前にテストすることを推奨

3. **バックアップ**
   - マイグレーション実行前にデータベースのバックアップを推奨
   - Supabaseは自動バックアップを提供

### トラブルシューティング

#### エラー: column already exists
- カラムが既に存在する場合のエラー
- `IF NOT EXISTS` が使用されているため、通常は発生しない
- 無視して問題なし

#### エラー: permission denied
- データベースへの権限が不足
- Supabaseダッシュボードの管理者権限で実行してください
