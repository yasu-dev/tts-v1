# Supabase デモデータ投入手順

## 前提条件

- Supabaseプロジェクトが作成済み
- `.env.local` に正しい環境変数が設定済み
- PostgreSQLデータベースがアクセス可能

## 投入手順

### 方法1: Supabase Dashboard (Web UI)

1. **Supabase Dashboardにログイン**
   - https://supabase.com/dashboard にアクセス
   - プロジェクトを選択

2. **SQL Editorを開く**
   - 左メニューから「SQL Editor」を選択

3. **スキーマの作成**
   - 「New Query」をクリック
   - `supabase/schema.sql` の内容を貼り付け
   - 「Run」をクリックして実行

4. **RLSポリシーの設定**
   - 「New Query」をクリック
   - `supabase/rls-policies.sql` の内容を貼り付け
   - 「Run」をクリックして実行

5. **デモデータの投入**
   - 「New Query」をクリック
   - `supabase/demo-data.sql` の内容を貼り付け
   - 「Run」をクリックして実行

6. **確認**
   - 左メニューから「Table Editor」を選択
   - 各テーブルにデータが投入されているか確認
     - `events`: 1件
     - `hospitals`: 3件
     - `triage_tags`: 7件
     - `teams`: 2件

---

### 方法2: psql コマンドライン

1. **接続情報の確認**
   ```bash
   # Supabase Dashboardの「Project Settings」→「Database」で確認
   # または .env.local から SUPABASE_URL を確認
   ```

2. **psql で接続**
   ```bash
   psql postgresql://postgres:[YOUR-PASSWORD]@db.[YOUR-PROJECT-REF].supabase.co:5432/postgres
   ```

3. **SQLファイルの実行**
   ```bash
   # スキーマ作成
   \i supabase/schema.sql

   # RLSポリシー設定
   \i supabase/rls-policies.sql

   # デモデータ投入
   \i supabase/demo-data.sql
   ```

4. **確認**
   ```sql
   -- 各テーブルの件数確認
   SELECT COUNT(*) FROM events;
   SELECT COUNT(*) FROM hospitals;
   SELECT COUNT(*) FROM triage_tags;
   SELECT COUNT(*) FROM teams;

   -- トリアージタグの内訳確認
   SELECT
     triage_category->>'final' as category,
     COUNT(*) as count
   FROM triage_tags
   GROUP BY triage_category->>'final';
   ```

---

### 方法3: Supabase CLI

1. **Supabase CLIのインストール**
   ```bash
   npm install -g supabase
   ```

2. **ログイン**
   ```bash
   supabase login
   ```

3. **プロジェクトのリンク**
   ```bash
   supabase link --project-ref [YOUR-PROJECT-REF]
   ```

4. **マイグレーション実行**
   ```bash
   supabase db push
   ```

5. **デモデータ投入**
   ```bash
   supabase db execute --file supabase/demo-data.sql
   ```

---

## デモデータの内容

### イベント（災害）
- **event-001**: 2025年 東京都内大規模地震

### 病院（3件）
1. **東京総合病院** (hospital-001)
   - 救命救急センター
   - ICU・ヘリポート有
   - 総病床数: 200、空床: 50

2. **中央市民病院** (hospital-002)
   - 救急科有
   - 総病床数: 150、空床: 30
   - 受入制限あり

3. **東都医療センター** (hospital-003)
   - 外傷科・ICU・ヘリポート有
   - 総病床数: 100、空床: 25

### トリアージタグ（7件）

| タグ番号 | 分類 | 年齢 | 性別 | 状態 | 主訴 |
|---------|------|------|------|------|------|
| T-2025-001 | 赤（重症） | 45歳 | 男性 | 搬送待ち | 胸部打撲・呼吸困難 |
| T-2025-002 | 赤（重症） | 32歳 | 女性 | 搬送中 | 頭部外傷・意識障害 |
| T-2025-003 | 黄（中等症） | 28歳 | 男性 | 搬送待ち | 左前腕骨折 |
| T-2025-004 | 黄（中等症） | 55歳 | 女性 | 搬送中 | - |
| T-2025-005 | 緑（軽症） | 22歳 | 男性 | 未搬送 | - |
| T-2025-006 | 緑（軽症） | 38歳 | 女性 | 未搬送 | - |
| T-2025-007 | 黒（死亡） | 67歳 | 男性 | 未搬送 | 呼吸停止 |

### 搬送チーム（2件）
1. **搬送第1隊** (team-trn-001)
   - 救急車: 品川 500 あ 1234
   - 搬送中患者: tag-002 → 東京総合病院

2. **搬送第2隊** (team-trn-002)
   - 救急車: 品川 500 あ 5678
   - 搬送中患者: tag-004 → 中央市民病院

---

## 動作確認

### 1. 指揮本部ダッシュボード
```
URL: http://localhost:3002/command
ログイン: ic@demo.com / password
```

確認項目:
- ✅ 統計カードに正しい件数が表示される（総数7、黒1、赤2、黄2、緑2）
- ✅ 地図上に患者の位置が表示される
- ✅ トリアージタグ一覧が表示される
- ✅ 「詳細」ボタンをクリックでモーダル表示
- ✅ リアルタイム更新が機能する

### 2. トリアージ入力画面
```
URL: http://localhost:3002/triage/scan
ログイン: tri@demo.com / password
```

確認項目:
- ✅ QRコードスキャン画面が表示される
- ✅ 手動入力で患者情報を入力できる
- ✅ START法トリアージが実施できる

### 3. 搬送管理画面
```
URL: http://localhost:3002/transport
ログイン: trn@demo.com / password
```

確認項目:
- ✅ 搬送待ち患者（赤・黄タグ）が表示される
- ✅ 搬送先病院を選択できる
- ✅ 搬送開始ボタンが機能する

### 4. 医療機関ダッシュボード
```
URL: http://localhost:3002/hospital
ログイン: hsp@demo.com / password
```

確認項目:
- ✅ 病院情報が表示される
- ✅ 搬送中患者が表示される（tag-002）
- ✅ 受入完了ボタンが機能する
- ✅ 受入状況を更新できる

---

## トラブルシューティング

### エラー: テーブルが存在しない
```
ERROR: relation "triage_tags" does not exist
```

**解決方法:**
1. スキーマファイル（schema.sql）を先に実行
2. テーブルが正しく作成されているか確認

### エラー: RLS ポリシー違反
```
ERROR: new row violates row-level security policy
```

**解決方法:**
1. RLSポリシーを一時的に無効化
   ```sql
   ALTER TABLE triage_tags DISABLE ROW LEVEL SECURITY;
   ```
2. デモデータ投入後、再度有効化
   ```sql
   ALTER TABLE triage_tags ENABLE ROW LEVEL SECURITY;
   ```

### データが表示されない

**確認項目:**
1. `.env.local` の環境変数が正しいか
2. Supabaseプロジェクトが稼働中か
3. ブラウザのコンソールでエラーが出ていないか
4. ネットワーク接続が正常か

**解決方法:**
```bash
# 開発サーバーを再起動
npm run dev

# ブラウザのキャッシュをクリア
Ctrl+Shift+Delete
```

---

## データのクリア（リセット）

デモデータを削除して最初からやり直す場合:

```sql
-- 全データ削除（開発環境のみ！）
TRUNCATE TABLE triage_tags CASCADE;
TRUNCATE TABLE events CASCADE;
TRUNCATE TABLE hospitals CASCADE;
TRUNCATE TABLE teams CASCADE;
TRUNCATE TABLE geographic_areas CASCADE;
TRUNCATE TABLE user_roles CASCADE;

-- または DROP TABLE して再作成
DROP SCHEMA public CASCADE;
CREATE SCHEMA public;
GRANT ALL ON SCHEMA public TO postgres;
GRANT ALL ON SCHEMA public TO public;
```

**注意:** 本番環境では絶対に実行しないでください！

---

## 関連ドキュメント

- [TROUBLESHOOTING.md](../TROUBLESHOOTING.md) - トラブルシューティング
- [supabase/README.md](./README.md) - Supabase セットアップガイド
- [LOGOUT_GUIDE.md](../LOGOUT_GUIDE.md) - ログアウト方法
- [docs/修正履歴.md](../docs/修正履歴.md) - 最新の修正内容

---

## 次のステップ

1. ✅ デモデータが正しく投入されたことを確認
2. ✅ 各ダッシュボードで動作確認
3. ✅ 詳細ボタンでモーダル表示を確認
4. ✅ リアルタイム更新を確認（複数ブラウザで開く）
5. 新しい患者データを登録してみる
6. 搬送フローを一通り試す
7. E2Eテストを実行する

```bash
# E2Eテスト実行
npm run test:e2e
```
