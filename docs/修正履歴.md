# 修正履歴（2025-10-18）

## 修正したエラー

### 1. ✅ Critical: HospitalDashboard.tsx:264 - departments.map() エラー

**エラー内容:**
```
Uncaught TypeError: Cannot read properties of undefined (reading 'map')
at HospitalDashboard.tsx:264
```

**原因:**
`hospital.capabilities.departments` が undefined の場合にアクセスしようとしていた

**修正:**
```typescript
// 修正前
診療科: {hospital.capabilities.departments.map(d => d.name).join(', ')}

// 修正後
診療科: {hospital.capabilities.departments?.map(d => d.name).join(', ') || '情報なし'}
```

**ファイル:** `app/(dashboard)/hospital/HospitalDashboard.tsx:264`

---

### 2. ✅ Transport データ構造の統一

**問題:**
TransportDashboard と HospitalDashboard で transport オブジェクトの構造が型定義と一致していなかった

**修正内容:**

#### TransportDashboard.tsx
```typescript
// 修正前
transport: {
  status: 'in_transit',
  hospital_id: selectedHospital,
  hospital_name: selectedHospitalData?.name,
  departed_at: new Date().toISOString(),
}

// 修正後（型定義に合わせた）
transport: {
  status: 'in_transit',
  destination: {
    hospital_id: selectedHospital,
    hospital_name: selectedHospitalData?.name || '',
    department: '',
  },
  departure_time: new Date().toISOString(),
}
```

**ファイル:** `app/(dashboard)/transport/TransportDashboard.tsx:68-82`

#### HospitalDashboard.tsx - 患者受入処理
```typescript
// 修正前
transport: {
  status: 'completed',
  hospital_id: hospital.id,
  hospital_name: hospital.name,
  arrived_at: new Date().toISOString(),
}

// 修正後
transport: {
  ...currentTag?.transport,  // 既存の transport 情報を保持
  status: 'completed',
  arrival_time: new Date().toISOString(),
}
```

**ファイル:** `app/(dashboard)/hospital/HospitalDashboard.tsx:86-106`

#### データベースクエリの修正

**hospital/page.tsx (Server Component):**
```typescript
// 修正前
.eq('transport->>hospital_id', hospital.id)

// 修正後
.eq('transport->destination->>hospital_id', hospital.id)
```

**ファイル:** `app/(dashboard)/hospital/page.tsx:35`

**HospitalDashboard.tsx (Realtime subscription):**
```typescript
// 修正前
.eq('transport->>hospital_id', hospital.id)

// 修正後
.eq('transport->destination->>hospital_id', hospital.id)
```

**ファイル:** `app/(dashboard)/hospital/HospitalDashboard.tsx:39`

---

### 3. ✅ PWA Manifest - アイコン404エラー

**エラー内容:**
```
GET http://localhost:3000/icon-192.png 404 (Not Found)
GET http://localhost:3000/icon-512.png 404 (Not Found)
```

**修正:**
存在しないアイコンファイルへの参照を manifest.json から削除

**ファイル:** `public/manifest.json:10-23`

---

## 型定義との整合性

### transport オブジェクトの正しい構造

`lib/types/index.ts` の定義に従って統一:

```typescript
transport: {
  status: 'not_transported' | 'preparing' | 'waiting' | 'in_transit' | 'arrived' | 'admitted' | 'completed'
  team_id?: string
  vehicle_id?: string
  destination?: {
    hospital_id: string
    hospital_name: string
    department: string
    eta?: string
  }
  departure_time?: string      // ← departed_at ではない
  arrival_time?: string        // ← arrived_at ではない
  transport_duration?: number
  vital_changes_during_transport?: Array<{...}>
}
```

---

## ビルド結果

### ✅ ビルド成功

```bash
npm run build
```

- コンパイル: ✓ 成功
- 型チェック: ✓ 問題なし
- 静的ページ生成: ✓ 9/9 完了

### ⚠️ 警告（機能に影響なし）

Next.js 14 の metadata API に関する警告のみ:
- `themeColor` と `viewport` を `generateViewport()` に移動することを推奨
- アプリケーションの動作には影響なし

---

## 開発サーバー

### 起動確認

```bash
npm run dev
```

- ✓ サーバー起動成功
- ✓ http://localhost:3002 でアクセス可能
- ✓ ビルドエラーなし

---

## 残りのタスク

### 推奨事項

1. **PWA アイコンの作成**
   - `public/icon-192.png` (192x192px)
   - `public/icon-512.png` (512x512px)
   - 作成後、manifest.json に icons セクションを追加

2. **Demo データの投入**
   - `supabase/demo-data.sql` を実行
   - transport オブジェクトの構造が新しい形式に対応しているか確認

3. **既存データの移行**
   もし既に旧形式の transport データが存在する場合:
   ```sql
   -- 旧形式のデータを新形式に変換するマイグレーション例
   UPDATE triage_tags
   SET transport = jsonb_set(
     jsonb_set(
       transport,
       '{destination}',
       jsonb_build_object(
         'hospital_id', transport->>'hospital_id',
         'hospital_name', transport->>'hospital_name',
         'department', ''
       )
     ),
     '{departure_time}',
     transport->'departed_at'
   )
   WHERE transport ? 'hospital_id';
   ```

4. **E2E テストの実行**
   ```bash
   npm run test:e2e
   ```

---

## 変更ファイル一覧

### 修正ファイル

1. `app/(dashboard)/hospital/HospitalDashboard.tsx`
   - Line 39: データベースクエリ修正
   - Line 90-106: 患者受入処理の修正
   - Line 264: Optional chaining 追加

2. `app/(dashboard)/hospital/page.tsx`
   - Line 35: データベースクエリ修正

3. `app/(dashboard)/transport/TransportDashboard.tsx`
   - Line 68-82: transport オブジェクト構造修正

4. `public/manifest.json`
   - Line 10-23: icons セクション削除

---

## テスト方法

### 1. ログイン

```
URL: http://localhost:3002/login
Email: hsp@demo.com
Password: password
```

### 2. 病院ダッシュボード確認

- ログイン後、自動的に `/hospital` にリダイレクト
- 診療科情報が「情報なし」と表示されることを確認（departments が未設定の場合）
- エラーが発生しないことを確認

### 3. 搬送フロー確認

1. トリアージ入力画面 (`/triage/scan`) で患者を登録
2. 搬送管理画面 (`/transport`) で搬送開始
3. 病院ダッシュボード (`/hospital`) で患者が表示されることを確認
4. 受入完了ボタンで患者受入

### 4. Realtime 確認

- 複数のブラウザウィンドウで同じダッシュボードを開く
- 一方で操作を行い、もう一方でリアルタイム更新されることを確認
- 「データ更新」バッジが表示されることを確認

---

## 関連ドキュメント

- [LOGOUT_GUIDE.md](../LOGOUT_GUIDE.md) - ログアウト方法
- [TROUBLESHOOTING.md](../TROUBLESHOOTING.md) - トラブルシューティング
- [supabase/README.md](../supabase/README.md) - Supabase セットアップ
- [現在の実装状況.md](./現在の実装状況.md) - 実装進捗

---

## 修正者

Claude Code
日時: 2025-10-18
