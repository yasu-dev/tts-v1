# ã€å®Œå…¨ä¿®æ­£ç‰ˆã€‘ãƒˆãƒªã‚¢ãƒ¼ã‚¸ã‚¿ãƒƒã‚°ã‚·ã‚¹ãƒ†ãƒ  - MVPæŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯æº–æ‹ ä»•æ§˜æ›¸

**é‡è¦ãªä¿®æ­£ç‚¹**ï¼šå‰å›æç¤ºã—ãŸMapboxã€Yjs (CRDT)ã€TensorFlow.jsã€YOLOv8ç­‰ã®å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯**ã™ã¹ã¦å‰Šé™¤**ã—ã€æŒ‡å®šã•ã‚ŒãŸMVPæŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã®ã¿ã§å®Ÿè£…å¯èƒ½ãªä»•æ§˜ã«å®Œå…¨æ›¸ãç›´ã—ã¾ã—ãŸã€‚

---

## ğŸ“‹ 1. æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ï¼ˆMVPç”¨ãƒ»ç¢ºå®šç‰ˆï¼‰

| ã‚«ãƒ†ã‚´ãƒª | æŠ€è¡“ | ç”¨é€” |
|---------|------|------|
| **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰** | Next.js 14 App Router + React 18 + TypeScript | ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ |
| **UI** | Tailwind CSS | ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° |
| **çŠ¶æ…‹ç®¡ç†** | React Server Components + useContext | ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ |
| **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰** | Next.js API Routes | APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ |
| **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹** | Supabase (PostgreSQL) | ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ– |
| **èªè¨¼** | Supabase Auth | ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ãƒ»MFA |
| **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸** | Supabase Storage | ç”»åƒãƒ»éŸ³å£°ä¿å­˜ |
| **PWA** | next-pwa + Service Worker | ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œ |
| **ãƒ†ã‚¹ãƒˆ** | Playwright + Jest | E2E + ãƒ¦ãƒ‹ãƒƒãƒˆ |
| **ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³** | Zod | ã‚¹ã‚­ãƒ¼ãƒæ¤œè¨¼ |
| **ã‚¤ãƒ³ãƒ•ãƒ©** | Supabase (è‡ªå‹•å†—é•·åŒ–) | ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚° |

**è¿½åŠ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆæœ€å°é™ï¼‰**
- `html5-qrcode`: QRèª­å–ï¼ˆã‚«ãƒ¡ãƒ©APIçµ±åˆï¼‰
- `react-leaflet`: è»½é‡åœ°å›³è¡¨ç¤º
- `date-fns`: æ—¥ä»˜å‡¦ç†

**ä½¿ç”¨ã—ãªã„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆPhase 2ä»¥é™ã«å»¶æœŸï¼‰**
- âŒ Mapbox GL JSï¼ˆé‡ã„ï¼‰
- âŒ Yjs/Automergeï¼ˆCRDTï¼‰
- âŒ TensorFlow.jsï¼ˆAIæ¨è«–ï¼‰
- âŒ YOLOv8ï¼ˆç”»åƒè§£æï¼‰

---

## ğŸ”§ 2. å®Ÿè£…è©³ç´°ï¼ˆå®Œå…¨ç‰ˆãƒ»MVPæŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯æº–æ‹ ï¼‰

### 2.1 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ 

```
triage-system/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ (auth)/
â”‚   â”‚   â”œâ”€â”€ login/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â””â”€â”€ layout.tsx
â”‚   â”œâ”€â”€ (dashboard)/
â”‚   â”‚   â”œâ”€â”€ command/              # æŒ‡æ®æœ¬éƒ¨
â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚   â”‚   â”‚   â””â”€â”€ components/
â”‚   â”‚   â”‚       â”œâ”€â”€ MapView.tsx
â”‚   â”‚   â”‚       â”œâ”€â”€ ListView.tsx
â”‚   â”‚   â”‚       â””â”€â”€ StatsPanel.tsx
â”‚   â”‚   â”œâ”€â”€ triage/               # ã‚¿ãƒƒã‚°ä»˜ã‘éƒ¨éšŠ
â”‚   â”‚   â”‚   â”œâ”€â”€ scan/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ register/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â”‚   â””â”€â”€ wizard/
â”‚   â”‚   â”‚       â””â”€â”€ page.tsx
â”‚   â”‚   â”œâ”€â”€ transport/            # æ¬é€éƒ¨éšŠ
â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚   â”‚   â”‚   â””â”€â”€ [tagId]/
â”‚   â”‚   â”‚       â””â”€â”€ page.tsx
â”‚   â”‚   â””â”€â”€ hospital/             # åŒ»ç™‚æ©Ÿé–¢
â”‚   â”‚       â””â”€â”€ page.tsx
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”‚   â””â”€â”€ [...nextauth]/
â”‚   â”‚   â”‚       â””â”€â”€ route.ts
â”‚   â”‚   â”œâ”€â”€ tags/
â”‚   â”‚   â”‚   â”œâ”€â”€ route.ts          # GET/POST
â”‚   â”‚   â”‚   â””â”€â”€ [id]/
â”‚   â”‚   â”‚       â””â”€â”€ route.ts      # GET/PUT
â”‚   â”‚   â”œâ”€â”€ sync/
â”‚   â”‚   â”‚   â””â”€â”€ route.ts          # ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åŒæœŸ
â”‚   â”‚   â””â”€â”€ export/
â”‚   â”‚       â”œâ”€â”€ pdf/
â”‚   â”‚       â”‚   â””â”€â”€ route.ts
â”‚   â”‚       â””â”€â”€ csv/
â”‚   â”‚           â””â”€â”€ route.ts
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ QRScanner.tsx
â”‚   â”‚   â”œâ”€â”€ VoiceInput.tsx
â”‚   â”‚   â”œâ”€â”€ ImageUploader.tsx
â”‚   â”‚   â”œâ”€â”€ StartWizard.tsx
â”‚   â”‚   â””â”€â”€ OfflineIndicator.tsx
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â”œâ”€â”€ page.tsx
â”‚   â””â”€â”€ globals.css
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ supabase/
â”‚   â”‚   â”œâ”€â”€ client.ts
â”‚   â”‚   â”œâ”€â”€ server.ts
â”‚   â”‚   â””â”€â”€ middleware.ts
â”‚   â”œâ”€â”€ validation/
â”‚   â”‚   â””â”€â”€ schemas.ts            # Zodã‚¹ã‚­ãƒ¼ãƒ
â”‚   â”œâ”€â”€ offline/
â”‚   â”‚   â”œâ”€â”€ indexeddb.ts
â”‚   â”‚   â””â”€â”€ sync-manager.ts
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ start-triage.ts       # STARTæ³•ãƒ­ã‚¸ãƒƒã‚¯
â”‚   â”‚   â”œâ”€â”€ image-compress.ts
â”‚   â”‚   â””â”€â”€ voice-parser.ts
â”‚   â””â”€â”€ types/
â”‚       â””â”€â”€ index.ts
â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ manifest.json
â”‚   â”œâ”€â”€ sw.js                     # Service Worker
â”‚   â””â”€â”€ icons/
â”œâ”€â”€ .env.local
â”œâ”€â”€ next.config.js
â”œâ”€â”€ tailwind.config.js
â”œâ”€â”€ tsconfig.json
â””â”€â”€ package.json
```

---

### 2.2 ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ï¼ˆSupabase PostgreSQLï¼‰

#### 2.2.1 SQLã‚¹ã‚­ãƒ¼ãƒ

```sql
-- ===== 1. ç½å®³ã‚¤ãƒ™ãƒ³ãƒˆãƒ†ãƒ¼ãƒ–ãƒ« =====
CREATE TABLE events (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  occurred_at TIMESTAMPTZ NOT NULL,
  closed_at TIMESTAMPTZ,
  location_polygon JSONB,  -- GeoJSONå½¢å¼
  command_post_location JSONB,  -- {lat, lng}
  communication_mode TEXT DEFAULT 'normal',  -- 'normal' | 'satellite' | 'mesh' | 'offline'
  status TEXT DEFAULT 'active',  -- 'preparing' | 'active' | 'closing' | 'archived'
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ===== 2. ãƒˆãƒªã‚¢ãƒ¼ã‚¸ã‚¿ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆä¸­æ ¸ï¼‰ =====
CREATE TABLE triage_tags (
  -- è­˜åˆ¥
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  event_id UUID REFERENCES events(id) ON DELETE CASCADE,
  anonymous_id TEXT NOT NULL,  -- åŒ¿åãƒãƒƒã‚·ãƒ¥
  tag_number TEXT NOT NULL,
  
  -- æ‚£è€…æƒ…å ±ï¼ˆæš—å·åŒ–ï¼‰
  patient_info JSONB,  -- {name, age, sex, address, phone}
  
  -- ä½ç½®æƒ…å ±
  location JSONB NOT NULL,  -- {latitude, longitude, altitude, accuracy, method, area_grid, timestamp}
  
  -- ç”Ÿä½“æ‰€è¦‹
  vital_signs JSONB NOT NULL,  -- {respiratory_rate, respiratory_status, pulse_rate, radial_pulse_palpable, consciousness, spo2, blood_pressure, temperature, trauma_assessment, bleeding_evaluation, measured_at}
  
  -- ãƒˆãƒªã‚¢ãƒ¼ã‚¸åŒºåˆ†
  triage_category JSONB NOT NULL,  -- {ai_suggested, ai_confidence, ai_reasoning, final, final_decided_by, final_decided_at, override_reason, start_steps}
  
  -- å†ãƒˆãƒªã‚¢ãƒ¼ã‚¸å±¥æ­´
  retriage_history JSONB DEFAULT '[]',  -- Array of {from, to, reason, changed_by, changed_at}
  
  -- æ·»ä»˜æƒ…å ±
  attachments JSONB DEFAULT '{"images":[],"audio_notes":[],"drone_images":[]}',
  
  -- å‡¦ç½®è¨˜éŒ²
  treatments JSONB DEFAULT '[]',  -- Array of {type, description, performed_by, performed_at}
  
  -- æ¬é€æƒ…å ±
  transport JSONB DEFAULT '{"status":"not_transported"}',  -- {status, team_id, vehicle_id, destination, departure_time, arrival_time, transport_duration, vital_changes}
  
  -- è»¢å¸°æƒ…å ±
  outcome JSONB,  -- {diagnosis, treatments_performed, admission_ward, discharge_date, final_outcome}
  
  -- ç›£æŸ»æƒ…å ±
  audit JSONB NOT NULL,  -- {created_by, created_at, created_device_id, updated_by, updated_at, updated_device_id, version, revision_history}
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  UNIQUE(event_id, tag_number)
);

-- ä½ç½®æƒ…å ±ç”¨GiSTã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆé«˜é€Ÿæ¤œç´¢ï¼‰
CREATE INDEX idx_triage_tags_location ON triage_tags USING GIST ((location->>'latitude')::float8, (location->>'longitude')::float8);

-- ãƒˆãƒªã‚¢ãƒ¼ã‚¸åŒºåˆ†ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_triage_tags_category ON triage_tags ((triage_category->>'final'));

-- æ¬é€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_triage_tags_transport_status ON triage_tags ((transport->>'status'));

-- ===== 3. åœ°ç†ã‚¨ãƒªã‚¢ãƒ†ãƒ¼ãƒ–ãƒ« =====
CREATE TABLE geographic_areas (
  id TEXT PRIMARY KEY,  -- "A1", "B2", etc.
  event_id UUID REFERENCES events(id) ON DELETE CASCADE,
  bounds JSONB NOT NULL,  -- {north, south, east, west}
  priority_score INTEGER DEFAULT 0,  -- 0-100
  estimated_casualty_count INTEGER DEFAULT 0,
  severity_distribution JSONB DEFAULT '{"red":0,"yellow":0,"green":0,"black":0}',
  drone_analysis JSONB,  -- {image_url, analyzed_at, detected_persons, heatmap_url}
  assigned_team_ids TEXT[] DEFAULT '{}',
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ===== 4. åŒ»ç™‚æ©Ÿé–¢ãƒã‚¹ã‚¿ =====
CREATE TABLE hospitals (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  location JSONB NOT NULL,  -- {address, latitude, longitude}
  contact JSONB NOT NULL,  -- {phone, emergency_phone, email}
  capabilities JSONB NOT NULL,  -- {departments, has_er, has_icu, has_heliport}
  current_load JSONB DEFAULT '{"total_capacity":0,"current_patients":0,"accepting_status":"accepting","last_updated":""}',
  transport_count INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ===== 5. éšŠ/è»Šä¸¡ãƒ†ãƒ¼ãƒ–ãƒ« =====
CREATE TABLE teams (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  event_id UUID REFERENCES events(id) ON DELETE CASCADE,
  type TEXT NOT NULL,  -- 'triage' | 'transport' | 'dmat' | 'fire' | 'police'
  name TEXT NOT NULL,
  members JSONB DEFAULT '[]',  -- Array of {user_id, role}
  current_location JSONB,  -- {latitude, longitude, accuracy, updated_at}
  status TEXT DEFAULT 'standby',  -- 'standby' | 'moving' | 'active' | 'resting' | 'out_of_service'
  assigned_area_ids TEXT[] DEFAULT '{}',
  assigned_casualty_ids UUID[] DEFAULT '{}',
  vehicle JSONB,  -- {id, type, license_plate}
  activity_log JSONB DEFAULT '[]',  -- Array of {action, location, timestamp}
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ===== 6. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ãƒ¼ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ« =====
CREATE TABLE user_roles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  event_id UUID REFERENCES events(id) ON DELETE CASCADE,
  role TEXT NOT NULL,  -- 'IC' | 'TRI' | 'TRN' | 'HSP' | 'DMAT' | 'AUD' | 'ADM'
  assigned_area_ids TEXT[] DEFAULT '{}',  -- ABAC: ã‚¨ãƒªã‚¢åˆ¶é™
  created_at TIMESTAMPTZ DEFAULT NOW(),
  
  UNIQUE(user_id, event_id)
);

-- ===== 7. ç›£æŸ»ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆWORMï¼‰ =====
CREATE TABLE audit_logs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  sequence_number BIGSERIAL,
  previous_hash TEXT,
  current_hash TEXT NOT NULL,
  
  event_type TEXT NOT NULL,
  user_id UUID REFERENCES auth.users(id),
  resource_type TEXT,
  resource_id TEXT,
  action TEXT NOT NULL,
  changes JSONB,
  
  ip_address INET,
  user_agent TEXT,
  device_id TEXT,
  
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- æŒ¿å…¥å°‚ç”¨ãƒãƒªã‚·ãƒ¼ï¼ˆå‰Šé™¤ãƒ»æ›´æ–°ç¦æ­¢ï¼‰
CREATE POLICY "Audit logs are append-only" ON audit_logs FOR DELETE USING (false);
CREATE POLICY "Audit logs cannot be updated" ON audit_logs FOR UPDATE USING (false);

-- ===== 8. ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åŒæœŸç”¨çŠ¶æ…‹ãƒ†ãƒ¼ãƒ–ãƒ« =====
CREATE TABLE sync_state (
  device_id TEXT PRIMARY KEY,
  event_id UUID REFERENCES events(id),
  last_synced_at TIMESTAMPTZ DEFAULT NOW(),
  pending_changes JSONB DEFAULT '[]',  -- Array of {tag_id, operation, data, timestamp}
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ===== 9. RLSï¼ˆRow Level Securityï¼‰ãƒãƒªã‚·ãƒ¼ =====

-- æŒ‡æ®æœ¬éƒ¨(IC)ã¯å…¨ãƒ‡ãƒ¼ã‚¿é–²è¦§å¯èƒ½
CREATE POLICY "IC can view all triage tags"
  ON triage_tags FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM user_roles
      WHERE user_id = auth.uid()
        AND event_id = triage_tags.event_id
        AND role = 'IC'
    )
  );

-- ã‚¿ãƒƒã‚°ä»˜ã‘éƒ¨éšŠ(TRI)ã¯è‡ªåˆ†ãŒä½œæˆã—ãŸã‚¿ã‚°ã®ã¿ç·¨é›†å¯èƒ½
CREATE POLICY "TRI can update own tags"
  ON triage_tags FOR UPDATE
  USING (
    EXISTS (
      SELECT 1 FROM user_roles
      WHERE user_id = auth.uid()
        AND event_id = triage_tags.event_id
        AND role = 'TRI'
    )
    AND (audit->>'created_by')::UUID = auth.uid()
  );

-- æ¬é€éƒ¨éšŠ(TRN)ã¯å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸã‚¿ã‚°ã®ã¿é–²è¦§ãƒ»æ›´æ–°å¯èƒ½
CREATE POLICY "TRN can view assigned tags"
  ON triage_tags FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM user_roles ur
      JOIN teams t ON t.event_id = ur.event_id
      WHERE ur.user_id = auth.uid()
        AND ur.event_id = triage_tags.event_id
        AND ur.role = 'TRN'
        AND triage_tags.id = ANY(t.assigned_casualty_ids)
    )
  );

-- åŒ»ç™‚æ©Ÿé–¢(HSP)ã¯è‡ªé™¢ã«æ¬é€äºˆå®šã®ã‚¿ã‚°ã®ã¿é–²è¦§å¯èƒ½
CREATE POLICY "HSP can view incoming tags"
  ON triage_tags FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM user_roles ur
      JOIN hospitals h ON h.id::TEXT = ur.assigned_area_ids[1]  -- hospital_idã‚’area_idsã«æ ¼ç´
      WHERE ur.user_id = auth.uid()
        AND ur.event_id = triage_tags.event_id
        AND ur.role = 'HSP'
        AND (transport->>'destination')::JSONB->>'hospital_id' = h.id::TEXT
    )
  );

-- RLSæœ‰åŠ¹åŒ–
ALTER TABLE triage_tags ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_roles ENABLE ROW LEVEL SECURITY;
ALTER TABLE teams ENABLE ROW LEVEL SECURITY;

-- ===== 10. ãƒˆãƒªã‚¬ãƒ¼ï¼ˆæ›´æ–°æ™‚åˆ»è‡ªå‹•æ›´æ–°ï¼‰ =====
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_triage_tags_updated_at
  BEFORE UPDATE ON triage_tags
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_events_updated_at
  BEFORE UPDATE ON events
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();
```

---

### 2.3 TypeScriptå‹å®šç¾©ï¼ˆå®Œå…¨ç‰ˆï¼‰

```typescript
// lib/types/index.ts

// ===== ç½å®³ã‚¤ãƒ™ãƒ³ãƒˆ =====
export interface Event {
  id: string
  name: string
  occurred_at: string
  closed_at: string | null
  location_polygon: GeoJSON.Polygon | null
  command_post_location: {
    lat: number
    lng: number
  } | null
  communication_mode: 'normal' | 'satellite' | 'mesh' | 'offline'
  status: 'preparing' | 'active' | 'closing' | 'archived'
  created_by: string
  created_at: string
  updated_at: string
}

// ===== ãƒˆãƒªã‚¢ãƒ¼ã‚¸ã‚¿ã‚° =====
export interface TriageTag {
  id: string
  event_id: string
  anonymous_id: string
  tag_number: string
  
  patient_info?: {
    name?: string
    age?: number
    sex?: 'male' | 'female' | 'other' | 'unknown'
    address?: string
    phone?: string
  }
  
  location: {
    latitude: number
    longitude: number
    altitude?: number
    accuracy: number
    method: 'gps' | 'wifi' | 'manual' | 'estimated'
    area_grid?: string
    timestamp: string
  }
  
  vital_signs: {
    respiratory_rate?: number
    respiratory_status: 'normal' | 'abnormal' | 'stopped'
    pulse_rate?: number
    radial_pulse_palpable: boolean
    crt?: number
    consciousness: {
      avpu: 'alert' | 'voice' | 'pain' | 'unresponsive'
      jcs?: number
      gcs?: {
        eye: number
        verbal: number
        motor: number
      }
    }
    spo2?: number
    blood_pressure?: {
      systolic: number
      diastolic: number
    }
    temperature?: number
    trauma_assessment?: string
    bleeding_evaluation?: 'none' | 'minor' | 'moderate' | 'severe'
    measured_at: string
  }
  
  triage_category: {
    ai_suggested: 'black' | 'red' | 'yellow' | 'green'
    ai_confidence: number
    ai_reasoning: string
    final: 'black' | 'red' | 'yellow' | 'green'
    final_decided_by: string
    final_decided_at: string
    override_reason?: string
    start_steps: {
      can_walk: boolean | null
      has_respiration: boolean | null
      respiratory_rate_range: '0' | '<10' | '10-29' | '>=30' | null
      radial_pulse: boolean | null
      follows_commands: boolean | null
    }
  }
  
  retriage_history: Array<{
    from: 'black' | 'red' | 'yellow' | 'green'
    to: 'black' | 'red' | 'yellow' | 'green'
    reason: string
    changed_by: string
    changed_at: string
  }>
  
  attachments: {
    images: Array<{
      id: string
      url: string
      type: 'wound' | 'scene' | 'body_diagram' | 'other'
      compressed_size: number
      thumbnail_url?: string
      taken_at: string
      location?: { lat: number; lng: number }
    }>
    audio_notes: Array<{
      id: string
      url: string
      transcription: string
      duration: number
      recorded_at: string
    }>
    drone_images?: Array<{
      id: string
      url: string
      analysis_result?: {
        detected_posture: 'lying' | 'sitting' | 'standing'
        bounding_box: { x: number; y: number; width: number; height: number }
      }
    }>
  }
  
  treatments: Array<{
    type: 'hemostasis' | 'airway' | 'fixation' | 'oxygen' | 'other'
    description: string
    performed_by: string
    performed_at: string
  }>
  
  transport: {
    status: 'not_transported' | 'waiting' | 'in_transit' | 'arrived' | 'admitted'
    team_id?: string
    vehicle_id?: string
    destination?: {
      hospital_id: string
      hospital_name: string
      department: string
      eta?: string
    }
    departure_time?: string
    arrival_time?: string
    transport_duration?: number
    vital_changes_during_transport?: Array<{
      vital_signs: TriageTag['vital_signs']
      timestamp: string
    }>
  }
  
  outcome?: {
    diagnosis: string
    treatments_performed: string[]
    admission_ward?: string
    discharge_date?: string
    final_outcome: 'recovered' | 'admitted' | 'transferred' | 'deceased'
  }
  
  audit: {
    created_by: string
    created_at: string
    created_device_id: string
    updated_by: string
    updated_at: string
    updated_device_id: string
    version: number
    revision_history: Array<{
      version: number
      diff: object
      changed_by: string
      changed_at: string
      change_reason?: string
    }>
  }
  
  created_at: string
  updated_at: string
}

// ===== åœ°ç†ã‚¨ãƒªã‚¢ =====
export interface GeographicArea {
  id: string
  event_id: string
  bounds: {
    north: number
    south: number
    east: number
    west: number
  }
  priority_score: number
  estimated_casualty_count: number
  severity_distribution: {
    red: number
    yellow: number
    green: number
    black: number
  }
  drone_analysis?: {
    image_url: string
    analyzed_at: string
    detected_persons: number
    heatmap_url?: string
  }
  assigned_team_ids: string[]
  updated_at: string
}

// ===== åŒ»ç™‚æ©Ÿé–¢ =====
export interface Hospital {
  id: string
  name: string
  location: {
    address: string
    latitude: number
    longitude: number
  }
  contact: {
    phone: string
    emergency_phone?: string
    email?: string
  }
  capabilities: {
    departments: Array<{
      name: string
      available_beds: number
      occupied_beds: number
      specialties: string[]
    }>
    has_er: boolean
    has_icu: boolean
    has_heliport: boolean
  }
  current_load: {
    total_capacity: number
    current_patients: number
    accepting_status: 'accepting' | 'limited' | 'full'
    last_updated: string
  }
  transport_count: number
  created_at: string
  updated_at: string
}

// ===== éšŠ/è»Šä¸¡ =====
export interface Team {
  id: string
  event_id: string
  type: 'triage' | 'transport' | 'dmat' | 'fire' | 'police'
  name: string
  members: Array<{
    user_id: string
    role: 'leader' | 'member'
  }>
  current_location?: {
    latitude: number
    longitude: number
    accuracy: number
    updated_at: string
  }
  status: 'standby' | 'moving' | 'active' | 'resting' | 'out_of_service'
  assigned_area_ids: string[]
  assigned_casualty_ids: string[]
  vehicle?: {
    id: string
    type: 'ambulance' | 'fire_truck' | 'command_vehicle'
    license_plate: string
  }
  activity_log: Array<{
    action: 'arrived' | 'started_triage' | 'completed_triage' | 'departed'
    location?: { lat: number; lng: number }
    timestamp: string
  }>
  created_at: string
  updated_at: string
}

// ===== ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ãƒ¼ãƒ« =====
export interface UserRole {
  id: string
  user_id: string
  event_id: string
  role: 'IC' | 'TRI' | 'TRN' | 'HSP' | 'DMAT' | 'AUD' | 'ADM'
  assigned_area_ids: string[]
  created_at: string
}
```

---

### 2.4 Zodãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚­ãƒ¼ãƒ

```typescript
// lib/validation/schemas.ts
import { z } from 'zod'

// ===== ãƒˆãƒªã‚¢ãƒ¼ã‚¸ã‚¿ã‚°ç™»éŒ²ã‚¹ã‚­ãƒ¼ãƒ =====
export const createTriageTagSchema = z.object({
  event_id: z.string().uuid(),
  tag_number: z.string().min(1).max(50),
  
  location: z.object({
    latitude: z.number().min(-90).max(90),
    longitude: z.number().min(-180).max(180),
    altitude: z.number().optional(),
    accuracy: z.number().min(0),
    method: z.enum(['gps', 'wifi', 'manual', 'estimated']),
    area_grid: z.string().optional(),
    timestamp: z.string().datetime()
  }),
  
  vital_signs: z.object({
    respiratory_rate: z.number().min(0).max(200).optional(),
    respiratory_status: z.enum(['normal', 'abnormal', 'stopped']),
    pulse_rate: z.number().min(0).max(300).optional(),
    radial_pulse_palpable: z.boolean(),
    consciousness: z.object({
      avpu: z.enum(['alert', 'voice', 'pain', 'unresponsive']),
      jcs: z.number().min(0).max(300).optional(),
      gcs: z.object({
        eye: z.number().min(1).max(4),
        verbal: z.number().min(1).max(5),
        motor: z.number().min(1).max(6)
      }).optional()
    }),
    spo2: z.number().min(0).max(100).optional(),
    blood_pressure: z.object({
      systolic: z.number().min(0).max(300),
      diastolic: z.number().min(0).max(200)
    }).optional(),
    temperature: z.number().min(30).max(45).optional(),
    trauma_assessment: z.string().optional(),
    bleeding_evaluation: z.enum(['none', 'minor', 'moderate', 'severe']).optional(),
    measured_at: z.string().datetime()
  }),
  
  triage_category: z.object({
    final: z.enum(['black', 'red', 'yellow', 'green']),
    start_steps: z.object({
      can_walk: z.boolean().nullable(),
      has_respiration: z.boolean().nullable(),
      respiratory_rate_range: z.enum(['0', '<10', '10-29', '>=30']).nullable(),
      radial_pulse: z.boolean().nullable(),
      follows_commands: z.boolean().nullable()
    })
  })
})

// ===== ãƒˆãƒªã‚¢ãƒ¼ã‚¸ã‚¿ã‚°æ›´æ–°ã‚¹ã‚­ãƒ¼ãƒ =====
export const updateTriageTagSchema = z.object({
  vital_signs: z.object({
    respiratory_rate: z.number().min(0).max(200).optional(),
    pulse_rate: z.number().min(0).max(300).optional(),
    spo2: z.number().min(0).max(100).optional()
  }).optional(),
  
  triage_category: z.object({
    final: z.enum(['black', 'red', 'yellow', 'green']),
    override_reason: z.string().min(1)
  }).optional(),
  
  transport: z.object({
    status: z.enum(['not_transported', 'waiting', 'in_transit', 'arrived', 'admitted']),
    team_id: z.string().uuid().optional(),
    vehicle_id: z.string().optional(),
    destination: z.object({
      hospital_id: z.string().uuid(),
      hospital_name: z.string(),
      department: z.string()
    }).optional()
  }).optional()
})

// ===== åŒ»ç™‚æ©Ÿé–¢å—å…¥æ›´æ–°ã‚¹ã‚­ãƒ¼ãƒ =====
export const updateHospitalLoadSchema = z.object({
  hospital_id: z.string().uuid(),
  current_patients: z.number().min(0),
  accepting_status: z.enum(['accepting', 'limited', 'full'])
})
```

---

### 2.5 Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®š

```typescript
// lib/supabase/client.ts
import { createBrowserClient } from '@supabase/ssr'
import { Database } from './database.types'

export const createClient = () =>
  createBrowserClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
```

```typescript
// lib/supabase/server.ts
import { createServerClient, type CookieOptions } from '@supabase/ssr'
import { cookies } from 'next/headers'
import { Database } from './database.types'

export const createClient = () => {
  const cookieStore = cookies()

  return createServerClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return cookieStore.get(name)?.value
        },
        set(name: string, value: string, options: CookieOptions) {
          try {
            cookieStore.set({ name, value, ...options })
          } catch (error) {
            // Server Componentå†…ã§ã¯ç„¡è¦–
          }
        },
        remove(name: string, options: CookieOptions) {
          try {
            cookieStore.set({ name, value: '', ...options })
          } catch (error) {
            // Server Componentå†…ã§ã¯ç„¡è¦–
          }
        }
      }
    }
  )
}
```

```typescript
// lib/supabase/middleware.ts
import { createServerClient, type CookieOptions } from '@supabase/ssr'
import { NextResponse, type NextRequest } from 'next/server'

export async function updateSession(request: NextRequest) {
  let response = NextResponse.next({
    request: {
      headers: request.headers
    }
  })

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return request.cookies.get(name)?.value
        },
        set(name: string, value: string, options: CookieOptions) {
          request.cookies.set({
            name,
            value,
            ...options
          })
          response = NextResponse.next({
            request: {
              headers: request.headers
            }
          })
          response.cookies.set({
            name,
            value,
            ...options
          })
        },
        remove(name: string, options: CookieOptions) {
          request.cookies.set({
            name,
            value: '',
            ...options
          })
          response = NextResponse.next({
            request: {
              headers: request.headers
            }
          })
          response.cookies.set({
            name,
            value: '',
            ...options
          })
        }
      }
    }
  )

  await supabase.auth.getUser()

  return response
}
```

```typescript
// middleware.ts
import { type NextRequest } from 'next/server'
import { updateSession } from '@/lib/supabase/middleware'

export async function middleware(request: NextRequest) {
  return await updateSession(request)
}

export const config = {
  matcher: [
    '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)'
  ]
}
```

---

### 2.6 èªè¨¼æ©Ÿèƒ½

#### 2.6.1 ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸

```typescript
// app/(auth)/login/page.tsx
'use client'

import { useState } from 'react'
import { createClient } from '@/lib/supabase/client'
import { useRouter } from 'next/navigation'

export default function LoginPage() {
  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const router = useRouter()
  const supabase = createClient()

  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault()
    setLoading(true)
    setError(null)

    try {
      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password
      })

      if (error) throw error

      router.push('/dashboard')
      router.refresh()
    } catch (err: any) {
      setError(err.message)
    } finally {
      setLoading(false)
    }
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-100">
      <div className="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
        <h1 className="text-2xl font-bold mb-6 text-center">
          ãƒˆãƒªã‚¢ãƒ¼ã‚¸ã‚¿ãƒƒã‚°ã‚·ã‚¹ãƒ†ãƒ 
        </h1>

        <form onSubmit={handleLogin} className="space-y-4">
          <div>
            <label htmlFor="email" className="block text-sm font-medium mb-1">
              ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
            </label>
            <input
              id="email"
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              required
              className="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          <div>
            <label htmlFor="password" className="block text-sm font-medium mb-1">
              ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
            </label>
            <input
              id="password"
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              required
              className="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          {error && (
            <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm">
              {error}
            </div>
          )}

          <button
            type="submit"
            disabled={loading}
            className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {loading ? 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...' : 'ãƒ­ã‚°ã‚¤ãƒ³'}
          </button>
        </form>
      </div>
    </div>
  )
}
```

---

### 2.7 QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼å®Ÿè£…

```typescript
// app/components/QRScanner.tsx
'use client'

import { useEffect, useRef, useState } from 'react'
import { Html5QrcodeScanner } from 'html5-qrcode'

interface QRScannerProps {
  onScan: (tagId: string) => void
  onError?: (error: string) => void
}

export function QRScanner({ onScan, onError }: QRScannerProps) {
  const scannerRef = useRef<Html5QrcodeScanner>()
  const [isScanning, setIsScanning] = useState(false)

  useEffect(() => {
    if (!isScanning) return

    scannerRef.current = new Html5QrcodeScanner(
      'qr-reader',
      {
        fps: 10,
        qrbox: { width: 250, height: 250 },
        aspectRatio: 1.0,
        showTorchButtonIfSupported: true
      },
      false
    )

    scannerRef.current.render(
      (decodedText) => {
        try {
          // QRãƒ‡ãƒ¼ã‚¿å½¢å¼: "TRIAGE:EVENT_ID:TAG_ID:CHECKSUM"
          const parts = decodedText.split(':')
          if (parts[0] !== 'TRIAGE' || parts.length !== 4) {
            throw new Error('ç„¡åŠ¹ãªQRã‚³ãƒ¼ãƒ‰å½¢å¼ã§ã™')
          }

          // ãƒã‚§ãƒƒã‚¯ã‚µãƒ æ¤œè¨¼ï¼ˆç°¡æ˜“ç‰ˆ: æ–‡å­—åˆ—é•·ã®åˆè¨ˆï¼‰
          const expectedChecksum = (parts[1].length + parts[2].length).toString()
          if (parts[3] !== expectedChecksum) {
            throw new Error('QRã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚µãƒ ãŒä¸€è‡´ã—ã¾ã›ã‚“')
          }

          onScan(parts[2]) // TAG_ID
          scannerRef.current?.clear()
          setIsScanning(false)
        } catch (err: any) {
          onError?.(err.message)
        }
      },
      (error) => {
        // ã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼ˆç¶™ç¶šã‚¹ã‚­ãƒ£ãƒ³ï¼‰
      }
    )

    return () => {
      scannerRef.current?.clear()
    }
  }, [isScanning, onScan, onError])

  return (
    <div className="space-y-4">
      {!isScanning ? (
        <button
          onClick={() => setIsScanning(true)}
          className="w-full bg-blue-600 text-white py-6 rounded-lg text-xl font-bold hover:bg-blue-700"
        >
          ğŸ“· QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³
        </button>
      ) : (
        <div className="space-y-4">
          <div id="qr-reader" className="border-4 border-blue-500 rounded-lg overflow-hidden" />
          <button
            onClick={() => {
              scannerRef.current?.clear()
              setIsScanning(false)
            }}
            className="w-full bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400"
          >
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
        </div>
      )}
    </div>
  )
}
```

---

### 2.8 STARTæ³•ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰å®Ÿè£…

```typescript
// app/components/StartWizard.tsx
'use client'

import { useState } from 'react'
import { TriageTag } from '@/lib/types'

interface StartWizardProps {
  onComplete: (result: {
    category: 'black' | 'red' | 'yellow' | 'green'
    steps: TriageTag['triage_category']['start_steps']
    reasoning: string
  }) => void
}

export function StartWizard({ onComplete }: StartWizardProps) {
  const [step, setStep] = useState(1)
  const [answers, setAnswers] = useState<TriageTag['triage_category']['start_steps']>({
    can_walk: null,
    has_respiration: null,
    respiratory_rate_range: null,
    radial_pulse: null,
    follows_commands: null
  })

  const handleAnswer = (key: keyof typeof answers, value: any) => {
    const newAnswers = { ...answers, [key]: value }
    setAnswers(newAnswers)

    // STARTæ³•åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
    if (key === 'can_walk' && value === true) {
      onComplete({ category: 'green', steps: newAnswers, reasoning: 'æ­©è¡Œå¯èƒ½ã®ãŸã‚ç·‘åŒºåˆ†' })
      return
    }

    if (key === 'has_respiration' && value === false) {
      onComplete({ category: 'black', steps: newAnswers, reasoning: 'å‘¼å¸åœæ­¢ã®ãŸã‚é»’åŒºåˆ†' })
      return
    }

    if (key === 'respiratory_rate_range') {
      if (value === '0' || value === '<10' || value === '>=30') {
        onComplete({ category: 'red', steps: newAnswers, reasoning: `å‘¼å¸æ•°ç•°å¸¸ï¼ˆ${value}ï¼‰ã®ãŸã‚èµ¤åŒºåˆ†` })
        return
      }
      setStep(4)
      return
    }

    if (key === 'radial_pulse' && value === false) {
      onComplete({ category: 'red', steps: newAnswers, reasoning: 'æ©ˆéª¨å‹•è„ˆè§¦çŸ¥ä¸å¯ã®ãŸã‚èµ¤åŒºåˆ†' })
      return
    }

    if (key === 'follows_commands') {
      if (value === false) {
        onComplete({ category: 'red', steps: newAnswers, reasoning: 'æ„è­˜ãƒ¬ãƒ™ãƒ«ä½ä¸‹ã®ãŸã‚èµ¤åŒºåˆ†' })
      } else {
        onComplete({ category: 'yellow', steps: newAnswers, reasoning: 'ãƒã‚¤ã‚¿ãƒ«å®‰å®šã€å‡¦ç½®é…å»¶å¯èƒ½ã®ãŸã‚é»„åŒºåˆ†' })
      }
      return
    }

    setStep(step + 1)
  }

  return (
    <div className="bg-white rounded-lg shadow-lg p-6 max-w-md mx-auto">
      {/* ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */}
      <div className="flex justify-between mb-6">
        {[1, 2, 3, 4, 5].map((s) => (
          <div
            key={s}
            className={`w-10 h-10 rounded-full flex items-center justify-center font-bold ${
              s === step ? 'bg-blue-600 text-white' : s < step ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-400'
            }`}
          >
            {s}
          </div>
        ))}
      </div>

      {/* ã‚¹ãƒ†ãƒƒãƒ—1: æ­©è¡Œå¯å¦ */}
      {step === 1 && (
        <div>
          <h2 className="text-2xl font-bold mb-6">æ­©è¡Œã§ãã¾ã™ã‹ï¼Ÿ</h2>
          <div className="flex gap-4">
            <button
              onClick={() => handleAnswer('can_walk', true)}
              className="flex-1 bg-green-500 text-white py-12 rounded-lg text-2xl font-bold hover:bg-green-600 active:bg-green-700"
            >
              ã¯ã„
            </button>
            <button
              onClick={() => handleAnswer('can_walk', false)}
              className="flex-1 bg-red-500 text-white py-12 rounded-lg text-2xl font-bold hover:bg-red-600 active:bg-red-700"
            >
              ã„ã„ãˆ
            </button>
          </div>
        </div>
      )}

      {/* ã‚¹ãƒ†ãƒƒãƒ—2: å‘¼å¸ç¢ºèª */}
      {step === 2 && (
        <div>
          <h2 className="text-2xl font-bold mb-6">å‘¼å¸ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ</h2>
          <div className="flex gap-4">
            <button
              onClick={() => handleAnswer('has_respiration', true)}
              className="flex-1 bg-green-500 text-white py-12 rounded-lg text-2xl font-bold hover:bg-green-600"
            >
              ã‚ã‚Š
            </button>
            <button
              onClick={() => handleAnswer('has_respiration', false)}
              className="flex-1 bg-black text-white py-12 rounded-lg text-2xl font-bold hover:bg-gray-800"
            >
              ãªã—
            </button>
          </div>
        </div>
      )}

      {/* ã‚¹ãƒ†ãƒƒãƒ—3: å‘¼å¸æ•° */}
      {step === 3 && (
        <div>
          <h2 className="text-2xl font-bold mb-6">å‘¼å¸æ•°ã®ç¯„å›²ã¯ï¼Ÿ</h2>
          <div className="grid grid-cols-2 gap-4">
            <button
              onClick={() => handleAnswer('respiratory_rate_range', '<10')}
              className="bg-red-500 text-white py-8 rounded-lg text-xl font-bold hover:bg-red-600"
            >
              10å›/åˆ†æœªæº€
            </button>
            <button
              onClick={() => handleAnswer('respiratory_rate_range', '10-29')}
              className="bg-green-500 text-white py-8 rounded-lg text-xl font-bold hover:bg-green-600"
            >
              10ã€œ29å›/åˆ†
            </button>
            <button
              onClick={() => handleAnswer('respiratory_rate_range', '>=30')}
              className="bg-red-500 text-white py-8 rounded-lg text-xl font-bold hover:bg-red-600"
            >
              30å›/åˆ†ä»¥ä¸Š
            </button>
            <button
              onClick={() => handleAnswer('respiratory_rate_range', '0')}
              className="bg-black text-white py-8 rounded-lg text-xl font-bold hover:bg-gray-800"
            >
              ç„¡å‘¼å¸
            </button>
          </div>
        </div>
      )}

      {/* ã‚¹ãƒ†ãƒƒãƒ—4: æ©ˆéª¨å‹•è„ˆ */}
      {step === 4 && (
        <div>
          <h2 className="text-2xl font-bold mb-6">æ©ˆéª¨å‹•è„ˆã¯è§¦çŸ¥ã§ãã¾ã™ã‹ï¼Ÿ</h2>
          <div className="flex gap-4">
            <button
              onClick={() => handleAnswer('radial_pulse', true)}
              className="flex-1 bg-green-500 text-white py-12 rounded-lg text-2xl font-bold hover:bg-green-600"
            >
              è§¦çŸ¥å¯èƒ½
            </button>
            <button
              onClick={() => handleAnswer('radial_pulse', false)}
              className="flex-1 bg-red-500 text-white py-12 rounded-lg text-2xl font-bold hover:bg-red-600"
            >
              è§¦çŸ¥ä¸å¯
            </button>
          </div>
        </div>
      )}

      {/* ã‚¹ãƒ†ãƒƒãƒ—5: æ„è­˜ãƒ¬ãƒ™ãƒ« */}
      {step === 5 && (
        <div>
          <h2 className="text-2xl font-bold mb-6">ç°¡å˜ãªæŒ‡ç¤ºã«å¾“ãˆã¾ã™ã‹ï¼Ÿ</h2>
          <div className="flex gap-4">
            <button
              onClick={() => handleAnswer('follows_commands', true)}
              className="flex-1 bg-yellow-500 text-white py-12 rounded-lg text-2xl font-bold hover:bg-yellow-600"
            >
              å¾“ãˆã‚‹
            </button>
            <button
              onClick={() => handleAnswer('follows_commands', false)}
              className="flex-1 bg-red-500 text-white py-12 rounded-lg text-2xl font-bold hover:bg-red-600"
            >
              å¾“ãˆãªã„
            </button>
          </div>
        </div>
      )}
    </div>
  )
}
```

---

### 2.9 éŸ³å£°å…¥åŠ›ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```typescript
// app/components/VoiceInput.tsx
'use client'

import { useState, useRef } from 'react'

interface VoiceInputProps {
  onTranscript: (text: string) => void
}

export function VoiceInput({ onTranscript }: VoiceInputProps) {
  const [isRecording, setIsRecording] = useState(false)
  const [transcript, setTranscript] = useState('')
  const recognitionRef = useRef<any>(null)

  const startRecording = () => {
    if (!('webkitSpeechRecognition' in window)) {
      alert('éŸ³å£°èªè­˜ã¯æœªå¯¾å¿œã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã™')
      return
    }

    const SpeechRecognition = (window as any).webkitSpeechRecognition
    recognitionRef.current = new SpeechRecognition()

    recognitionRef.current.lang = 'ja-JP'
    recognitionRef.current.continuous = true
    recognitionRef.current.interimResults = true

    recognitionRef.current.onresult = (event: any) => {
      let interimTranscript = ''
      let finalTranscript = ''

      for (let i = event.resultIndex; i < event.results.length; i++) {
        const transcript = event.results[i][0].transcript
        if (event.results[i].isFinal) {
          finalTranscript += transcript
        } else {
          interimTranscript += transcript
        }
      }

      setTranscript(finalTranscript + interimTranscript)
    }

    recognitionRef.current.onerror = (event: any) => {
      console.error('Speech recognition error:', event.error)
      setIsRecording(false)
    }

    recognitionRef.current.start()
    setIsRecording(true)
  }

  const stopRecording = () => {
    if (recognitionRef.current) {
      recognitionRef.current.stop()
      setIsRecording(false)
    }
  }

  const handleConfirm = () => {
    onTranscript(transcript)
    setTranscript('')
  }

  return (
    <div className="bg-gray-100 rounded-lg p-4">
      <button
        onMouseDown={startRecording}
        onMouseUp={stopRecording}
        onTouchStart={startRecording}
        onTouchEnd={stopRecording}
        className={`w-full py-8 rounded-lg text-xl font-bold transition-all ${
          isRecording
            ? 'bg-red-500 text-white animate-pulse scale-105'
            : 'bg-blue-500 text-white hover:bg-blue-600'
        }`}
      >
        {isRecording ? 'ğŸ¤ éŒ²éŸ³ä¸­... (é›¢ã™ã¨åœæ­¢)' : 'ğŸ¤ é•·æŠ¼ã—ã—ã¦è©±ã™'}
      </button>

      {transcript && (
        <div className="mt-4 bg-white p-4 rounded-lg">
          <p className="text-sm text-gray-500 mb-2">éŸ³å£°èªè­˜çµæœ:</p>
          <p className="text-lg mb-4">{transcript}</p>

          <div className="flex gap-2">
            <button
              onClick={handleConfirm}
              className="flex-1 bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600"
            >
              ç¢ºå®š
            </button>
            <button
              onClick={() => setTranscript('')}
              className="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400"
            >
              ã‚¯ãƒªã‚¢
            </button>
          </div>
        </div>
      )}
    </div>
  )
}
```

---

### 2.10 ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼

```typescript
// app/components/ImageUploader.tsx
'use client'

import { useState } from 'react'
import { createClient } from '@/lib/supabase/client'

interface ImageUploaderProps {
  tagId: string
  onUploadComplete: (urls: string[]) => void
}

export function ImageUploader({ tagId, onUploadComplete }: ImageUploaderProps) {
  const [uploading, setUploading] = useState(false)
  const [progress, setProgress] = useState(0)
  const supabase = createClient()

  const compressImage = async (file: File): Promise<Blob> => {
    return new Promise((resolve) => {
      const reader = new FileReader()
      reader.readAsDataURL(file)
      reader.onload = (event) => {
        const img = new Image()
        img.src = event.target?.result as string
        img.onload = () => {
          const canvas = document.createElement('canvas')
          let width = img.width
          let height = img.height

          // 1920pxä»¥ä¸‹ã«ãƒªã‚µã‚¤ã‚º
          const maxSize = 1920
          if (width > height && width > maxSize) {
            height *= maxSize / width
            width = maxSize
          } else if (height > maxSize) {
            width *= maxSize / height
            height = maxSize
          }

          canvas.width = width
          canvas.height = height

          const ctx = canvas.getContext('2d')!
          ctx.drawImage(img, 0, 0, width, height)

          canvas.toBlob(
            (blob) => {
              resolve(blob!)
            },
            'image/jpeg',
            0.8
          )
        }
      }
    })
  }

  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = Array.from(e.target.files || [])
    if (files.length === 0) return

    setUploading(true)
    const uploadedUrls: string[] = []

    for (let i = 0; i < Math.min(files.length, 5); i++) {
      const file = files[i]
      setProgress(((i + 0.5) / files.length) * 100)

      // åœ§ç¸®
      const compressedBlob = await compressImage(file)

      // Supabase Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      const fileName = `${tagId}/${Date.now()}_${i}.jpg`
      const { data, error } = await supabase.storage
        .from('triage-images')
        .upload(fileName, compressedBlob, {
          cacheControl: '3600',
          upsert: false
        })

      if (error) {
        console.error('Upload error:', error)
        continue
      }

      // å…¬é–‹URLå–å¾—
      const {
        data: { publicUrl }
      } = supabase.storage.from('triage-images').getPublicUrl(fileName)

      uploadedUrls.push(publicUrl)
      setProgress(((i + 1) / files.length) * 100)
    }

    setUploading(false)
    setProgress(0)
    onUploadComplete(uploadedUrls)
  }

  return (
    <div>
      <input
        type="file"
        accept="image/*"
        multiple
        capture="environment"
        onChange={handleFileChange}
        disabled={uploading}
        className="hidden"
        id="image-upload"
      />

      <label
        htmlFor="image-upload"
        className={`block w-full py-6 text-center rounded-lg border-2 border-dashed ${
          uploading
            ? 'border-gray-300 bg-gray-100 cursor-not-allowed'
            : 'border-blue-500 bg-blue-50 cursor-pointer hover:bg-blue-100'
        }`}
      >
        {uploading ? (
          <div>
            <p className="text-lg font-semibold">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...</p>
            <div className="w-full bg-gray-200 rounded-full h-3 mt-3 mx-auto max-w-xs">
              <div
                className="bg-blue-500 h-3 rounded-full transition-all"
                style={{ width: `${progress}%` }}
              />
            </div>
            <p className="text-sm text-gray-500 mt-2">{Math.round(progress)}%</p>
          </div>
        ) : (
          <div>
            <p className="text-xl font-semibold">ğŸ“· å†™çœŸã‚’æ’®å½±/é¸æŠ</p>
            <p className="text-sm text-gray-500 mt-1">æœ€å¤§5æšã¾ã§</p>
          </div>
        )}
      </label>
    </div>
  )
}
```

---

### 2.11 ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œï¼ˆIndexedDB + å˜ç´”åŒæœŸï¼‰

**IndexedDBãƒ©ãƒƒãƒ‘ãƒ¼**
```typescript
// lib/offline/indexeddb.ts
import { openDB, DBSchema, IDBPDatabase } from 'idb'
import { TriageTag } from '@/lib/types'

interface TriageDB extends DBSchema {
  tags: {
    key: string
    value: TriageTag & { _pending: boolean; _timestamp: number }
  }
  syncQueue: {
    key: number
    value: {
      operation: 'create' | 'update'
      tagId: string
      data: Partial<TriageTag>
      timestamp: number
    }
  }
}

let db: IDBPDatabase<TriageDB>

export async function initDB() {
  if (db) return db

  db = await openDB<TriageDB>('triage-system', 1, {
    upgrade(db) {
      // ãƒˆãƒªã‚¢ãƒ¼ã‚¸ã‚¿ã‚°ã‚¹ãƒˆã‚¢
      if (!db.objectStoreNames.contains('tags')) {
        db.createObjectStore('tags', { keyPath: 'id' })
      }

      // åŒæœŸã‚­ãƒ¥ãƒ¼ã‚¹ãƒˆã‚¢
      if (!db.objectStoreNames.contains('syncQueue')) {
        const store = db.createObjectStore('syncQueue', {
          keyPath: 'timestamp',
          autoIncrement: true
        })
        store.createIndex('by-timestamp', 'timestamp')
      }
    }
  })

  return db
}

export async function saveTagOffline(tag: TriageTag) {
  const db = await initDB()
  await db.put('tags', {
    ...tag,
    _pending: true,
    _timestamp: Date.now()
  })
}

export async function getTagOffline(id: string) {
  const db = await initDB()
  return await db.get('tags', id)
}

export async function getAllTagsOffline() {
  const db = await initDB()
  return await db.getAll('tags')
}

export async function addToSyncQueue(
  operation: 'create' | 'update',
  tagId: string,
  data: Partial<TriageTag>
) {
  const db = await initDB()
  await db.add('syncQueue', {
    operation,
    tagId,
    data,
    timestamp: Date.now()
  })
}

export async function getSyncQueue() {
  const db = await initDB()
  return await db.getAll('syncQueue')
}

export async function clearSyncQueue() {
  const db = await initDB()
  await db.clear('syncQueue')
}
```

**åŒæœŸãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼**
```typescript
// lib/offline/sync-manager.ts
import { createClient } from '@/lib/supabase/client'
import { getSyncQueue, clearSyncQueue, getAllTagsOffline } from './indexeddb'

export async function syncOfflineData() {
  if (!navigator.onLine) {
    throw new Error('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä¸­ã®ãŸã‚åŒæœŸã§ãã¾ã›ã‚“')
  }

  const supabase = createClient()
  const queue = await getSyncQueue()

  if (queue.length === 0) {
    console.log('åŒæœŸã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“')
    return
  }

  console.log(`${queue.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸä¸­...`)

  for (const item of queue) {
    try {
      if (item.operation === 'create') {
        // æ–°è¦ä½œæˆ
        const { error } = await supabase.from('triage_tags').insert(item.data as any)

        if (error) throw error
      } else if (item.operation === 'update') {
        // æ›´æ–°ï¼ˆç«¶åˆè§£æ±º: ã‚µãƒ¼ãƒãƒ¼å‹ã¡ï¼‰
        const { data: serverData, error: fetchError } = await supabase
          .from('triage_tags')
          .select('updated_at')
          .eq('id', item.tagId)
          .single()

        if (fetchError) throw fetchError

        // ã‚µãƒ¼ãƒãƒ¼ã®æ›´æ–°æ™‚åˆ»ãŒæ–°ã—ã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        const serverUpdatedAt = new Date(serverData.updated_at).getTime()
        if (serverUpdatedAt > item.timestamp) {
          console.log(`ã‚¹ã‚­ãƒƒãƒ—ï¼ˆã‚µãƒ¼ãƒãƒ¼å„ªå…ˆï¼‰: ${item.tagId}`)
          continue
        }

        // æ›´æ–°å®Ÿè¡Œ
        const { error } = await supabase
          .from('triage_tags')
          .update(item.data)
          .eq('id', item.tagId)

        if (error) throw error
      }

      console.log(`åŒæœŸæˆåŠŸ: ${item.operation} ${item.tagId}`)
    } catch (err) {
      console.error(`åŒæœŸå¤±æ•—: ${item.operation} ${item.tagId}`, err)
      throw err
    }
  }

  // åŒæœŸã‚­ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢
  await clearSyncQueue()
  console.log('åŒæœŸå®Œäº†')
}

// è‡ªå‹•åŒæœŸï¼ˆ30ç§’ã”ã¨ï¼‰
export function startAutoSync() {
  const interval = setInterval(async () => {
    if (navigator.onLine) {
      try {
        await syncOfflineData()
      } catch (err) {
        console.error('è‡ªå‹•åŒæœŸã‚¨ãƒ©ãƒ¼:', err)
      }
    }
  }, 30000) // 30ç§’

  return () => clearInterval(interval)
}
```

**ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼**
```typescript
// app/components/OfflineIndicator.tsx
'use client'

import { useEffect, useState } from 'react'
import { syncOfflineData } from '@/lib/offline/sync-manager'

export function OfflineIndicator() {
  const [isOnline, setIsOnline] = useState(true)
  const [isSyncing, setIsSyncing] = useState(false)

  useEffect(() => {
    const handleOnline = async () => {
      setIsOnline(true)
      setIsSyncing(true)
      try {
        await syncOfflineData()
      } catch (err) {
        console.error('åŒæœŸã‚¨ãƒ©ãƒ¼:', err)
      } finally {
        setIsSyncing(false)
      }
    }

    const handleOffline = () => {
      setIsOnline(false)
    }

    setIsOnline(navigator.onLine)

    window.addEventListener('online', handleOnline)
    window.addEventListener('offline', handleOffline)

    return () => {
      window.removeEventListener('online', handleOnline)
      window.removeEventListener('offline', handleOffline)
    }
  }, [])

  const handleManualSync = async () => {
    setIsSyncing(true)
    try {
      await syncOfflineData()
      alert('åŒæœŸãŒå®Œäº†ã—ã¾ã—ãŸ')
    } catch (err: any) {
      alert(`åŒæœŸã‚¨ãƒ©ãƒ¼: ${err.message}`)
    } finally {
      setIsSyncing(false)
    }
  }

  if (isOnline && !isSyncing) {
    return null
  }

  return (
    <div className="fixed bottom-4 right-4 z-50">
      {!isOnline && (
        <div className="bg-yellow-500 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3">
          <span className="text-2xl">âš ï¸</span>
          <div>
            <p className="font-bold">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰</p>
            <p className="text-sm">ãƒ‡ãƒ¼ã‚¿ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã•ã‚Œã¾ã™</p>
          </div>
        </div>
      )}

      {isSyncing && (
        <div className="bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3">
          <div className="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full" />
          <p className="font-bold">åŒæœŸä¸­...</p>
        </div>
      )}

      {isOnline && !isSyncing && (
        <button
          onClick={handleManualSync}
          className="bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-green-600"
        >
          ğŸ”„ æ‰‹å‹•åŒæœŸ
        </button>
      )}
    </div>
  )
}
```

---

### 2.12 åœ°å›³è¡¨ç¤ºï¼ˆLeaflet.jsï¼‰

```typescript
// app/components/MapView.tsx
'use client'

import { useEffect, useRef } from 'react'
import L from 'leaflet'
import 'leaflet/dist/leaflet.css'
import { TriageTag } from '@/lib/types'

// Leafletã‚¢ã‚¤ã‚³ãƒ³ä¿®æ­£ï¼ˆNext.jså¯¾å¿œï¼‰
delete (L.Icon.Default.prototype as any)._getIconUrl
L.Icon.Default.mergeOptions({
  iconRetinaUrl: '/leaflet/marker-icon-2x.png',
  iconUrl: '/leaflet/marker-icon.png',
  shadowUrl: '/leaflet/marker-shadow.png'
})

interface MapViewProps {
  triageTags: TriageTag[]
  center?: [number, number]
  zoom?: number
}

export function MapView({ triageTags, center = [35.6812, 139.7671], zoom = 14 }: MapViewProps) {
  const mapRef = useRef<L.Map | null>(null)
  const markersRef = useRef<L.Marker[]>([])

  useEffect(() => {
    if (!mapRef.current) {
      // åœ°å›³åˆæœŸåŒ–
      mapRef.current = L.map('map').setView(center, zoom)

      // OpenStreetMapã‚¿ã‚¤ãƒ«
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(mapRef.current)
    }

    return () => {
      mapRef.current?.remove()
      mapRef.current = null
    }
  }, [])

  useEffect(() => {
    if (!mapRef.current) return

    // æ—¢å­˜ãƒãƒ¼ã‚«ãƒ¼å‰Šé™¤
    markersRef.current.forEach((m) => m.remove())
    markersRef.current = []

    // æ–°è¦ãƒãƒ¼ã‚«ãƒ¼è¿½åŠ 
    triageTags.forEach((tag) => {
      const colorMap = {
        red: 'red',
        yellow: 'gold',
        green: 'green',
        black: 'black'
      }

      const icon = L.divIcon({
        className: 'custom-marker',
        html: `<div style="
          width: 30px;
          height: 30px;
          background-color: ${colorMap[tag.triage_category.final]};
          border: 3px solid white;
          border-radius: 50%;
          box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        "></div>`,
        iconSize: [30, 30],
        iconAnchor: [15, 15]
      })

      const marker = L.marker([tag.location.latitude, tag.location.longitude], { icon })
        .addTo(mapRef.current!)
        .bindPopup(
          `
          <div class="p-2">
            <h3 class="font-bold">${tag.tag_number}</h3>
            <p>åŒºåˆ†: <strong>${tag.triage_category.final}</strong></p>
            <p>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${tag.transport.status}</p>
          </div>
        `
        )

      markersRef.current.push(marker)
    })
  }, [triageTags])

  return <div id="map" className="w-full h-full" />
}
```

**Leaflet.jsè¿½åŠ è¨­å®š**
```bash
npm install leaflet @types/leaflet
```

```javascript
// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  // ãã®ä»–ã®è¨­å®š
}

const withPWA = require('next-pwa')({
  dest: 'public',
  register: true,
  skipWaiting: true,
  disable: process.env.NODE_ENV === 'development'
})

module.exports = withPWA(nextConfig)
```

---

### 2.13 æŒ‡æ®æœ¬éƒ¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰

```typescript
// app/(dashboard)/command/page.tsx
import { createClient } from '@/lib/supabase/server'
import { MapView } from '@/app/components/MapView'
import { ListView } from './components/ListView'
import { StatsPanel } from './components/StatsPanel'

export default async function CommandDashboard() {
  const supabase = createClient()

  // ãƒˆãƒªã‚¢ãƒ¼ã‚¸ã‚¿ã‚°å–å¾—
  const { data: tags } = await supabase
    .from('triage_tags')
    .select('*')
    .order('created_at', { ascending: false })

  return (
    <div className="h-screen flex flex-col">
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <header className="bg-blue-600 text-white p-4">
        <h1 className="text-2xl font-bold">æŒ‡æ®æœ¬éƒ¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
      </header>

      {/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
      <div className="flex-1 flex overflow-hidden">
        {/* ãƒãƒƒãƒ—ãƒ“ãƒ¥ãƒ¼ï¼ˆå·¦ï¼‰ */}
        <div className="w-1/2 border-r">
          <MapView triageTags={tags || []} />
        </div>

        {/* ãƒªã‚¹ãƒˆ + çµ±è¨ˆï¼ˆå³ï¼‰ */}
        <div className="w-1/2 flex flex-col">
          {/* çµ±è¨ˆãƒ‘ãƒãƒ« */}
          <div className="h-1/3 border-b overflow-auto">
            <StatsPanel tags={tags || []} />
          </div>

          {/* ãƒªã‚¹ãƒˆãƒ“ãƒ¥ãƒ¼ */}
          <div className="flex-1 overflow-auto">
            <ListView tags={tags || []} />
          </div>
        </div>
      </div>
    </div>
  )
}
```

**çµ±è¨ˆãƒ‘ãƒãƒ«**
```typescript
// app/(dashboard)/command/components/StatsPanel.tsx
import { TriageTag } from '@/lib/types'

interface StatsPanelProps {
  tags: TriageTag[]
}

export function StatsPanel({ tags }: StatsPanelProps) {
  const stats = {
    total: tags.length,
    red: tags.filter((t) => t.triage_category.final === 'red').length,
    yellow: tags.filter((t) => t.triage_category.final === 'yellow').length,
    green: tags.filter((t) => t.triage_category.final === 'green').length,
    black: tags.filter((t) => t.triage_category.final === 'black').length,
    not_transported: tags.filter((t) => t.transport.status === 'not_transported').length,
    in_transit: tags.filter((t) => t.transport.status === 'in_transit').length,
    arrived: tags.filter((t) => t.transport.status === 'arrived').length
  }

  return (
    <div className="p-4 grid grid-cols-4 gap-4">
      {/* ãƒˆãƒªã‚¢ãƒ¼ã‚¸åŒºåˆ†çµ±è¨ˆ */}
      <div className="bg-red-100 p-4 rounded-lg">
        <p className="text-sm text-gray-600">èµ¤ï¼ˆæœ€å„ªå…ˆï¼‰</p>
        <p className="text-3xl font-bold text-red-600">{stats.red}</p>
      </div>
      <div className="bg-yellow-100 p-4 rounded-lg">
        <p className="text-sm text-gray-600">é»„ï¼ˆéç·Šæ€¥ï¼‰</p>
        <p className="text-3xl font-bold text-yellow-600">{stats.yellow}</p>
      </div>
      <div className="bg-green-100 p-4 rounded-lg">
        <p className="text-sm text-gray-600">ç·‘ï¼ˆè»½å‚·ï¼‰</p>
        <p className="text-3xl font-bold text-green-600">{stats.green}</p>
      </div>
      <div className="bg-gray-100 p-4 rounded-lg">
        <p className="text-sm text-gray-600">é»’ï¼ˆä¸å‡¦ç½®ï¼‰</p>
        <p className="text-3xl font-bold text-gray-600">{stats.black}</p>
      </div>

      {/* æ¬é€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹çµ±è¨ˆ */}
      <div className="bg-blue-100 p-4 rounded-lg col-span-2">
        <p className="text-sm text-gray-600">æœªæ¬é€</p>
        <p className="text-3xl font-bold text-blue-600">{stats.not_transported}</p>
      </div>
      <div className="bg-indigo-100 p-4 rounded-lg">
        <p className="text-sm text-gray-600">æ¬é€ä¸­</p>
        <p className="text-3xl font-bold text-indigo-600">{stats.in_transit}</p>
      </div>
      <div className="bg-purple-100 p-4 rounded-lg">
        <p className="text-sm text-gray-600">åˆ°ç€æ¸ˆ</p>
        <p className="text-3xl font-bold text-purple-600">{stats.arrived}</p>
      </div>
    </div>
  )
}
```

**ãƒªã‚¹ãƒˆãƒ“ãƒ¥ãƒ¼**
```typescript
// app/(dashboard)/command/components/ListView.tsx
'use client'

import { TriageTag } from '@/lib/types'
import { useMemo } from 'react'

interface ListViewProps {
  tags: TriageTag[]
}

export function ListView({ tags }: ListViewProps) {
  // å„ªå…ˆåº¦é †ã«ã‚½ãƒ¼ãƒˆ
  const sortedTags = useMemo(() => {
    return [...tags].sort((a, b) => {
      // å„ªå…ˆåº¦: èµ¤ > é»„ > ç·‘ > é»’
      const priorityMap = { red: 0, yellow: 1, green: 2, black: 3 }
      const aPriority = priorityMap[a.triage_category.final]
      const bPriority = priorityMap[b.triage_category.final]

      if (aPriority !== bPriority) {
        return aPriority - bPriority
      }

      // æœªæ¬é€ã‚’å„ªå…ˆ
      if (a.transport.status === 'not_transported' && b.transport.status !== 'not_transported') {
        return -1
      }
      if (a.transport.status !== 'not_transported' && b.transport.status === 'not_transported') {
        return 1
      }

      // ç™»éŒ²æ™‚åˆ»ãŒå¤ã„é †
      return new Date(a.created_at).getTime() - new Date(b.created_at).getTime()
    })
  }, [tags])

  return (
    <div className="overflow-auto">
      <table className="w-full">
        <thead className="bg-gray-100 sticky top-0">
          <tr>
            <th className="p-3 text-left">åŒºåˆ†</th>
            <th className="p-3 text-left">ã‚¿ã‚°No.</th>
            <th className="p-3 text-left">ä½ç½®</th>
            <th className="p-3 text-left">ãƒã‚¤ã‚¿ãƒ«</th>
            <th className="p-3 text-left">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
            <th className="p-3 text-left">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          {sortedTags.slice(0, 50).map((tag, index) => (
            <tr
              key={tag.id}
              className={`border-b hover:bg-gray-50 ${
                index < 10 &&
                tag.triage_category.final === 'red' &&
                tag.transport.status === 'not_transported'
                  ? 'bg-red-50 font-semibold'
                  : ''
              }`}
            >
              <td className="p-3">
                <span
                  className={`inline-block w-8 h-8 rounded-full ${
                    tag.triage_category.final === 'red'
                      ? 'bg-red-500'
                      : tag.triage_category.final === 'yellow'
                        ? 'bg-yellow-500'
                        : tag.triage_category.final === 'green'
                          ? 'bg-green-500'
                          : 'bg-black'
                  }`}
                />
              </td>
              <td className="p-3">{tag.tag_number}</td>
              <td className="p-3 text-sm text-gray-600">
                {tag.location.area_grid ||
                  `${tag.location.latitude.toFixed(4)}, ${tag.location.longitude.toFixed(4)}`}
              </td>
              <td className="p-3 text-sm">
                <div>å‘¼å¸: {tag.vital_signs.respiratory_rate || '-'}/åˆ†</div>
                <div>SpOâ‚‚: {tag.vital_signs.spo2 || '-'}%</div>
              </td>
              <td className="p-3">
                <span
                  className={`px-2 py-1 rounded text-sm ${
                    tag.transport.status === 'not_transported'
                      ? 'bg-gray-200'
                      : tag.transport.status === 'in_transit'
                        ? 'bg-blue-100'
                        : 'bg-green-100'
                  }`}
                >
                  {tag.transport.status === 'not_transported'
                    ? 'æœªæ¬é€'
                    : tag.transport.status === 'in_transit'
                      ? 'æ¬é€ä¸­'
                      : 'åˆ°ç€æ¸ˆ'}
                </span>
              </td>
              <td className="p-3">
                {tag.transport.status === 'not_transported' && (
                  <button className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    æ¬é€æŒ‡ç¤º
                  </button>
                )}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  )
}
```

---

### 2.14 API Routesï¼ˆå®Œå…¨ç‰ˆï¼‰

**ãƒˆãƒªã‚¢ãƒ¼ã‚¸ã‚¿ã‚°API**
```typescript
// app/api/tags/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'
import { createTriageTagSchema } from '@/lib/validation/schemas'

export async function GET(request: NextRequest) {
  const supabase = createClient()

  const { data, error } = await supabase
    .from('triage_tags')
    .select('*')
    .order('created_at', { ascending: false })

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 500 })
  }

  return NextResponse.json({ data })
}

export async function POST(request: NextRequest) {
  const supabase = createClient()
  const body = await request.json()

  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  const result = createTriageTagSchema.safeParse(body)
  if (!result.success) {
    return NextResponse.json({ error: result.error.errors }, { status: 400 })
  }

  // åŒ¿åIDã‚’ç”Ÿæˆï¼ˆæ°åã®ãƒãƒƒã‚·ãƒ¥ï¼‰
  const anonymousId = await crypto.subtle
    .digest('SHA-256', new TextEncoder().encode(body.tag_number + Date.now()))
    .then((buf) =>
      Array.from(new Uint8Array(buf))
        .map((b) => b.toString(16).padStart(2, '0'))
        .join('')
    )

  // AIã«ã‚ˆã‚‹ãƒˆãƒªã‚¢ãƒ¼ã‚¸ææ¡ˆï¼ˆãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ - MVPç‰ˆï¼‰
  const aiSuggestion = suggestTriageCategory(body.vital_signs, body.triage_category.start_steps)

  // ç›£æŸ»æƒ…å ±
  const {
    data: { user }
  } = await supabase.auth.getUser()

  const tagData = {
    ...body,
    anonymous_id: anonymousId,
    triage_category: {
      ...body.triage_category,
      ai_suggested: aiSuggestion.category,
      ai_confidence: aiSuggestion.confidence,
      ai_reasoning: aiSuggestion.reasoning,
      final_decided_by: user?.id || 'unknown',
      final_decided_at: new Date().toISOString()
    },
    audit: {
      created_by: user?.id || 'unknown',
      created_at: new Date().toISOString(),
      created_device_id: request.headers.get('user-agent') || 'unknown',
      updated_by: user?.id || 'unknown',
      updated_at: new Date().toISOString(),
      updated_device_id: request.headers.get('user-agent') || 'unknown',
      version: 1,
      revision_history: []
    }
  }

  const { data, error } = await supabase.from('triage_tags').insert(tagData).select().single()

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 500 })
  }

  return NextResponse.json({ data }, { status: 201 })
}

// AIãƒˆãƒªã‚¢ãƒ¼ã‚¸ææ¡ˆï¼ˆãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ï¼‰
function suggestTriageCategory(vitalSigns: any, startSteps: any) {
  let category: 'black' | 'red' | 'yellow' | 'green' = 'green'
  let confidence = 1.0
  let reasons: string[] = []

  // STARTæ³•ãƒ­ã‚¸ãƒƒã‚¯
  if (startSteps.can_walk === true) {
    category = 'green'
    reasons.push('æ­©è¡Œå¯èƒ½')
  } else if (startSteps.has_respiration === false) {
    category = 'black'
    reasons.push('å‘¼å¸åœæ­¢')
  } else if (
    startSteps.respiratory_rate_range === '0' ||
    startSteps.respiratory_rate_range === '<10' ||
    startSteps.respiratory_rate_range === '>=30'
  ) {
    category = 'red'
    reasons.push(`å‘¼å¸æ•°ç•°å¸¸ï¼ˆ${startSteps.respiratory_rate_range}ï¼‰`)
  } else if (startSteps.radial_pulse === false) {
    category = 'red'
    reasons.push('æ©ˆéª¨å‹•è„ˆè§¦çŸ¥ä¸å¯')
  } else if (startSteps.follows_commands === false) {
    category = 'red'
    reasons.push('æ„è­˜ãƒ¬ãƒ™ãƒ«ä½ä¸‹')
  } else {
    category = 'yellow'
    reasons.push('ãƒã‚¤ã‚¿ãƒ«å®‰å®šã€å‡¦ç½®é…å»¶å¯èƒ½')
  }

  // ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³ã«ã‚ˆã‚‹è¿½åŠ åˆ¤å®š
  if (vitalSigns.spo2 && vitalSigns.spo2 < 90) {
    category = 'red'
    reasons.push(`ä½é…¸ç´ ï¼ˆSpO2:${vitalSigns.spo2}%ï¼‰`)
    confidence = 0.95
  }

  return {
    category,
    confidence,
    reasoning: reasons.join('ã€') + `ã®ãŸã‚${category}åŒºåˆ†ã‚’ææ¡ˆ`
  }
}
```

**å€‹åˆ¥ã‚¿ã‚°API**
```typescript
// app/api/tags/[id]/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'
import { updateTriageTagSchema } from '@/lib/validation/schemas'

export async function GET(request: NextRequest, { params }: { params: { id: string } }) {
  const supabase = createClient()

  const { data, error } = await supabase.from('triage_tags').select('*').eq('id', params.id).single()

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 404 })
  }

  return NextResponse.json({ data })
}

export async function PUT(request: NextRequest, { params }: { params: { id: string } }) {
  const supabase = createClient()
  const body = await request.json()

  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  const result = updateTriageTagSchema.safeParse(body)
  if (!result.success) {
    return NextResponse.json({ error: result.error.errors }, { status: 400 })
  }

  // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—
  const {
    data: { user }
  } = await supabase.auth.getUser()

  // æ›´æ–°ãƒ‡ãƒ¼ã‚¿æº–å‚™
  const updateData = {
    ...body,
    updated_at: new Date().toISOString()
  }

  // ç›£æŸ»æƒ…å ±æ›´æ–°
  if (body.audit) {
    updateData.audit = {
      ...body.audit,
      updated_by: user?.id || 'unknown',
      updated_at: new Date().toISOString(),
      updated_device_id: request.headers.get('user-agent') || 'unknown',
      version: (body.audit.version || 0) + 1
    }
  }

  const { data, error } = await supabase
    .from('triage_tags')
    .update(updateData)
    .eq('id', params.id)
    .select()
    .single()

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 500 })
  }

  return NextResponse.json({ data })
}
```

---

### 2.15 PWAè¨­å®šï¼ˆnext-pwaï¼‰

```javascript
// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true
}

const withPWA = require('next-pwa')({
  dest: 'public',
  register: true,
  skipWaiting: true,
  disable: process.env.NODE_ENV === 'development',
  runtimeCaching: [
    {
      urlPattern: /^https:\/\/.*\.supabase\.co\/storage\/.*/i,
      handler: 'CacheFirst',
      options: {
        cacheName: 'supabase-images',
        expiration: {
          maxEntries: 100,
          maxAgeSeconds: 7 * 24 * 60 * 60 // 7æ—¥
        }
      }
    },
    {
      urlPattern: /^https:\/\/.*\.supabase\.co\/rest\/.*/i,
      handler: 'NetworkFirst',
      options: {
        cacheName: 'supabase-api',
        networkTimeoutSeconds: 10
      }
    },
    {
      urlPattern: /^https:\/\/.*\.tile\.openstreetmap\.org\/.*/i,
      handler: 'CacheFirst',
      options: {
        cacheName: 'map-tiles',
        expiration: {
          maxEntries: 500,
          maxAgeSeconds: 30 * 24 * 60 * 60 // 30æ—¥
        }
      }
    }
  ]
})

module.exports = withPWA(nextConfig)
```

```json
// public/manifest.json
{
  "name": "ãƒˆãƒªã‚¢ãƒ¼ã‚¸ã‚¿ãƒƒã‚°ã‚·ã‚¹ãƒ†ãƒ ",
  "short_name": "ãƒˆãƒªã‚¢ãƒ¼ã‚¸",
  "description": "ç½å®³æ™‚ãƒˆãƒªã‚¢ãƒ¼ã‚¸ã‚¿ãƒƒã‚°æƒ…å ±ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#2563eb",
  "orientation": "portrait",
  "icons": [
    {
      "src": "/icons/icon-192x192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-512x512.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ]
}
```

---

## ğŸ“… 3. å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆMVP: 3ãƒ¶æœˆï¼‰

| é€± | å®Ÿè£…å†…å®¹ | æˆæœç‰© | æ‹…å½“ |
|----|---------|--------|------|
| **Week 1-2** | ç’°å¢ƒæ§‹ç¯‰ + èªè¨¼ | Supabaseè¨­å®šã€Next.jsåˆæœŸåŒ–ã€èªè¨¼ãƒ•ãƒ­ãƒ¼ã€RLS | Backend |
| **Week 3-4** | QRèª­å– + åŸºæœ¬å…¥åŠ› | QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã€ãƒˆãƒªã‚¢ãƒ¼ã‚¸ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã€ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ | Frontend |
| **Week 5-6** | STARTæ³•ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ | åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã€ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰UIã€AIãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ææ¡ˆ | Frontend + Logic |
| **Week 7-8** | éŸ³å£°å…¥åŠ› + ç”»åƒåœ§ç¸® | Web Speech APIçµ±åˆã€ç”»åƒåœ§ç¸®ã€Supabase Storage | Frontend |
| **Week 9-10** | åœ°å›³ãƒ»ä¸€è¦§è¡¨ | Leaflet.jsçµ±åˆã€ãƒªã‚¹ãƒˆãƒ“ãƒ¥ãƒ¼ã€ã‚½ãƒ¼ãƒˆãƒ»ãƒ•ã‚£ãƒ«ã‚¿ | Frontend |
| **Week 11-12** | ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ + PWA | IndexedDBã€åŒæœŸãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã€next-pwaè¨­å®š | Frontend |
| **Week 12** | PDF/CSVå‡ºåŠ› | å¸³ç¥¨ç”ŸæˆAPIã€ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ | Backend |
| **Week 12** | ãƒ†ã‚¹ãƒˆ + ãƒ‡ãƒ—ãƒ­ã‚¤ | E2Eãƒ†ã‚¹ãƒˆã€æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ | QA + DevOps |

---

## âœ… 4. å—ã‘å…¥ã‚ŒåŸºæº–ï¼ˆãƒ†ã‚¹ãƒˆä»•æ§˜ï¼‰

### 4.1 æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ

```typescript
// e2e/triage-workflow.spec.ts
import { test, expect } from '@playwright/test'

test.describe('ãƒˆãƒªã‚¢ãƒ¼ã‚¸ç™»éŒ²ãƒ•ãƒ­ãƒ¼', () => {
  test('QRã‚¹ã‚­ãƒ£ãƒ³â†’30ç§’ç™»éŒ²â†’ç¢ºèª', async ({ page }) => {
    await page.goto('/triage/scan')

    const startTime = Date.now()

    // QRã‚¹ã‚­ãƒ£ãƒ³ï¼ˆãƒ¢ãƒƒã‚¯ï¼‰
    await page.click('[data-testid="qr-scan-button"]')
    await page.waitForSelector('[data-testid="qr-detected"]')

    // æœ€å°å…¥åŠ›
    await page.click('[data-testid="category-red"]')
    await page.click('[data-testid="take-photo"]')
    await page.waitForSelector('[data-testid="photo-preview"]')

    // ç™»éŒ²
    await page.click('[data-testid="submit-triage"]')
    await page.waitForSelector('[data-testid="success-message"]')

    const endTime = Date.now()
    expect(endTime - startTime).toBeLessThan(30000) // 30ç§’ä»¥å†…
  })

  test('STARTæ³•ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰â†’AIåˆ¤å®šä¸€è‡´', async ({ page }) => {
    await page.goto('/triage/wizard')

    // æ­©è¡Œä¸å¯
    await page.click('[data-testid="cannot-walk"]')

    // å‘¼å¸ã‚ã‚Š
    await page.click('[data-testid="has-respiration"]')

    // å‘¼å¸æ•°30å›/åˆ†ä»¥ä¸Š
    await page.click('[data-testid="respiratory-rate-high"]')

    // çµæœç¢ºèª
    await expect(page.locator('[data-testid="result-category"]')).toHaveText('èµ¤')
    await expect(page.locator('[data-testid="result-reasoning"]')).toContain('å‘¼å¸æ•°ç•°å¸¸')
  })
})
```

### 4.2 ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åŒæœŸãƒ†ã‚¹ãƒˆ

```typescript
// e2e/offline-sync.spec.ts
import { test, expect } from '@playwright/test'

test('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³10ä»¶ç™»éŒ²â†’åŒæœŸ', async ({ page, context }) => {
  await page.goto('/triage/scan')

  // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡æ›¿
  await context.setOffline(true)

  // 10ä»¶ç™»éŒ²
  for (let i = 0; i < 10; i++) {
    await page.click('[data-testid="qr-scan"]')
    // ... ç™»éŒ²å‡¦ç†
    await page.click('[data-testid="submit"]')
  }

  // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¾©å¸°
  await context.setOffline(false)

  // åŒæœŸå¾…æ©Ÿï¼ˆæœ€å¤§5åˆ†ï¼‰
  await page.waitForSelector('[data-testid="sync-complete"]', { timeout: 300000 })

  // ã‚µãƒ¼ãƒãƒ¼ç¢ºèª
  const response = await page.request.get('/api/tags')
  const { data } = await response.json()

  expect(data.length).toBeGreaterThanOrEqual(10)
})
```

---

## ğŸš€ 5. ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

### 5.1 Supabaseè¨­å®š

```bash
# Supabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
# https://supabase.com/dashboard/projects

# .env.localã«ç’°å¢ƒå¤‰æ•°è¨­å®š
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
```

### 5.2 Vercelãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# Vercel CLIã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm i -g vercel

# ãƒ‡ãƒ—ãƒ­ã‚¤
vercel --prod

# ç’°å¢ƒå¤‰æ•°è¨­å®šï¼ˆVercel Dashboardï¼‰
NEXT_PUBLIC_SUPABASE_URL
NEXT_PUBLIC_SUPABASE_ANON_KEY
```

---

## ğŸ“– 6. Claude Codeã¸ã®æœ€çµ‚æŒ‡ç¤º

```
# ãƒˆãƒªã‚¢ãƒ¼ã‚¸ã‚¿ãƒƒã‚°ã‚·ã‚¹ãƒ†ãƒ  MVPå®Ÿè£…é–‹å§‹

ã“ã®å®Œå…¨ä»•æ§˜æ›¸ï¼ˆMVPæŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯æº–æ‹ ç‰ˆï¼‰ã«åŸºã¥ãã€å®Ÿè£…ã‚’é–‹å§‹ã—ã¾ã™ã€‚

## æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ï¼ˆå³å®ˆï¼‰
- Next.js 14 App Router
- React 18 + TypeScript
- Tailwind CSS
- Supabase (PostgreSQL + Auth + Storage)
- next-pwa (Service Worker)
- Playwright + Jest
- Zod
- html5-qrcode
- Leaflet.jsï¼ˆåœ°å›³ï¼‰
- IndexedDBï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼‰

## å®Ÿè£…é–‹å§‹ã‚³ãƒãƒ³ãƒ‰

```bash
npx create-next-app@latest triage-system --typescript --tailwind --app
cd triage-system
npm install @supabase/supabase-js @supabase/ssr
npm install zod
npm install html5-qrcode
npm install leaflet @types/leaflet react-leaflet
npm install idb
npm install next-pwa
npm install -D @playwright/test
```

## æœ€åˆã®ã‚¿ã‚¹ã‚¯

1. Supabaseè¨­å®šï¼ˆSQLã‚¹ã‚­ãƒ¼ãƒå®Ÿè¡Œï¼‰
2. `.env.local`ä½œæˆ
3. `lib/supabase/client.ts`ç­‰ã®Supabaseçµ±åˆ
4. èªè¨¼ãƒšãƒ¼ã‚¸å®Ÿè£…
5. QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼å®Ÿè£…
6. STARTæ³•ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰å®Ÿè£…

```

---