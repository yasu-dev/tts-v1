# „ÄêÂÆåÂÖ®‰øÆÊ≠£Áâà„Äë„Éà„É™„Ç¢„Éº„Ç∏„Çø„ÉÉ„Ç∞„Ç∑„Çπ„ÉÜ„É† - MVPÊäÄË°ì„Çπ„Çø„ÉÉ„ÇØÊ∫ñÊã†‰ªïÊßòÊõ∏

**ÈáçË¶Å„Å™‰øÆÊ≠£ÁÇπ**ÔºöÂâçÂõûÊèêÁ§∫„Åó„ÅüMapbox„ÄÅYjs (CRDT)„ÄÅTensorFlow.js„ÄÅYOLOv8Á≠â„ÅÆÂ§ñÈÉ®„É©„Ç§„Éñ„É©„É™„ÅØ**„Åô„Åπ„Å¶ÂâäÈô§**„Åó„ÄÅÊåáÂÆö„Åï„Çå„ÅüMVPÊäÄË°ì„Çπ„Çø„ÉÉ„ÇØ„ÅÆ„Åø„ÅßÂÆüË£ÖÂèØËÉΩ„Å™‰ªïÊßò„Å´ÂÆåÂÖ®Êõ∏„ÅçÁõ¥„Åó„Åæ„Åó„Åü„ÄÇ

---

## üìã 1. ÊäÄË°ì„Çπ„Çø„ÉÉ„ÇØÔºàMVPÁî®„ÉªÁ¢∫ÂÆöÁâàÔºâ

| „Ç´„ÉÜ„Ç¥„É™ | ÊäÄË°ì | Áî®ÈÄî |
|---------|------|------|
| **„Éï„É≠„É≥„Éà„Ç®„É≥„Éâ** | Next.js 14 App Router + React 18 + TypeScript | „Éï„É¨„Éº„É†„ÉØ„Éº„ÇØ |
| **UI** | Tailwind CSS | „Çπ„Çø„Ç§„É™„É≥„Ç∞ |
| **Áä∂ÊÖãÁÆ°ÁêÜ** | React Server Components + useContext | „Ç∞„É≠„Éº„Éê„É´Áä∂ÊÖã |
| **„Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ** | Next.js API Routes | API„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà |
| **„Éá„Éº„Çø„Éô„Éº„Çπ** | Supabase (PostgreSQL) | „Éá„Éº„ÇøÊ∞∏Á∂öÂåñ |
| **Ë™çË®º** | Supabase Auth | „É¶„Éº„Ç∂„ÉºË™çË®º„ÉªMFA |
| **„Çπ„Éà„É¨„Éº„Ç∏** | Supabase Storage | ÁîªÂÉè„ÉªÈü≥Â£∞‰øùÂ≠ò |
| **PWA** | next-pwa + Service Worker | „Ç™„Éï„É©„Ç§„É≥ÂØæÂøú |
| **„ÉÜ„Çπ„Éà** | Playwright + Jest | E2E + „É¶„Éã„ÉÉ„Éà |
| **„Éê„É™„Éá„Éº„Ç∑„Éß„É≥** | Zod | „Çπ„Ç≠„Éº„ÉûÊ§úË®º |
| **„Ç§„É≥„Éï„É©** | Supabase (Ëá™ÂãïÂÜóÈï∑Âåñ) | „Éõ„Çπ„ÉÜ„Ç£„É≥„Ç∞ |

**ËøΩÂä†„É©„Ç§„Éñ„É©„É™ÔºàÊúÄÂ∞èÈôêÔºâ**
- `html5-qrcode`: QRË™≠ÂèñÔºà„Ç´„É°„É©APIÁµ±ÂêàÔºâ
- `react-leaflet`: ËªΩÈáèÂú∞Âõ≥Ë°®Á§∫
- `date-fns`: Êó•‰ªòÂá¶ÁêÜ

**‰ΩøÁî®„Åó„Å™„ÅÑ„É©„Ç§„Éñ„É©„É™ÔºàPhase 2‰ª•Èôç„Å´Âª∂ÊúüÔºâ**
- ‚ùå Mapbox GL JSÔºàÈáç„ÅÑÔºâ
- ‚ùå Yjs/AutomergeÔºàCRDTÔºâ
- ‚ùå TensorFlow.jsÔºàAIÊé®Ë´ñÔºâ
- ‚ùå YOLOv8ÔºàÁîªÂÉèËß£ÊûêÔºâ

---

## üîß 2. ÂÆüË£ÖË©≥Á¥∞ÔºàÂÆåÂÖ®Áâà„ÉªMVPÊäÄË°ì„Çπ„Çø„ÉÉ„ÇØÊ∫ñÊã†Ôºâ

### 2.1 „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊßãÈÄ†

```
triage-system/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ (auth)/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ login/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îú‚îÄ‚îÄ (dashboard)/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ command/              # ÊåáÊèÆÊú¨ÈÉ®
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ components/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ MapView.tsx
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ ListView.tsx
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ StatsPanel.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ triage/               # „Çø„ÉÉ„Ç∞‰ªò„ÅëÈÉ®Èöä
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ scan/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ register/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ wizard/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ transport/            # Êê¨ÈÄÅÈÉ®Èöä
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [tagId]/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ hospital/             # ÂåªÁôÇÊ©üÈñ¢
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [...nextauth]/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ route.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tags/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ route.ts          # GET/POST
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [id]/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ route.ts      # GET/PUT
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sync/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ route.ts          # „Ç™„Éï„É©„Ç§„É≥ÂêåÊúü
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ export/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ pdf/
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ route.ts
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ csv/
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ route.ts
‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ QRScanner.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ VoiceInput.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ImageUploader.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ StartWizard.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ OfflineIndicator.tsx
‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îú‚îÄ‚îÄ page.tsx
‚îÇ   ‚îî‚îÄ‚îÄ globals.css
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ supabase/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ client.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ server.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ middleware.ts
‚îÇ   ‚îú‚îÄ‚îÄ validation/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ schemas.ts            # Zod„Çπ„Ç≠„Éº„Éû
‚îÇ   ‚îú‚îÄ‚îÄ offline/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ indexeddb.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sync-manager.ts
‚îÇ   ‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ start-triage.ts       # STARTÊ≥ï„É≠„Ç∏„ÉÉ„ÇØ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ image-compress.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ voice-parser.ts
‚îÇ   ‚îî‚îÄ‚îÄ types/
‚îÇ       ‚îî‚îÄ‚îÄ index.ts
‚îú‚îÄ‚îÄ public/
‚îÇ   ‚îú‚îÄ‚îÄ manifest.json
‚îÇ   ‚îú‚îÄ‚îÄ sw.js                     # Service Worker
‚îÇ   ‚îî‚îÄ‚îÄ icons/
‚îú‚îÄ‚îÄ .env.local
‚îú‚îÄ‚îÄ next.config.js
‚îú‚îÄ‚îÄ tailwind.config.js
‚îú‚îÄ‚îÄ tsconfig.json
‚îî‚îÄ‚îÄ package.json
```

---

### 2.2 „Éá„Éº„Çø„É¢„Éá„É´ÔºàSupabase PostgreSQLÔºâ

#### 2.2.1 SQL„Çπ„Ç≠„Éº„Éû

```sql
-- ===== 1. ÁÅΩÂÆ≥„Ç§„Éô„É≥„Éà„ÉÜ„Éº„Éñ„É´ =====
CREATE TABLE events (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  occurred_at TIMESTAMPTZ NOT NULL,
  closed_at TIMESTAMPTZ,
  location_polygon JSONB,  -- GeoJSONÂΩ¢Âºè
  command_post_location JSONB,  -- {lat, lng}
  communication_mode TEXT DEFAULT 'normal',  -- 'normal' | 'satellite' | 'mesh' | 'offline'
  status TEXT DEFAULT 'active',  -- 'preparing' | 'active' | 'closing' | 'archived'
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ===== 2. „Éà„É™„Ç¢„Éº„Ç∏„Çø„Ç∞„ÉÜ„Éº„Éñ„É´Ôºà‰∏≠Ê†∏Ôºâ =====
CREATE TABLE triage_tags (
  -- Ë≠òÂà•
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  event_id UUID REFERENCES events(id) ON DELETE CASCADE,
  anonymous_id TEXT NOT NULL,  -- ÂåøÂêç„Éè„ÉÉ„Ç∑„É•
  tag_number TEXT NOT NULL,
  
  -- ÊÇ£ËÄÖÊÉÖÂ†±ÔºàÊöóÂè∑ÂåñÔºâ
  patient_info JSONB,  -- {name, age, sex, address, phone}
  
  -- ‰ΩçÁΩÆÊÉÖÂ†±
  location JSONB NOT NULL,  -- {latitude, longitude, altitude, accuracy, method, area_grid, timestamp}
  
  -- Áîü‰ΩìÊâÄË¶ã
  vital_signs JSONB NOT NULL,  -- {respiratory_rate, respiratory_status, pulse_rate, radial_pulse_palpable, consciousness, spo2, blood_pressure, temperature, trauma_assessment, bleeding_evaluation, measured_at}
  
  -- „Éà„É™„Ç¢„Éº„Ç∏Âå∫ÂàÜ
  triage_category JSONB NOT NULL,  -- {ai_suggested, ai_confidence, ai_reasoning, final, final_decided_by, final_decided_at, override_reason, start_steps}
  
  -- ÂÜç„Éà„É™„Ç¢„Éº„Ç∏Â±•Ê≠¥
  retriage_history JSONB DEFAULT '[]',  -- Array of {from, to, reason, changed_by, changed_at}
  
  -- Ê∑ª‰ªòÊÉÖÂ†±
  attachments JSONB DEFAULT '{"images":[],"audio_notes":[],"drone_images":[]}',
  
  -- Âá¶ÁΩÆË®òÈå≤
  treatments JSONB DEFAULT '[]',  -- Array of {type, description, performed_by, performed_at}
  
  -- Êê¨ÈÄÅÊÉÖÂ†±
  transport JSONB DEFAULT '{"status":"not_transported"}',  -- {status, team_id, vehicle_id, destination, departure_time, arrival_time, transport_duration, vital_changes}
  
  -- Ëª¢Â∏∞ÊÉÖÂ†±
  outcome JSONB,  -- {diagnosis, treatments_performed, admission_ward, discharge_date, final_outcome}
  
  -- Áõ£ÊüªÊÉÖÂ†±
  audit JSONB NOT NULL,  -- {created_by, created_at, created_device_id, updated_by, updated_at, updated_device_id, version, revision_history}
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  UNIQUE(event_id, tag_number)
);

-- ‰ΩçÁΩÆÊÉÖÂ†±Áî®GiST„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÔºàÈ´òÈÄüÊ§úÁ¥¢Ôºâ
CREATE INDEX idx_triage_tags_location ON triage_tags USING GIST ((location->>'latitude')::float8, (location->>'longitude')::float8);

-- „Éà„É™„Ç¢„Éº„Ç∏Âå∫ÂàÜÁî®„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
CREATE INDEX idx_triage_tags_category ON triage_tags ((triage_category->>'final'));

-- Êê¨ÈÄÅ„Çπ„ÉÜ„Éº„Çø„ÇπÁî®„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
CREATE INDEX idx_triage_tags_transport_status ON triage_tags ((transport->>'status'));

-- ===== 3. Âú∞ÁêÜ„Ç®„É™„Ç¢„ÉÜ„Éº„Éñ„É´ =====
CREATE TABLE geographic_areas (
  id TEXT PRIMARY KEY,  -- "A1", "B2", etc.
  event_id UUID REFERENCES events(id) ON DELETE CASCADE,
  bounds JSONB NOT NULL,  -- {north, south, east, west}
  priority_score INTEGER DEFAULT 0,  -- 0-100
  estimated_casualty_count INTEGER DEFAULT 0,
  severity_distribution JSONB DEFAULT '{"red":0,"yellow":0,"green":0,"black":0}',
  drone_analysis JSONB,  -- {image_url, analyzed_at, detected_persons, heatmap_url}
  assigned_team_ids TEXT[] DEFAULT '{}',
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ===== 4. ÂåªÁôÇÊ©üÈñ¢„Éû„Çπ„Çø =====
CREATE TABLE hospitals (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  location JSONB NOT NULL,  -- {address, latitude, longitude}
  contact JSONB NOT NULL,  -- {phone, emergency_phone, email}
  capabilities JSONB NOT NULL,  -- {departments, has_er, has_icu, has_heliport}
  current_load JSONB DEFAULT '{"total_capacity":0,"current_patients":0,"accepting_status":"accepting","last_updated":""}',
  transport_count INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ===== 5. Èöä/Ëªä‰∏°„ÉÜ„Éº„Éñ„É´ =====
CREATE TABLE teams (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  event_id UUID REFERENCES events(id) ON DELETE CASCADE,
  type TEXT NOT NULL,  -- 'triage' | 'transport' | 'dmat' | 'fire' | 'police'
  name TEXT NOT NULL,
  members JSONB DEFAULT '[]',  -- Array of {user_id, role}
  current_location JSONB,  -- {latitude, longitude, accuracy, updated_at}
  status TEXT DEFAULT 'standby',  -- 'standby' | 'moving' | 'active' | 'resting' | 'out_of_service'
  assigned_area_ids TEXT[] DEFAULT '{}',
  assigned_casualty_ids UUID[] DEFAULT '{}',
  vehicle JSONB,  -- {id, type, license_plate}
  activity_log JSONB DEFAULT '[]',  -- Array of {action, location, timestamp}
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ===== 6. „É¶„Éº„Ç∂„Éº„É≠„Éº„É´„ÉÜ„Éº„Éñ„É´ =====
CREATE TABLE user_roles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  event_id UUID REFERENCES events(id) ON DELETE CASCADE,
  role TEXT NOT NULL,  -- 'IC' | 'TRI' | 'TRN' | 'HSP' | 'DMAT' | 'AUD' | 'ADM'
  assigned_area_ids TEXT[] DEFAULT '{}',  -- ABAC: „Ç®„É™„Ç¢Âà∂Èôê
  created_at TIMESTAMPTZ DEFAULT NOW(),
  
  UNIQUE(user_id, event_id)
);

-- ===== 7. Áõ£Êüª„É≠„Ç∞„ÉÜ„Éº„Éñ„É´ÔºàWORMÔºâ =====
CREATE TABLE audit_logs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  sequence_number BIGSERIAL,
  previous_hash TEXT,
  current_hash TEXT NOT NULL,
  
  event_type TEXT NOT NULL,
  user_id UUID REFERENCES auth.users(id),
  resource_type TEXT,
  resource_id TEXT,
  action TEXT NOT NULL,
  changes JSONB,
  
  ip_address INET,
  user_agent TEXT,
  device_id TEXT,
  
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ÊåøÂÖ•Â∞ÇÁî®„Éù„É™„Ç∑„ÉºÔºàÂâäÈô§„ÉªÊõ¥Êñ∞Á¶ÅÊ≠¢Ôºâ
CREATE POLICY "Audit logs are append-only" ON audit_logs FOR DELETE USING (false);
CREATE POLICY "Audit logs cannot be updated" ON audit_logs FOR UPDATE USING (false);

-- ===== 8. „Ç™„Éï„É©„Ç§„É≥ÂêåÊúüÁî®Áä∂ÊÖã„ÉÜ„Éº„Éñ„É´ =====
CREATE TABLE sync_state (
  device_id TEXT PRIMARY KEY,
  event_id UUID REFERENCES events(id),
  last_synced_at TIMESTAMPTZ DEFAULT NOW(),
  pending_changes JSONB DEFAULT '[]',  -- Array of {tag_id, operation, data, timestamp}
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ===== 9. RLSÔºàRow Level SecurityÔºâ„Éù„É™„Ç∑„Éº =====

-- ÊåáÊèÆÊú¨ÈÉ®(IC)„ÅØÂÖ®„Éá„Éº„ÇøÈñ≤Ë¶ßÂèØËÉΩ
CREATE POLICY "IC can view all triage tags"
  ON triage_tags FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM user_roles
      WHERE user_id = auth.uid()
        AND event_id = triage_tags.event_id
        AND role = 'IC'
    )
  );

-- „Çø„ÉÉ„Ç∞‰ªò„ÅëÈÉ®Èöä(TRI)„ÅØËá™ÂàÜ„Åå‰ΩúÊàê„Åó„Åü„Çø„Ç∞„ÅÆ„ÅøÁ∑®ÈõÜÂèØËÉΩ
CREATE POLICY "TRI can update own tags"
  ON triage_tags FOR UPDATE
  USING (
    EXISTS (
      SELECT 1 FROM user_roles
      WHERE user_id = auth.uid()
        AND event_id = triage_tags.event_id
        AND role = 'TRI'
    )
    AND (audit->>'created_by')::UUID = auth.uid()
  );

-- Êê¨ÈÄÅÈÉ®Èöä(TRN)„ÅØÂâ≤„ÇäÂΩì„Å¶„Çâ„Çå„Åü„Çø„Ç∞„ÅÆ„ÅøÈñ≤Ë¶ß„ÉªÊõ¥Êñ∞ÂèØËÉΩ
CREATE POLICY "TRN can view assigned tags"
  ON triage_tags FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM user_roles ur
      JOIN teams t ON t.event_id = ur.event_id
      WHERE ur.user_id = auth.uid()
        AND ur.event_id = triage_tags.event_id
        AND ur.role = 'TRN'
        AND triage_tags.id = ANY(t.assigned_casualty_ids)
    )
  );

-- ÂåªÁôÇÊ©üÈñ¢(HSP)„ÅØËá™Èô¢„Å´Êê¨ÈÄÅ‰∫àÂÆö„ÅÆ„Çø„Ç∞„ÅÆ„ÅøÈñ≤Ë¶ßÂèØËÉΩ
CREATE POLICY "HSP can view incoming tags"
  ON triage_tags FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM user_roles ur
      JOIN hospitals h ON h.id::TEXT = ur.assigned_area_ids[1]  -- hospital_id„Çíarea_ids„Å´Ê†ºÁ¥ç
      WHERE ur.user_id = auth.uid()
        AND ur.event_id = triage_tags.event_id
        AND ur.role = 'HSP'
        AND (transport->>'destination')::JSONB->>'hospital_id' = h.id::TEXT
    )
  );

-- RLSÊúâÂäπÂåñ
ALTER TABLE triage_tags ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_roles ENABLE ROW LEVEL SECURITY;
ALTER TABLE teams ENABLE ROW LEVEL SECURITY;

-- ===== 10. „Éà„É™„Ç¨„ÉºÔºàÊõ¥Êñ∞ÊôÇÂàªËá™ÂãïÊõ¥Êñ∞Ôºâ =====
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_triage_tags_updated_at
  BEFORE UPDATE ON triage_tags
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_events_updated_at
  BEFORE UPDATE ON events
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();
```

---

### 2.3 TypeScriptÂûãÂÆöÁæ©ÔºàÂÆåÂÖ®ÁâàÔºâ

```typescript
// lib/types/index.ts

// ===== ÁÅΩÂÆ≥„Ç§„Éô„É≥„Éà =====
export interface Event {
  id: string
  name: string
  occurred_at: string
  closed_at: string | null
  location_polygon: GeoJSON.Polygon | null
  command_post_location: {
    lat: number
    lng: number
  } | null
  communication_mode: 'normal' | 'satellite' | 'mesh' | 'offline'
  status: 'preparing' | 'active' | 'closing' | 'archived'
  created_by: string
  created_at: string
  updated_at: string
}

// ===== „Éà„É™„Ç¢„Éº„Ç∏„Çø„Ç∞ =====
export interface TriageTag {
  id: string
  event_id: string
  anonymous_id: string
  tag_number: string
  
  patient_info?: {
    name?: string
    age?: number
    sex?: 'male' | 'female' | 'other' | 'unknown'
    address?: string
    phone?: string
  }
  
  location: {
    latitude: number
    longitude: number
    altitude?: number
    accuracy: number
    method: 'gps' | 'wifi' | 'manual' | 'estimated'
    area_grid?: string
    timestamp: string
  }
  
  vital_signs: {
    respiratory_rate?: number
    respiratory_status: 'normal' | 'abnormal' | 'stopped'
    pulse_rate?: number
    radial_pulse_palpable: boolean
    crt?: number
    consciousness: {
      avpu: 'alert' | 'voice' | 'pain' | 'unresponsive'
      jcs?: number
      gcs?: {
        eye: number
        verbal: number
        motor: number
      }
    }
    spo2?: number
    blood_pressure?: {
      systolic: number
      diastolic: number
    }
    temperature?: number
    trauma_assessment?: string
    bleeding_evaluation?: 'none' | 'minor' | 'moderate' | 'severe'
    measured_at: string
  }
  
  triage_category: {
    ai_suggested: 'black' | 'red' | 'yellow' | 'green'
    ai_confidence: number
    ai_reasoning: string
    final: 'black' | 'red' | 'yellow' | 'green'
    final_decided_by: string
    final_decided_at: string
    override_reason?: string
    start_steps: {
      can_walk: boolean | null
      has_respiration: boolean | null
      respiratory_rate_range: '0' | '<10' | '10-29' | '>=30' | null
      radial_pulse: boolean | null
      follows_commands: boolean | null
    }
  }
  
  retriage_history: Array<{
    from: 'black' | 'red' | 'yellow' | 'green'
    to: 'black' | 'red' | 'yellow' | 'green'
    reason: string
    changed_by: string
    changed_at: string
  }>
  
  attachments: {
    images: Array<{
      id: string
      url: string
      type: 'wound' | 'scene' | 'body_diagram' | 'other'
      compressed_size: number
      thumbnail_url?: string
      taken_at: string
      location?: { lat: number; lng: number }
    }>
    audio_notes: Array<{
      id: string
      url: string
      transcription: string
      duration: number
      recorded_at: string
    }>
    drone_images?: Array<{
      id: string
      url: string
      analysis_result?: {
        detected_posture: 'lying' | 'sitting' | 'standing'
        bounding_box: { x: number; y: number; width: number; height: number }
      }
    }>
  }
  
  treatments: Array<{
    type: 'hemostasis' | 'airway' | 'fixation' | 'oxygen' | 'other'
    description: string
    performed_by: string
    performed_at: string
  }>
  
  transport: {
    status: 'not_transported' | 'waiting' | 'in_transit' | 'arrived' | 'admitted'
    team_id?: string
    vehicle_id?: string
    destination?: {
      hospital_id: string
      hospital_name: string
      department: string
      eta?: string
    }
    departure_time?: string
    arrival_time?: string
    transport_duration?: number
    vital_changes_during_transport?: Array<{
      vital_signs: TriageTag['vital_signs']
      timestamp: string
    }>
  }
  
  outcome?: {
    diagnosis: string
    treatments_performed: string[]
    admission_ward?: string
    discharge_date?: string
    final_outcome: 'recovered' | 'admitted' | 'transferred' | 'deceased'
  }
  
  audit: {
    created_by: string
    created_at: string
    created_device_id: string
    updated_by: string
    updated_at: string
    updated_device_id: string
    version: number
    revision_history: Array<{
      version: number
      diff: object
      changed_by: string
      changed_at: string
      change_reason?: string
    }>
  }
  
  created_at: string
  updated_at: string
}

// ===== Âú∞ÁêÜ„Ç®„É™„Ç¢ =====
export interface GeographicArea {
  id: string
  event_id: string
  bounds: {
    north: number
    south: number
    east: number
    west: number
  }
  priority_score: number
  estimated_casualty_count: number
  severity_distribution: {
    red: number
    yellow: number
    green: number
    black: number
  }
  drone_analysis?: {
    image_url: string
    analyzed_at: string
    detected_persons: number
    heatmap_url?: string
  }
  assigned_team_ids: string[]
  updated_at: string
}

// ===== ÂåªÁôÇÊ©üÈñ¢ =====
export interface Hospital {
  id: string
  name: string
  location: {
    address: string
    latitude: number
    longitude: number
  }
  contact: {
    phone: string
    emergency_phone?: string
    email?: string
  }
  capabilities: {
    departments: Array<{
      name: string
      available_beds: number
      occupied_beds: number
      specialties: string[]
    }>
    has_er: boolean
    has_icu: boolean
    has_heliport: boolean
  }
  current_load: {
    total_capacity: number
    current_patients: number
    accepting_status: 'accepting' | 'limited' | 'full'
    last_updated: string
  }
  transport_count: number
  created_at: string
  updated_at: string
}

// ===== Èöä/Ëªä‰∏° =====
export interface Team {
  id: string
  event_id: string
  type: 'triage' | 'transport' | 'dmat' | 'fire' | 'police'
  name: string
  members: Array<{
    user_id: string
    role: 'leader' | 'member'
  }>
  current_location?: {
    latitude: number
    longitude: number
    accuracy: number
    updated_at: string
  }
  status: 'standby' | 'moving' | 'active' | 'resting' | 'out_of_service'
  assigned_area_ids: string[]
  assigned_casualty_ids: string[]
  vehicle?: {
    id: string
    type: 'ambulance' | 'fire_truck' | 'command_vehicle'
    license_plate: string
  }
  activity_log: Array<{
    action: 'arrived' | 'started_triage' | 'completed_triage' | 'departed'
    location?: { lat: number; lng: number }
    timestamp: string
  }>
  created_at: string
  updated_at: string
}

// ===== „É¶„Éº„Ç∂„Éº„É≠„Éº„É´ =====
export interface UserRole {
  id: string
  user_id: string
  event_id: string
  role: 'IC' | 'TRI' | 'TRN' | 'HSP' | 'DMAT' | 'AUD' | 'ADM'
  assigned_area_ids: string[]
  created_at: string
}
```

---

### 2.4 Zod„Éê„É™„Éá„Éº„Ç∑„Éß„É≥„Çπ„Ç≠„Éº„Éû

```typescript
// lib/validation/schemas.ts
import { z } from 'zod'

// ===== „Éà„É™„Ç¢„Éº„Ç∏„Çø„Ç∞ÁôªÈå≤„Çπ„Ç≠„Éº„Éû =====
export const createTriageTagSchema = z.object({
  event_id: z.string().uuid(),
  tag_number: z.string().min(1).max(50),
  
  location: z.object({
    latitude: z.number().min(-90).max(90),
    longitude: z.number().min(-180).max(180),
    altitude: z.number().optional(),
    accuracy: z.number().min(0),
    method: z.enum(['gps', 'wifi', 'manual', 'estimated']),
    area_grid: z.string().optional(),
    timestamp: z.string().datetime()
  }),
  
  vital_signs: z.object({
    respiratory_rate: z.number().min(0).max(200).optional(),
    respiratory_status: z.enum(['normal', 'abnormal', 'stopped']),
    pulse_rate: z.number().min(0).max(300).optional(),
    radial_pulse_palpable: z.boolean(),
    consciousness: z.object({
      avpu: z.enum(['alert', 'voice', 'pain', 'unresponsive']),
      jcs: z.number().min(0).max(300).optional(),
      gcs: z.object({
        eye: z.number().min(1).max(4),
        verbal: z.number().min(1).max(5),
        motor: z.number().min(1).max(6)
      }).optional()
    }),
    spo2: z.number().min(0).max(100).optional(),
    blood_pressure: z.object({
      systolic: z.number().min(0).max(300),
      diastolic: z.number().min(0).max(200)
    }).optional(),
    temperature: z.number().min(30).max(45).optional(),
    trauma_assessment: z.string().optional(),
    bleeding_evaluation: z.enum(['none', 'minor', 'moderate', 'severe']).optional(),
    measured_at: z.string().datetime()
  }),
  
  triage_category: z.object({
    final: z.enum(['black', 'red', 'yellow', 'green']),
    start_steps: z.object({
      can_walk: z.boolean().nullable(),
      has_respiration: z.boolean().nullable(),
      respiratory_rate_range: z.enum(['0', '<10', '10-29', '>=30']).nullable(),
      radial_pulse: z.boolean().nullable(),
      follows_commands: z.boolean().nullable()
    })
  })
})

// ===== „Éà„É™„Ç¢„Éº„Ç∏„Çø„Ç∞Êõ¥Êñ∞„Çπ„Ç≠„Éº„Éû =====
export const updateTriageTagSchema = z.object({
  vital_signs: z.object({
    respiratory_rate: z.number().min(0).max(200).optional(),
    pulse_rate: z.number().min(0).max(300).optional(),
    spo2: z.number().min(0).max(100).optional()
  }).optional(),
  
  triage_category: z.object({
    final: z.enum(['black', 'red', 'yellow', 'green']),
    override_reason: z.string().min(1)
  }).optional(),
  
  transport: z.object({
    status: z.enum(['not_transported', 'waiting', 'in_transit', 'arrived', 'admitted']),
    team_id: z.string().uuid().optional(),
    vehicle_id: z.string().optional(),
    destination: z.object({
      hospital_id: z.string().uuid(),
      hospital_name: z.string(),
      department: z.string()
    }).optional()
  }).optional()
})

// ===== ÂåªÁôÇÊ©üÈñ¢ÂèóÂÖ•Êõ¥Êñ∞„Çπ„Ç≠„Éº„Éû =====
export const updateHospitalLoadSchema = z.object({
  hospital_id: z.string().uuid(),
  current_patients: z.number().min(0),
  accepting_status: z.enum(['accepting', 'limited', 'full'])
})
```

---

### 2.5 Supabase„ÇØ„É©„Ç§„Ç¢„É≥„ÉàË®≠ÂÆö

```typescript
// lib/supabase/client.ts
import { createBrowserClient } from '@supabase/ssr'
import { Database } from './database.types'

export const createClient = () =>
  createBrowserClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
```

```typescript
// lib/supabase/server.ts
import { createServerClient, type CookieOptions } from '@supabase/ssr'
import { cookies } from 'next/headers'
import { Database } from './database.types'

export const createClient = () => {
  const cookieStore = cookies()

  return createServerClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return cookieStore.get(name)?.value
        },
        set(name: string, value: string, options: CookieOptions) {
          try {
            cookieStore.set({ name, value, ...options })
          } catch (error) {
            // Server ComponentÂÜÖ„Åß„ÅØÁÑ°Ë¶ñ
          }
        },
        remove(name: string, options: CookieOptions) {
          try {
            cookieStore.set({ name, value: '', ...options })
          } catch (error) {
            // Server ComponentÂÜÖ„Åß„ÅØÁÑ°Ë¶ñ
          }
        }
      }
    }
  )
}
```

```typescript
// lib/supabase/middleware.ts
import { createServerClient, type CookieOptions } from '@supabase/ssr'
import { NextResponse, type NextRequest } from 'next/server'

export async function updateSession(request: NextRequest) {
  let response = NextResponse.next({
    request: {
      headers: request.headers
    }
  })

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return request.cookies.get(name)?.value
        },
        set(name: string, value: string, options: CookieOptions) {
          request.cookies.set({
            name,
            value,
            ...options
          })
          response = NextResponse.next({
            request: {
              headers: request.headers
            }
          })
          response.cookies.set({
            name,
            value,
            ...options
          })
        },
        remove(name: string, options: CookieOptions) {
          request.cookies.set({
            name,
            value: '',
            ...options
          })
          response = NextResponse.next({
            request: {
              headers: request.headers
            }
          })
          response.cookies.set({
            name,
            value: '',
            ...options
          })
        }
      }
    }
  )

  await supabase.auth.getUser()

  return response
}
```

```typescript
// middleware.ts
import { type NextRequest } from 'next/server'
import { updateSession } from '@/lib/supabase/middleware'

export async function middleware(request: NextRequest) {
  return await updateSession(request)
}

export const config = {
  matcher: [
    '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)'
  ]
}
```

---

### 2.6 Ë™çË®ºÊ©üËÉΩ

#### 2.6.1 „É≠„Ç∞„Ç§„É≥„Éö„Éº„Ç∏

```typescript
// app/(auth)/login/page.tsx
'use client'

import { useState } from 'react'
import { createClient } from '@/lib/supabase/client'
import { useRouter } from 'next/navigation'

export default function LoginPage() {
  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const router = useRouter()
  const supabase = createClient()

  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault()
    setLoading(true)
    setError(null)

    try {
      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password
      })

      if (error) throw error

      router.push('/dashboard')
      router.refresh()
    } catch (err: any) {
      setError(err.message)
    } finally {
      setLoading(false)
    }
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-100">
      <div className="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
        <h1 className="text-2xl font-bold mb-6 text-center">
          „Éà„É™„Ç¢„Éº„Ç∏„Çø„ÉÉ„Ç∞„Ç∑„Çπ„ÉÜ„É†
        </h1>

        <form onSubmit={handleLogin} className="space-y-4">
          <div>
            <label htmlFor="email" className="block text-sm font-medium mb-1">
              „É°„Éº„É´„Ç¢„Éâ„É¨„Çπ
            </label>
            <input
              id="email"
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              required
              className="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          <div>
            <label htmlFor="password" className="block text-sm font-medium mb-1">
              „Éë„Çπ„ÉØ„Éº„Éâ
            </label>
            <input
              id="password"
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              required
              className="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          {error && (
            <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm">
              {error}
            </div>
          )}

          <button
            type="submit"
            disabled={loading}
            className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {loading ? '„É≠„Ç∞„Ç§„É≥‰∏≠...' : '„É≠„Ç∞„Ç§„É≥'}
          </button>
        </form>
      </div>
    </div>
  )
}
```

---

### 2.7 QR„Çπ„Ç≠„É£„Éä„ÉºÂÆüË£Ö

```typescript
// app/components/QRScanner.tsx
'use client'

import { useEffect, useRef, useState } from 'react'
import { Html5QrcodeScanner } from 'html5-qrcode'

interface QRScannerProps {
  onScan: (tagId: string) => void
  onError?: (error: string) => void
}

export function QRScanner({ onScan, onError }: QRScannerProps) {
  const scannerRef = useRef<Html5QrcodeScanner>()
  const [isScanning, setIsScanning] = useState(false)

  useEffect(() => {
    if (!isScanning) return

    scannerRef.current = new Html5QrcodeScanner(
      'qr-reader',
      {
        fps: 10,
        qrbox: { width: 250, height: 250 },
        aspectRatio: 1.0,
        showTorchButtonIfSupported: true
      },
      false
    )

    scannerRef.current.render(
      (decodedText) => {
        try {
          // QR„Éá„Éº„ÇøÂΩ¢Âºè: "TRIAGE:EVENT_ID:TAG_ID:CHECKSUM"
          const parts = decodedText.split(':')
          if (parts[0] !== 'TRIAGE' || parts.length !== 4) {
            throw new Error('ÁÑ°Âäπ„Å™QR„Ç≥„Éº„ÉâÂΩ¢Âºè„Åß„Åô')
          }

          // „ÉÅ„Çß„ÉÉ„ÇØ„Çµ„É†Ê§úË®ºÔºàÁ∞°ÊòìÁâà: ÊñáÂ≠óÂàóÈï∑„ÅÆÂêàË®àÔºâ
          const expectedChecksum = (parts[1].length + parts[2].length).toString()
          if (parts[3] !== expectedChecksum) {
            throw new Error('QR„Ç≥„Éº„Éâ„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Çµ„É†„Åå‰∏ÄËá¥„Åó„Åæ„Åõ„Çì')
          }

          onScan(parts[2]) // TAG_ID
          scannerRef.current?.clear()
          setIsScanning(false)
        } catch (err: any) {
          onError?.(err.message)
        }
      },
      (error) => {
        // „Çπ„Ç≠„É£„É≥„Ç®„É©„Éº„ÅØÁÑ°Ë¶ñÔºàÁ∂ôÁ∂ö„Çπ„Ç≠„É£„É≥Ôºâ
      }
    )

    return () => {
      scannerRef.current?.clear()
    }
  }, [isScanning, onScan, onError])

  return (
    <div className="space-y-4">
      {!isScanning ? (
        <button
          onClick={() => setIsScanning(true)}
          className="w-full bg-blue-600 text-white py-6 rounded-lg text-xl font-bold hover:bg-blue-700"
        >
          üì∑ QR„Ç≥„Éº„Éâ„Çí„Çπ„Ç≠„É£„É≥
        </button>
      ) : (
        <div className="space-y-4">
          <div id="qr-reader" className="border-4 border-blue-500 rounded-lg overflow-hidden" />
          <button
            onClick={() => {
              scannerRef.current?.clear()
              setIsScanning(false)
            }}
            className="w-full bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400"
          >
            „Ç≠„É£„É≥„Çª„É´
          </button>
        </div>
      )}
    </div>
  )
}
```

---

### 2.8 STARTÊ≥ï„Ç¶„Ç£„Ç∂„Éº„ÉâÂÆüË£Ö

```typescript
// app/components/StartWizard.tsx
'use client'

import { useState } from 'react'
import { TriageTag } from '@/lib/types'

interface StartWizardProps {
  onComplete: (result: {
    category: 'black' | 'red' | 'yellow' | 'green'
    steps: TriageTag['triage_category']['start_steps']
    reasoning: string
  }) => void
}

export function StartWizard({ onComplete }: StartWizardProps) {
  const [step, setStep] = useState(1)
  const [answers, setAnswers] = useState<TriageTag['triage_category']['start_steps']>({
    can_walk: null,
    has_respiration: null,
    respiratory_rate_range: null,
    radial_pulse: null,
    follows_commands: null
  })

  const handleAnswer = (key: keyof typeof answers, value: any) => {
    const newAnswers = { ...answers, [key]: value }
    setAnswers(newAnswers)

    // STARTÊ≥ïÂà§ÂÆö„É≠„Ç∏„ÉÉ„ÇØ
    if (key === 'can_walk' && value === true) {
      onComplete({ category: 'green', steps: newAnswers, reasoning: 'Ê≠©Ë°åÂèØËÉΩ„ÅÆ„Åü„ÇÅÁ∑ëÂå∫ÂàÜ' })
      return
    }

    if (key === 'has_respiration' && value === false) {
      onComplete({ category: 'black', steps: newAnswers, reasoning: 'ÂëºÂê∏ÂÅúÊ≠¢„ÅÆ„Åü„ÇÅÈªíÂå∫ÂàÜ' })
      return
    }

    if (key === 'respiratory_rate_range') {
      if (value === '0' || value === '<10' || value === '>=30') {
        onComplete({ category: 'red', steps: newAnswers, reasoning: `ÂëºÂê∏Êï∞Áï∞Â∏∏Ôºà${value}Ôºâ„ÅÆ„Åü„ÇÅËµ§Âå∫ÂàÜ` })
        return
      }
      setStep(4)
      return
    }

    if (key === 'radial_pulse' && value === false) {
      onComplete({ category: 'red', steps: newAnswers, reasoning: 'Ê©àÈ™®ÂãïËÑàËß¶Áü•‰∏çÂèØ„ÅÆ„Åü„ÇÅËµ§Âå∫ÂàÜ' })
      return
    }

    if (key === 'follows_commands') {
      if (value === false) {
        onComplete({ category: 'red', steps: newAnswers, reasoning: 'ÊÑèË≠ò„É¨„Éô„É´‰Ωé‰∏ã„ÅÆ„Åü„ÇÅËµ§Âå∫ÂàÜ' })
      } else {
        onComplete({ category: 'yellow', steps: newAnswers, reasoning: '„Éê„Ç§„Çø„É´ÂÆâÂÆö„ÄÅÂá¶ÁΩÆÈÅÖÂª∂ÂèØËÉΩ„ÅÆ„Åü„ÇÅÈªÑÂå∫ÂàÜ' })
      }
      return
    }

    setStep(step + 1)
  }

  return (
    <div className="bg-white rounded-lg shadow-lg p-6 max-w-md mx-auto">
      {/* „Çπ„ÉÜ„ÉÉ„Éó„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº */}
      <div className="flex justify-between mb-6">
        {[1, 2, 3, 4, 5].map((s) => (
          <div
            key={s}
            className={`w-10 h-10 rounded-full flex items-center justify-center font-bold ${
              s === step ? 'bg-blue-600 text-white' : s < step ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-400'
            }`}
          >
            {s}
          </div>
        ))}
      </div>

      {/* „Çπ„ÉÜ„ÉÉ„Éó1: Ê≠©Ë°åÂèØÂê¶ */}
      {step === 1 && (
        <div>
          <h2 className="text-2xl font-bold mb-6">Ê≠©Ë°å„Åß„Åç„Åæ„Åô„ÅãÔºü</h2>
          <div className="flex gap-4">
            <button
              onClick={() => handleAnswer('can_walk', true)}
              className="flex-1 bg-green-500 text-white py-12 rounded-lg text-2xl font-bold hover:bg-green-600 active:bg-green-700"
            >
              „ÅØ„ÅÑ
            </button>
            <button
              onClick={() => handleAnswer('can_walk', false)}
              className="flex-1 bg-red-500 text-white py-12 rounded-lg text-2xl font-bold hover:bg-red-600 active:bg-red-700"
            >
              „ÅÑ„ÅÑ„Åà
            </button>
          </div>
        </div>
      )}

      {/* „Çπ„ÉÜ„ÉÉ„Éó2: ÂëºÂê∏Á¢∫Ë™ç */}
      {step === 2 && (
        <div>
          <h2 className="text-2xl font-bold mb-6">ÂëºÂê∏„ÅØ„ÅÇ„Çä„Åæ„Åô„ÅãÔºü</h2>
          <div className="flex gap-4">
            <button
              onClick={() => handleAnswer('has_respiration', true)}
              className="flex-1 bg-green-500 text-white py-12 rounded-lg text-2xl font-bold hover:bg-green-600"
            >
              „ÅÇ„Çä
            </button>
            <button
              onClick={() => handleAnswer('has_respiration', false)}
              className="flex-1 bg-black text-white py-12 rounded-lg text-2xl font-bold hover:bg-gray-800"
            >
              „Å™„Åó
            </button>
          </div>
        </div>
      )}

      {/* „Çπ„ÉÜ„ÉÉ„Éó3: ÂëºÂê∏Êï∞ */}
      {step === 3 && (
        <div>
          <h2 className="text-2xl font-bold mb-6">ÂëºÂê∏Êï∞„ÅÆÁØÑÂõ≤„ÅØÔºü</h2>
          <div className="grid grid-cols-2 gap-4">
            <button
              onClick={() => handleAnswer('respiratory_rate_range', '<10')}
              className="bg-red-500 text-white py-8 rounded-lg text-xl font-bold hover:bg-red-600"
            >
              10Âõû/ÂàÜÊú™Ê∫Ä
            </button>
            <button
              onClick={() => handleAnswer('respiratory_rate_range', '10-29')}
              className="bg-green-500 text-white py-8 rounded-lg text-xl font-bold hover:bg-green-600"
            >
              10„Äú29Âõû/ÂàÜ
            </button>
            <button
              onClick={() => handleAnswer('respiratory_rate_range', '>=30')}
              className="bg-red-500 text-white py-8 rounded-lg text-xl font-bold hover:bg-red-600"
            >
              30Âõû/ÂàÜ‰ª•‰∏ä
            </button>
            <button
              onClick={() => handleAnswer('respiratory_rate_range', '0')}
              className="bg-black text-white py-8 rounded-lg text-xl font-bold hover:bg-gray-800"
            >
              ÁÑ°ÂëºÂê∏
            </button>
          </div>
        </div>
      )}

      {/* „Çπ„ÉÜ„ÉÉ„Éó4: Ê©àÈ™®ÂãïËÑà */}
      {step === 4 && (
        <div>
          <h2 className="text-2xl font-bold mb-6">Ê©àÈ™®ÂãïËÑà„ÅØËß¶Áü•„Åß„Åç„Åæ„Åô„ÅãÔºü</h2>
          <div className="flex gap-4">
            <button
              onClick={() => handleAnswer('radial_pulse', true)}
              className="flex-1 bg-green-500 text-white py-12 rounded-lg text-2xl font-bold hover:bg-green-600"
            >
              Ëß¶Áü•ÂèØËÉΩ
            </button>
            <button
              onClick={() => handleAnswer('radial_pulse', false)}
              className="flex-1 bg-red-500 text-white py-12 rounded-lg text-2xl font-bold hover:bg-red-600"
            >
              Ëß¶Áü•‰∏çÂèØ
            </button>
          </div>
        </div>
      )}

      {/* „Çπ„ÉÜ„ÉÉ„Éó5: ÊÑèË≠ò„É¨„Éô„É´ */}
      {step === 5 && (
        <div>
          <h2 className="text-2xl font-bold mb-6">Á∞°Âçò„Å™ÊåáÁ§∫„Å´Âæì„Åà„Åæ„Åô„ÅãÔºü</h2>
          <div className="flex gap-4">
            <button
              onClick={() => handleAnswer('follows_commands', true)}
              className="flex-1 bg-yellow-500 text-white py-12 rounded-lg text-2xl font-bold hover:bg-yellow-600"
            >
              Âæì„Åà„Çã
            </button>
            <button
              onClick={() => handleAnswer('follows_commands', false)}
              className="flex-1 bg-red-500 text-white py-12 rounded-lg text-2xl font-bold hover:bg-red-600"
            >
              Âæì„Åà„Å™„ÅÑ
            </button>
          </div>
        </div>
      )}
    </div>
  )
}
```

---

### 2.9 Èü≥Â£∞ÂÖ•Âäõ„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà

```typescript
// app/components/VoiceInput.tsx
'use client'

import { useState, useRef } from 'react'

interface VoiceInputProps {
  onTranscript: (text: string) => void
}

export function VoiceInput({ onTranscript }: VoiceInputProps) {
  const [isRecording, setIsRecording] = useState(false)
  const [transcript, setTranscript] = useState('')
  const recognitionRef = useRef<any>(null)

  const startRecording = () => {
    if (!('webkitSpeechRecognition' in window)) {
      alert('Èü≥Â£∞Ë™çË≠ò„ÅØÊú™ÂØæÂøú„ÅÆ„Éñ„É©„Ç¶„Ç∂„Åß„Åô')
      return
    }

    const SpeechRecognition = (window as any).webkitSpeechRecognition
    recognitionRef.current = new SpeechRecognition()

    recognitionRef.current.lang = 'ja-JP'
    recognitionRef.current.continuous = true
    recognitionRef.current.interimResults = true

    recognitionRef.current.onresult = (event: any) => {
      let interimTranscript = ''
      let finalTranscript = ''

      for (let i = event.resultIndex; i < event.results.length; i++) {
        const transcript = event.results[i][0].transcript
        if (event.results[i].isFinal) {
          finalTranscript += transcript
        } else {
          interimTranscript += transcript
        }
      }

      setTranscript(finalTranscript + interimTranscript)
    }

    recognitionRef.current.onerror = (event: any) => {
      console.error('Speech recognition error:', event.error)
      setIsRecording(false)
    }

    recognitionRef.current.start()
    setIsRecording(true)
  }

  const stopRecording = () => {
    if (recognitionRef.current) {
      recognitionRef.current.stop()
      setIsRecording(false)
    }
  }

  const handleConfirm = () => {
    onTranscript(transcript)
    setTranscript('')
  }

  return (
    <div className="bg-gray-100 rounded-lg p-4">
      <button
        onMouseDown={startRecording}
        onMouseUp={stopRecording}
        onTouchStart={startRecording}
        onTouchEnd={stopRecording}
        className={`w-full py-8 rounded-lg text-xl font-bold transition-all ${
          isRecording
            ? 'bg-red-500 text-white animate-pulse scale-105'
            : 'bg-blue-500 text-white hover:bg-blue-600'
        }`}
      >
        {isRecording ? 'üé§ Èå≤Èü≥‰∏≠... (Èõ¢„Åô„Å®ÂÅúÊ≠¢)' : 'üé§ Èï∑Êäº„Åó„Åó„Å¶Ë©±„Åô'}
      </button>

      {transcript && (
        <div className="mt-4 bg-white p-4 rounded-lg">
          <p className="text-sm text-gray-500 mb-2">Èü≥Â£∞Ë™çË≠òÁµêÊûú:</p>
          <p className="text-lg mb-4">{transcript}</p>

          <div className="flex gap-2">
            <button
              onClick={handleConfirm}
              className="flex-1 bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600"
            >
              Á¢∫ÂÆö
            </button>
            <button
              onClick={() => setTranscript('')}
              className="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400"
            >
              „ÇØ„É™„Ç¢
            </button>
          </div>
        </div>
      )}
    </div>
  )
}
```

---

### 2.10 ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„ÉÄ„Éº

```typescript
// app/components/ImageUploader.tsx
'use client'

import { useState } from 'react'
import { createClient } from '@/lib/supabase/client'

interface ImageUploaderProps {
  tagId: string
  onUploadComplete: (urls: string[]) => void
}

export function ImageUploader({ tagId, onUploadComplete }: ImageUploaderProps) {
  const [uploading, setUploading] = useState(false)
  const [progress, setProgress] = useState(0)
  const supabase = createClient()

  const compressImage = async (file: File): Promise<Blob> => {
    return new Promise((resolve) => {
      const reader = new FileReader()
      reader.readAsDataURL(file)
      reader.onload = (event) => {
        const img = new Image()
        img.src = event.target?.result as string
        img.onload = () => {
          const canvas = document.createElement('canvas')
          let width = img.width
          let height = img.height

          // 1920px‰ª•‰∏ã„Å´„É™„Çµ„Ç§„Ç∫
          const maxSize = 1920
          if (width > height && width > maxSize) {
            height *= maxSize / width
            width = maxSize
          } else if (height > maxSize) {
            width *= maxSize / height
            height = maxSize
          }

          canvas.width = width
          canvas.height = height

          const ctx = canvas.getContext('2d')!
          ctx.drawImage(img, 0, 0, width, height)

          canvas.toBlob(
            (blob) => {
              resolve(blob!)
            },
            'image/jpeg',
            0.8
          )
        }
      }
    })
  }

  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = Array.from(e.target.files || [])
    if (files.length === 0) return

    setUploading(true)
    const uploadedUrls: string[] = []

    for (let i = 0; i < Math.min(files.length, 5); i++) {
      const file = files[i]
      setProgress(((i + 0.5) / files.length) * 100)

      // ÂúßÁ∏Æ
      const compressedBlob = await compressImage(file)

      // Supabase Storage„Å´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
      const fileName = `${tagId}/${Date.now()}_${i}.jpg`
      const { data, error } = await supabase.storage
        .from('triage-images')
        .upload(fileName, compressedBlob, {
          cacheControl: '3600',
          upsert: false
        })

      if (error) {
        console.error('Upload error:', error)
        continue
      }

      // ÂÖ¨ÈñãURLÂèñÂæó
      const {
        data: { publicUrl }
      } = supabase.storage.from('triage-images').getPublicUrl(fileName)

      uploadedUrls.push(publicUrl)
      setProgress(((i + 1) / files.length) * 100)
    }

    setUploading(false)
    setProgress(0)
    onUploadComplete(uploadedUrls)
  }

  return (
    <div>
      <input
        type="file"
        accept="image/*"
        multiple
        capture="environment"
        onChange={handleFileChange}
        disabled={uploading}
        className="hidden"
        id="image-upload"
      />

      <label
        htmlFor="image-upload"
        className={`block w-full py-6 text-center rounded-lg border-2 border-dashed ${
          uploading
            ? 'border-gray-300 bg-gray-100 cursor-not-allowed'
            : 'border-blue-500 bg-blue-50 cursor-pointer hover:bg-blue-100'
        }`}
      >
        {uploading ? (
          <div>
            <p className="text-lg font-semibold">„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ‰∏≠...</p>
            <div className="w-full bg-gray-200 rounded-full h-3 mt-3 mx-auto max-w-xs">
              <div
                className="bg-blue-500 h-3 rounded-full transition-all"
                style={{ width: `${progress}%` }}
              />
            </div>
            <p className="text-sm text-gray-500 mt-2">{Math.round(progress)}%</p>
          </div>
        ) : (
          <div>
            <p className="text-xl font-semibold">üì∑ ÂÜôÁúü„ÇíÊíÆÂΩ±/ÈÅ∏Êäû</p>
            <p className="text-sm text-gray-500 mt-1">ÊúÄÂ§ß5Êûö„Åæ„Åß</p>
          </div>
        )}
      </label>
    </div>
  )
}
```

---

### 2.11 „Ç™„Éï„É©„Ç§„É≥ÂØæÂøúÔºàIndexedDB + ÂçòÁ¥îÂêåÊúüÔºâ

**IndexedDB„É©„ÉÉ„Éë„Éº**
```typescript
// lib/offline/indexeddb.ts
import { openDB, DBSchema, IDBPDatabase } from 'idb'
import { TriageTag } from '@/lib/types'

interface TriageDB extends DBSchema {
  tags: {
    key: string
    value: TriageTag & { _pending: boolean; _timestamp: number }
  }
  syncQueue: {
    key: number
    value: {
      operation: 'create' | 'update'
      tagId: string
      data: Partial<TriageTag>
      timestamp: number
    }
  }
}

let db: IDBPDatabase<TriageDB>

export async function initDB() {
  if (db) return db

  db = await openDB<TriageDB>('triage-system', 1, {
    upgrade(db) {
      // „Éà„É™„Ç¢„Éº„Ç∏„Çø„Ç∞„Çπ„Éà„Ç¢
      if (!db.objectStoreNames.contains('tags')) {
        db.createObjectStore('tags', { keyPath: 'id' })
      }

      // ÂêåÊúü„Ç≠„É•„Éº„Çπ„Éà„Ç¢
      if (!db.objectStoreNames.contains('syncQueue')) {
        const store = db.createObjectStore('syncQueue', {
          keyPath: 'timestamp',
          autoIncrement: true
        })
        store.createIndex('by-timestamp', 'timestamp')
      }
    }
  })

  return db
}

export async function saveTagOffline(tag: TriageTag) {
  const db = await initDB()
  await db.put('tags', {
    ...tag,
    _pending: true,
    _timestamp: Date.now()
  })
}

export async function getTagOffline(id: string) {
  const db = await initDB()
  return await db.get('tags', id)
}

export async function getAllTagsOffline() {
  const db = await initDB()
  return await db.getAll('tags')
}

export async function addToSyncQueue(
  operation: 'create' | 'update',
  tagId: string,
  data: Partial<TriageTag>
) {
  const db = await initDB()
  await db.add('syncQueue', {
    operation,
    tagId,
    data,
    timestamp: Date.now()
  })
}

export async function getSyncQueue() {
  const db = await initDB()
  return await db.getAll('syncQueue')
}

export async function clearSyncQueue() {
  const db = await initDB()
  await db.clear('syncQueue')
}
```

**ÂêåÊúü„Éû„Éç„Éº„Ç∏„É£„Éº**
```typescript
// lib/offline/sync-manager.ts
import { createClient } from '@/lib/supabase/client'
import { getSyncQueue, clearSyncQueue, getAllTagsOffline } from './indexeddb'

export async function syncOfflineData() {
  if (!navigator.onLine) {
    throw new Error('„Ç™„Éï„É©„Ç§„É≥‰∏≠„ÅÆ„Åü„ÇÅÂêåÊúü„Åß„Åç„Åæ„Åõ„Çì')
  }

  const supabase = createClient()
  const queue = await getSyncQueue()

  if (queue.length === 0) {
    console.log('ÂêåÊúü„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì')
    return
  }

  console.log(`${queue.length}‰ª∂„ÅÆ„Éá„Éº„Çø„ÇíÂêåÊúü‰∏≠...`)

  for (const item of queue) {
    try {
      if (item.operation === 'create') {
        // Êñ∞Ë¶è‰ΩúÊàê
        const { error } = await supabase.from('triage_tags').insert(item.data as any)

        if (error) throw error
      } else if (item.operation === 'update') {
        // Êõ¥Êñ∞ÔºàÁ´∂ÂêàËß£Ê±∫: „Çµ„Éº„Éê„ÉºÂãù„Å°Ôºâ
        const { data: serverData, error: fetchError } = await supabase
          .from('triage_tags')
          .select('updated_at')
          .eq('id', item.tagId)
          .single()

        if (fetchError) throw fetchError

        // „Çµ„Éº„Éê„Éº„ÅÆÊõ¥Êñ∞ÊôÇÂàª„ÅåÊñ∞„Åó„ÅÑÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
        const serverUpdatedAt = new Date(serverData.updated_at).getTime()
        if (serverUpdatedAt > item.timestamp) {
          console.log(`„Çπ„Ç≠„ÉÉ„ÉóÔºà„Çµ„Éº„Éê„ÉºÂÑ™ÂÖàÔºâ: ${item.tagId}`)
          continue
        }

        // Êõ¥Êñ∞ÂÆüË°å
        const { error } = await supabase
          .from('triage_tags')
          .update(item.data)
          .eq('id', item.tagId)

        if (error) throw error
      }

      console.log(`ÂêåÊúüÊàêÂäü: ${item.operation} ${item.tagId}`)
    } catch (err) {
      console.error(`ÂêåÊúüÂ§±Êïó: ${item.operation} ${item.tagId}`, err)
      throw err
    }
  }

  // ÂêåÊúü„Ç≠„É•„Éº„Çí„ÇØ„É™„Ç¢
  await clearSyncQueue()
  console.log('ÂêåÊúüÂÆå‰∫Ü')
}

// Ëá™ÂãïÂêåÊúüÔºà30Áßí„Åî„Å®Ôºâ
export function startAutoSync() {
  const interval = setInterval(async () => {
    if (navigator.onLine) {
      try {
        await syncOfflineData()
      } catch (err) {
        console.error('Ëá™ÂãïÂêåÊúü„Ç®„É©„Éº:', err)
      }
    }
  }, 30000) // 30Áßí

  return () => clearInterval(interval)
}
```

**„Ç™„Éï„É©„Ç§„É≥„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº**
```typescript
// app/components/OfflineIndicator.tsx
'use client'

import { useEffect, useState } from 'react'
import { syncOfflineData } from '@/lib/offline/sync-manager'

export function OfflineIndicator() {
  const [isOnline, setIsOnline] = useState(true)
  const [isSyncing, setIsSyncing] = useState(false)

  useEffect(() => {
    const handleOnline = async () => {
      setIsOnline(true)
      setIsSyncing(true)
      try {
        await syncOfflineData()
      } catch (err) {
        console.error('ÂêåÊúü„Ç®„É©„Éº:', err)
      } finally {
        setIsSyncing(false)
      }
    }

    const handleOffline = () => {
      setIsOnline(false)
    }

    setIsOnline(navigator.onLine)

    window.addEventListener('online', handleOnline)
    window.addEventListener('offline', handleOffline)

    return () => {
      window.removeEventListener('online', handleOnline)
      window.removeEventListener('offline', handleOffline)
    }
  }, [])

  const handleManualSync = async () => {
    setIsSyncing(true)
    try {
      await syncOfflineData()
      alert('ÂêåÊúü„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü')
    } catch (err: any) {
      alert(`ÂêåÊúü„Ç®„É©„Éº: ${err.message}`)
    } finally {
      setIsSyncing(false)
    }
  }

  if (isOnline && !isSyncing) {
    return null
  }

  return (
    <div className="fixed bottom-4 right-4 z-50">
      {!isOnline && (
        <div className="bg-yellow-500 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3">
          <span className="text-2xl">‚ö†Ô∏è</span>
          <div>
            <p className="font-bold">„Ç™„Éï„É©„Ç§„É≥„É¢„Éº„Éâ</p>
            <p className="text-sm">„Éá„Éº„Çø„ÅØ„É≠„Éº„Ç´„É´„Å´‰øùÂ≠ò„Åï„Çå„Åæ„Åô</p>
          </div>
        </div>
      )}

      {isSyncing && (
        <div className="bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3">
          <div className="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full" />
          <p className="font-bold">ÂêåÊúü‰∏≠...</p>
        </div>
      )}

      {isOnline && !isSyncing && (
        <button
          onClick={handleManualSync}
          className="bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-green-600"
        >
          üîÑ ÊâãÂãïÂêåÊúü
        </button>
      )}
    </div>
  )
}
```

---

### 2.12 Âú∞Âõ≥Ë°®Á§∫ÔºàLeaflet.jsÔºâ

```typescript
// app/components/MapView.tsx
'use client'

import { useEffect, useRef } from 'react'
import L from 'leaflet'
import 'leaflet/dist/leaflet.css'
import { TriageTag } from '@/lib/types'

// Leaflet„Ç¢„Ç§„Ç≥„É≥‰øÆÊ≠£ÔºàNext.jsÂØæÂøúÔºâ
delete (L.Icon.Default.prototype as any)._getIconUrl
L.Icon.Default.mergeOptions({
  iconRetinaUrl: '/leaflet/marker-icon-2x.png',
  iconUrl: '/leaflet/marker-icon.png',
  shadowUrl: '/leaflet/marker-shadow.png'
})

interface MapViewProps {
  triageTags: TriageTag[]
  center?: [number, number]
  zoom?: number
}

export function MapView({ triageTags, center = [35.6812, 139.7671], zoom = 14 }: MapViewProps) {
  const mapRef = useRef<L.Map | null>(null)
  const markersRef = useRef<L.Marker[]>([])

  useEffect(() => {
    if (!mapRef.current) {
      // Âú∞Âõ≥ÂàùÊúüÂåñ
      mapRef.current = L.map('map').setView(center, zoom)

      // OpenStreetMap„Çø„Ç§„É´
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(mapRef.current)
    }

    return () => {
      mapRef.current?.remove()
      mapRef.current = null
    }
  }, [])

  useEffect(() => {
    if (!mapRef.current) return

    // Êó¢Â≠ò„Éû„Éº„Ç´„ÉºÂâäÈô§
    markersRef.current.forEach((m) => m.remove())
    markersRef.current = []

    // Êñ∞Ë¶è„Éû„Éº„Ç´„ÉºËøΩÂä†
    triageTags.forEach((tag) => {
      const colorMap = {
        red: 'red',
        yellow: 'gold',
        green: 'green',
        black: 'black'
      }

      const icon = L.divIcon({
        className: 'custom-marker',
        html: `<div style="
          width: 30px;
          height: 30px;
          background-color: ${colorMap[tag.triage_category.final]};
          border: 3px solid white;
          border-radius: 50%;
          box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        "></div>`,
        iconSize: [30, 30],
        iconAnchor: [15, 15]
      })

      const marker = L.marker([tag.location.latitude, tag.location.longitude], { icon })
        .addTo(mapRef.current!)
        .bindPopup(
          `
          <div class="p-2">
            <h3 class="font-bold">${tag.tag_number}</h3>
            <p>Âå∫ÂàÜ: <strong>${tag.triage_category.final}</strong></p>
            <p>„Çπ„ÉÜ„Éº„Çø„Çπ: ${tag.transport.status}</p>
          </div>
        `
        )

      markersRef.current.push(marker)
    })
  }, [triageTags])

  return <div id="map" className="w-full h-full" />
}
```

**Leaflet.jsËøΩÂä†Ë®≠ÂÆö**
```bash
npm install leaflet @types/leaflet
```

```javascript
// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  // „Åù„ÅÆ‰ªñ„ÅÆË®≠ÂÆö
}

const withPWA = require('next-pwa')({
  dest: 'public',
  register: true,
  skipWaiting: true,
  disable: process.env.NODE_ENV === 'development'
})

module.exports = withPWA(nextConfig)
```

---

### 2.13 ÊåáÊèÆÊú¨ÈÉ®„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ

```typescript
// app/(dashboard)/command/page.tsx
import { createClient } from '@/lib/supabase/server'
import { MapView } from '@/app/components/MapView'
import { ListView } from './components/ListView'
import { StatsPanel } from './components/StatsPanel'

export default async function CommandDashboard() {
  const supabase = createClient()

  // „Éà„É™„Ç¢„Éº„Ç∏„Çø„Ç∞ÂèñÂæó
  const { data: tags } = await supabase
    .from('triage_tags')
    .select('*')
    .order('created_at', { ascending: false })

  return (
    <div className="h-screen flex flex-col">
      {/* „Éò„ÉÉ„ÉÄ„Éº */}
      <header className="bg-blue-600 text-white p-4">
        <h1 className="text-2xl font-bold">ÊåáÊèÆÊú¨ÈÉ®„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</h1>
      </header>

      {/* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ */}
      <div className="flex-1 flex overflow-hidden">
        {/* „Éû„ÉÉ„Éó„Éì„É•„ÉºÔºàÂ∑¶Ôºâ */}
        <div className="w-1/2 border-r">
          <MapView triageTags={tags || []} />
        </div>

        {/* „É™„Çπ„Éà + Áµ±Ë®àÔºàÂè≥Ôºâ */}
        <div className="w-1/2 flex flex-col">
          {/* Áµ±Ë®à„Éë„Éç„É´ */}
          <div className="h-1/3 border-b overflow-auto">
            <StatsPanel tags={tags || []} />
          </div>

          {/* „É™„Çπ„Éà„Éì„É•„Éº */}
          <div className="flex-1 overflow-auto">
            <ListView tags={tags || []} />
          </div>
        </div>
      </div>
    </div>
  )
}
```

**Áµ±Ë®à„Éë„Éç„É´**
```typescript
// app/(dashboard)/command/components/StatsPanel.tsx
import { TriageTag } from '@/lib/types'

interface StatsPanelProps {
  tags: TriageTag[]
}

export function StatsPanel({ tags }: StatsPanelProps) {
  const stats = {
    total: tags.length,
    red: tags.filter((t) => t.triage_category.final === 'red').length,
    yellow: tags.filter((t) => t.triage_category.final === 'yellow').length,
    green: tags.filter((t) => t.triage_category.final === 'green').length,
    black: tags.filter((t) => t.triage_category.final === 'black').length,
    not_transported: tags.filter((t) => t.transport.status === 'not_transported').length,
    in_transit: tags.filter((t) => t.transport.status === 'in_transit').length,
    arrived: tags.filter((t) => t.transport.status === 'arrived').length
  }

  return (
    <div className="p-4 grid grid-cols-4 gap-4">
      {/* „Éà„É™„Ç¢„Éº„Ç∏Âå∫ÂàÜÁµ±Ë®à */}
      <div className="bg-red-100 p-4 rounded-lg">
        <p className="text-sm text-gray-600">Ëµ§ÔºàÊúÄÂÑ™ÂÖàÔºâ</p>
        <p className="text-3xl font-bold text-red-600">{stats.red}</p>
      </div>
      <div className="bg-yellow-100 p-4 rounded-lg">
        <p className="text-sm text-gray-600">ÈªÑÔºàÈùûÁ∑äÊÄ•Ôºâ</p>
        <p className="text-3xl font-bold text-yellow-600">{stats.yellow}</p>
      </div>
      <div className="bg-green-100 p-4 rounded-lg">
        <p className="text-sm text-gray-600">Á∑ëÔºàËªΩÂÇ∑Ôºâ</p>
        <p className="text-3xl font-bold text-green-600">{stats.green}</p>
      </div>
      <div className="bg-gray-100 p-4 rounded-lg">
        <p className="text-sm text-gray-600">ÈªíÔºà‰∏çÂá¶ÁΩÆÔºâ</p>
        <p className="text-3xl font-bold text-gray-600">{stats.black}</p>
      </div>

      {/* Êê¨ÈÄÅ„Çπ„ÉÜ„Éº„Çø„ÇπÁµ±Ë®à */}
      <div className="bg-blue-100 p-4 rounded-lg col-span-2">
        <p className="text-sm text-gray-600">Êú™Êê¨ÈÄÅ</p>
        <p className="text-3xl font-bold text-blue-600">{stats.not_transported}</p>
      </div>
      <div className="bg-indigo-100 p-4 rounded-lg">
        <p className="text-sm text-gray-600">Êê¨ÈÄÅ‰∏≠</p>
        <p className="text-3xl font-bold text-indigo-600">{stats.in_transit}</p>
      </div>
      <div className="bg-purple-100 p-4 rounded-lg">
        <p className="text-sm text-gray-600">Âà∞ÁùÄÊ∏à</p>
        <p className="text-3xl font-bold text-purple-600">{stats.arrived}</p>
      </div>
    </div>
  )
}
```

**„É™„Çπ„Éà„Éì„É•„Éº**
```typescript
// app/(dashboard)/command/components/ListView.tsx
'use client'

import { TriageTag } from '@/lib/types'
import { useMemo } from 'react'

interface ListViewProps {
  tags: TriageTag[]
}

export function ListView({ tags }: ListViewProps) {
  // ÂÑ™ÂÖàÂ∫¶È†Ü„Å´„ÇΩ„Éº„Éà
  const sortedTags = useMemo(() => {
    return [...tags].sort((a, b) => {
      // ÂÑ™ÂÖàÂ∫¶: Ëµ§ > ÈªÑ > Á∑ë > Èªí
      const priorityMap = { red: 0, yellow: 1, green: 2, black: 3 }
      const aPriority = priorityMap[a.triage_category.final]
      const bPriority = priorityMap[b.triage_category.final]

      if (aPriority !== bPriority) {
        return aPriority - bPriority
      }

      // Êú™Êê¨ÈÄÅ„ÇíÂÑ™ÂÖà
      if (a.transport.status === 'not_transported' && b.transport.status !== 'not_transported') {
        return -1
      }
      if (a.transport.status !== 'not_transported' && b.transport.status === 'not_transported') {
        return 1
      }

      // ÁôªÈå≤ÊôÇÂàª„ÅåÂè§„ÅÑÈ†Ü
      return new Date(a.created_at).getTime() - new Date(b.created_at).getTime()
    })
  }, [tags])

  return (
    <div className="overflow-auto">
      <table className="w-full">
        <thead className="bg-gray-100 sticky top-0">
          <tr>
            <th className="p-3 text-left">Âå∫ÂàÜ</th>
            <th className="p-3 text-left">„Çø„Ç∞No.</th>
            <th className="p-3 text-left">‰ΩçÁΩÆ</th>
            <th className="p-3 text-left">„Éê„Ç§„Çø„É´</th>
            <th className="p-3 text-left">„Çπ„ÉÜ„Éº„Çø„Çπ</th>
            <th className="p-3 text-left">Êìç‰Ωú</th>
          </tr>
        </thead>
        <tbody>
          {sortedTags.slice(0, 50).map((tag, index) => (
            <tr
              key={tag.id}
              className={`border-b hover:bg-gray-50 ${
                index < 10 &&
                tag.triage_category.final === 'red' &&
                tag.transport.status === 'not_transported'
                  ? 'bg-red-50 font-semibold'
                  : ''
              }`}
            >
              <td className="p-3">
                <span
                  className={`inline-block w-8 h-8 rounded-full ${
                    tag.triage_category.final === 'red'
                      ? 'bg-red-500'
                      : tag.triage_category.final === 'yellow'
                        ? 'bg-yellow-500'
                        : tag.triage_category.final === 'green'
                          ? 'bg-green-500'
                          : 'bg-black'
                  }`}
                />
              </td>
              <td className="p-3">{tag.tag_number}</td>
              <td className="p-3 text-sm text-gray-600">
                {tag.location.area_grid ||
                  `${tag.location.latitude.toFixed(4)}, ${tag.location.longitude.toFixed(4)}`}
              </td>
              <td className="p-3 text-sm">
                <div>ÂëºÂê∏: {tag.vital_signs.respiratory_rate || '-'}/ÂàÜ</div>
                <div>SpO‚ÇÇ: {tag.vital_signs.spo2 || '-'}%</div>
              </td>
              <td className="p-3">
                <span
                  className={`px-2 py-1 rounded text-sm ${
                    tag.transport.status === 'not_transported'
                      ? 'bg-gray-200'
                      : tag.transport.status === 'in_transit'
                        ? 'bg-blue-100'
                        : 'bg-green-100'
                  }`}
                >
                  {tag.transport.status === 'not_transported'
                    ? 'Êú™Êê¨ÈÄÅ'
                    : tag.transport.status === 'in_transit'
                      ? 'Êê¨ÈÄÅ‰∏≠'
                      : 'Âà∞ÁùÄÊ∏à'}
                </span>
              </td>
              <td className="p-3">
                {tag.transport.status === 'not_transported' && (
                  <button className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Êê¨ÈÄÅÊåáÁ§∫
                  </button>
                )}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  )
}
```

---

### 2.14 API RoutesÔºàÂÆåÂÖ®ÁâàÔºâ

**„Éà„É™„Ç¢„Éº„Ç∏„Çø„Ç∞API**
```typescript
// app/api/tags/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'
import { createTriageTagSchema } from '@/lib/validation/schemas'

export async function GET(request: NextRequest) {
  const supabase = createClient()

  const { data, error } = await supabase
    .from('triage_tags')
    .select('*')
    .order('created_at', { ascending: false })

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 500 })
  }

  return NextResponse.json({ data })
}

export async function POST(request: NextRequest) {
  const supabase = createClient()
  const body = await request.json()

  // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥
  const result = createTriageTagSchema.safeParse(body)
  if (!result.success) {
    return NextResponse.json({ error: result.error.errors }, { status: 400 })
  }

  // ÂåøÂêçID„ÇíÁîüÊàêÔºàÊ∞èÂêç„ÅÆ„Éè„ÉÉ„Ç∑„É•Ôºâ
  const anonymousId = await crypto.subtle
    .digest('SHA-256', new TextEncoder().encode(body.tag_number + Date.now()))
    .then((buf) =>
      Array.from(new Uint8Array(buf))
        .map((b) => b.toString(16).padStart(2, '0'))
        .join('')
    )

  // AI„Å´„Çà„Çã„Éà„É™„Ç¢„Éº„Ç∏ÊèêÊ°àÔºà„É´„Éº„É´„Éô„Éº„Çπ - MVPÁâàÔºâ
  const aiSuggestion = suggestTriageCategory(body.vital_signs, body.triage_category.start_steps)

  // Áõ£ÊüªÊÉÖÂ†±
  const {
    data: { user }
  } = await supabase.auth.getUser()

  const tagData = {
    ...body,
    anonymous_id: anonymousId,
    triage_category: {
      ...body.triage_category,
      ai_suggested: aiSuggestion.category,
      ai_confidence: aiSuggestion.confidence,
      ai_reasoning: aiSuggestion.reasoning,
      final_decided_by: user?.id || 'unknown',
      final_decided_at: new Date().toISOString()
    },
    audit: {
      created_by: user?.id || 'unknown',
      created_at: new Date().toISOString(),
      created_device_id: request.headers.get('user-agent') || 'unknown',
      updated_by: user?.id || 'unknown',
      updated_at: new Date().toISOString(),
      updated_device_id: request.headers.get('user-agent') || 'unknown',
      version: 1,
      revision_history: []
    }
  }

  const { data, error } = await supabase.from('triage_tags').insert(tagData).select().single()

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 500 })
  }

  return NextResponse.json({ data }, { status: 201 })
}

// AI„Éà„É™„Ç¢„Éº„Ç∏ÊèêÊ°àÔºà„É´„Éº„É´„Éô„Éº„ÇπÔºâ
function suggestTriageCategory(vitalSigns: any, startSteps: any) {
  let category: 'black' | 'red' | 'yellow' | 'green' = 'green'
  let confidence = 1.0
  let reasons: string[] = []

  // STARTÊ≥ï„É≠„Ç∏„ÉÉ„ÇØ
  if (startSteps.can_walk === true) {
    category = 'green'
    reasons.push('Ê≠©Ë°åÂèØËÉΩ')
  } else if (startSteps.has_respiration === false) {
    category = 'black'
    reasons.push('ÂëºÂê∏ÂÅúÊ≠¢')
  } else if (
    startSteps.respiratory_rate_range === '0' ||
    startSteps.respiratory_rate_range === '<10' ||
    startSteps.respiratory_rate_range === '>=30'
  ) {
    category = 'red'
    reasons.push(`ÂëºÂê∏Êï∞Áï∞Â∏∏Ôºà${startSteps.respiratory_rate_range}Ôºâ`)
  } else if (startSteps.radial_pulse === false) {
    category = 'red'
    reasons.push('Ê©àÈ™®ÂãïËÑàËß¶Áü•‰∏çÂèØ')
  } else if (startSteps.follows_commands === false) {
    category = 'red'
    reasons.push('ÊÑèË≠ò„É¨„Éô„É´‰Ωé‰∏ã')
  } else {
    category = 'yellow'
    reasons.push('„Éê„Ç§„Çø„É´ÂÆâÂÆö„ÄÅÂá¶ÁΩÆÈÅÖÂª∂ÂèØËÉΩ')
  }

  // „Éê„Ç§„Çø„É´„Çµ„Ç§„É≥„Å´„Çà„ÇãËøΩÂä†Âà§ÂÆö
  if (vitalSigns.spo2 && vitalSigns.spo2 < 90) {
    category = 'red'
    reasons.push(`‰ΩéÈÖ∏Á¥†ÔºàSpO2:${vitalSigns.spo2}%Ôºâ`)
    confidence = 0.95
  }

  return {
    category,
    confidence,
    reasoning: reasons.join('„ÄÅ') + `„ÅÆ„Åü„ÇÅ${category}Âå∫ÂàÜ„ÇíÊèêÊ°à`
  }
}
```

**ÂÄãÂà•„Çø„Ç∞API**
```typescript
// app/api/tags/[id]/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'
import { updateTriageTagSchema } from '@/lib/validation/schemas'

export async function GET(request: NextRequest, { params }: { params: { id: string } }) {
  const supabase = createClient()

  const { data, error } = await supabase.from('triage_tags').select('*').eq('id', params.id).single()

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 404 })
  }

  return NextResponse.json({ data })
}

export async function PUT(request: NextRequest, { params }: { params: { id: string } }) {
  const supabase = createClient()
  const body = await request.json()

  // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥
  const result = updateTriageTagSchema.safeParse(body)
  if (!result.success) {
    return NextResponse.json({ error: result.error.errors }, { status: 400 })
  }

  // ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„ÉºÂèñÂæó
  const {
    data: { user }
  } = await supabase.auth.getUser()

  // Êõ¥Êñ∞„Éá„Éº„ÇøÊ∫ñÂÇô
  const updateData = {
    ...body,
    updated_at: new Date().toISOString()
  }

  // Áõ£ÊüªÊÉÖÂ†±Êõ¥Êñ∞
  if (body.audit) {
    updateData.audit = {
      ...body.audit,
      updated_by: user?.id || 'unknown',
      updated_at: new Date().toISOString(),
      updated_device_id: request.headers.get('user-agent') || 'unknown',
      version: (body.audit.version || 0) + 1
    }
  }

  const { data, error } = await supabase
    .from('triage_tags')
    .update(updateData)
    .eq('id', params.id)
    .select()
    .single()

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 500 })
  }

  return NextResponse.json({ data })
}
```

---

### 2.15 PWAË®≠ÂÆöÔºànext-pwaÔºâ

```javascript
// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true
}

const withPWA = require('next-pwa')({
  dest: 'public',
  register: true,
  skipWaiting: true,
  disable: process.env.NODE_ENV === 'development',
  runtimeCaching: [
    {
      urlPattern: /^https:\/\/.*\.supabase\.co\/storage\/.*/i,
      handler: 'CacheFirst',
      options: {
        cacheName: 'supabase-images',
        expiration: {
          maxEntries: 100,
          maxAgeSeconds: 7 * 24 * 60 * 60 // 7Êó•
        }
      }
    },
    {
      urlPattern: /^https:\/\/.*\.supabase\.co\/rest\/.*/i,
      handler: 'NetworkFirst',
      options: {
        cacheName: 'supabase-api',
        networkTimeoutSeconds: 10
      }
    },
    {
      urlPattern: /^https:\/\/.*\.tile\.openstreetmap\.org\/.*/i,
      handler: 'CacheFirst',
      options: {
        cacheName: 'map-tiles',
        expiration: {
          maxEntries: 500,
          maxAgeSeconds: 30 * 24 * 60 * 60 // 30Êó•
        }
      }
    }
  ]
})

module.exports = withPWA(nextConfig)
```

```json
// public/manifest.json
{
  "name": "„Éà„É™„Ç¢„Éº„Ç∏„Çø„ÉÉ„Ç∞„Ç∑„Çπ„ÉÜ„É†",
  "short_name": "„Éà„É™„Ç¢„Éº„Ç∏",
  "description": "ÁÅΩÂÆ≥ÊôÇ„Éà„É™„Ç¢„Éº„Ç∏„Çø„ÉÉ„Ç∞ÊÉÖÂ†±ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#2563eb",
  "orientation": "portrait",
  "icons": [
    {
      "src": "/icons/icon-192x192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-512x512.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ]
}
```

---

## üìÖ 3. ÂÆüË£Ö„Çπ„Ç±„Ç∏„É•„Éº„É´ÔºàMVP: 3„É∂ÊúàÔºâ

| ÈÄ± | ÂÆüË£ÖÂÜÖÂÆπ | ÊàêÊûúÁâ© | ÊãÖÂΩì |
|----|---------|--------|------|
| **Week 1-2** | Áí∞Â¢ÉÊßãÁØâ + Ë™çË®º | SupabaseË®≠ÂÆö„ÄÅNext.jsÂàùÊúüÂåñ„ÄÅË™çË®º„Éï„É≠„Éº„ÄÅRLS | Backend |
| **Week 3-4** | QRË™≠Âèñ + Âü∫Êú¨ÂÖ•Âäõ | QR„Çπ„Ç≠„É£„Éä„Éº„ÄÅ„Éà„É™„Ç¢„Éº„Ç∏ÁôªÈå≤„Éï„Ç©„Éº„É†„ÄÅÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ | Frontend |
| **Week 5-6** | STARTÊ≥ï„Ç¶„Ç£„Ç∂„Éº„Éâ | Âà§ÂÆö„É≠„Ç∏„ÉÉ„ÇØ„ÄÅ„Ç¶„Ç£„Ç∂„Éº„ÉâUI„ÄÅAI„É´„Éº„É´„Éô„Éº„ÇπÊèêÊ°à | Frontend + Logic |
| **Week 7-8** | Èü≥Â£∞ÂÖ•Âäõ + ÁîªÂÉèÂúßÁ∏Æ | Web Speech APIÁµ±Âêà„ÄÅÁîªÂÉèÂúßÁ∏Æ„ÄÅSupabase Storage | Frontend |
| **Week 9-10** | Âú∞Âõ≥„Éª‰∏ÄË¶ßË°® | Leaflet.jsÁµ±Âêà„ÄÅ„É™„Çπ„Éà„Éì„É•„Éº„ÄÅ„ÇΩ„Éº„Éà„Éª„Éï„Ç£„É´„Çø | Frontend |
| **Week 11-12** | „Ç™„Éï„É©„Ç§„É≥ + PWA | IndexedDB„ÄÅÂêåÊúü„Éû„Éç„Éº„Ç∏„É£„Éº„ÄÅnext-pwaË®≠ÂÆö | Frontend |
| **Week 12** | PDF/CSVÂá∫Âäõ | Â∏≥Á•®ÁîüÊàêAPI„ÄÅ„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÊ©üËÉΩ | Backend |
| **Week 12** | „ÉÜ„Çπ„Éà + „Éá„Éó„É≠„Ç§ | E2E„ÉÜ„Çπ„Éà„ÄÅÊú¨Áï™Áí∞Â¢É„Éá„Éó„É≠„Ç§ | QA + DevOps |

---

## ‚úÖ 4. Âèó„ÅëÂÖ•„ÇåÂü∫Ê∫ñÔºà„ÉÜ„Çπ„Éà‰ªïÊßòÔºâ

### 4.1 Ê©üËÉΩ„ÉÜ„Çπ„Éà

```typescript
// e2e/triage-workflow.spec.ts
import { test, expect } from '@playwright/test'

test.describe('„Éà„É™„Ç¢„Éº„Ç∏ÁôªÈå≤„Éï„É≠„Éº', () => {
  test('QR„Çπ„Ç≠„É£„É≥‚Üí30ÁßíÁôªÈå≤‚ÜíÁ¢∫Ë™ç', async ({ page }) => {
    await page.goto('/triage/scan')

    const startTime = Date.now()

    // QR„Çπ„Ç≠„É£„É≥Ôºà„É¢„ÉÉ„ÇØÔºâ
    await page.click('[data-testid="qr-scan-button"]')
    await page.waitForSelector('[data-testid="qr-detected"]')

    // ÊúÄÂ∞èÂÖ•Âäõ
    await page.click('[data-testid="category-red"]')
    await page.click('[data-testid="take-photo"]')
    await page.waitForSelector('[data-testid="photo-preview"]')

    // ÁôªÈå≤
    await page.click('[data-testid="submit-triage"]')
    await page.waitForSelector('[data-testid="success-message"]')

    const endTime = Date.now()
    expect(endTime - startTime).toBeLessThan(30000) // 30Áßí‰ª•ÂÜÖ
  })

  test('STARTÊ≥ï„Ç¶„Ç£„Ç∂„Éº„Éâ‚ÜíAIÂà§ÂÆö‰∏ÄËá¥', async ({ page }) => {
    await page.goto('/triage/wizard')

    // Ê≠©Ë°å‰∏çÂèØ
    await page.click('[data-testid="cannot-walk"]')

    // ÂëºÂê∏„ÅÇ„Çä
    await page.click('[data-testid="has-respiration"]')

    // ÂëºÂê∏Êï∞30Âõû/ÂàÜ‰ª•‰∏ä
    await page.click('[data-testid="respiratory-rate-high"]')

    // ÁµêÊûúÁ¢∫Ë™ç
    await expect(page.locator('[data-testid="result-category"]')).toHaveText('Ëµ§')
    await expect(page.locator('[data-testid="result-reasoning"]')).toContain('ÂëºÂê∏Êï∞Áï∞Â∏∏')
  })
})
```

### 4.2 „Ç™„Éï„É©„Ç§„É≥ÂêåÊúü„ÉÜ„Çπ„Éà

```typescript
// e2e/offline-sync.spec.ts
import { test, expect } from '@playwright/test'

test('„Ç™„Éï„É©„Ç§„É≥10‰ª∂ÁôªÈå≤‚ÜíÂêåÊúü', async ({ page, context }) => {
  await page.goto('/triage/scan')

  // „Ç™„Éï„É©„Ç§„É≥„É¢„Éº„Éâ„Å´ÂàáÊõø
  await context.setOffline(true)

  // 10‰ª∂ÁôªÈå≤
  for (let i = 0; i < 10; i++) {
    await page.click('[data-testid="qr-scan"]')
    // ... ÁôªÈå≤Âá¶ÁêÜ
    await page.click('[data-testid="submit"]')
  }

  // „Ç™„É≥„É©„Ç§„É≥Âæ©Â∏∞
  await context.setOffline(false)

  // ÂêåÊúüÂæÖÊ©üÔºàÊúÄÂ§ß5ÂàÜÔºâ
  await page.waitForSelector('[data-testid="sync-complete"]', { timeout: 300000 })

  // „Çµ„Éº„Éê„ÉºÁ¢∫Ë™ç
  const response = await page.request.get('/api/tags')
  const { data } = await response.json()

  expect(data.length).toBeGreaterThanOrEqual(10)
})
```

---

## üöÄ 5. „Éá„Éó„É≠„Ç§ÊâãÈ†Ü

### 5.1 SupabaseË®≠ÂÆö

```bash
# Supabase„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê
# https://supabase.com/dashboard/projects

# .env.local„Å´Áí∞Â¢ÉÂ§âÊï∞Ë®≠ÂÆö
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
```

### 5.2 Vercel„Éá„Éó„É≠„Ç§

```bash
# Vercel CLI„Ç§„É≥„Çπ„Éà„Éº„É´
npm i -g vercel

# „Éá„Éó„É≠„Ç§
vercel --prod

# Áí∞Â¢ÉÂ§âÊï∞Ë®≠ÂÆöÔºàVercel DashboardÔºâ
NEXT_PUBLIC_SUPABASE_URL
NEXT_PUBLIC_SUPABASE_ANON_KEY
```

---

## üìñ 6. Claude Code„Å∏„ÅÆÊúÄÁµÇÊåáÁ§∫

```
# „Éà„É™„Ç¢„Éº„Ç∏„Çø„ÉÉ„Ç∞„Ç∑„Çπ„ÉÜ„É† MVPÂÆüË£ÖÈñãÂßã

„Åì„ÅÆÂÆåÂÖ®‰ªïÊßòÊõ∏ÔºàMVPÊäÄË°ì„Çπ„Çø„ÉÉ„ÇØÊ∫ñÊã†ÁâàÔºâ„Å´Âü∫„Å•„Åç„ÄÅÂÆüË£Ö„ÇíÈñãÂßã„Åó„Åæ„Åô„ÄÇ

## ÊäÄË°ì„Çπ„Çø„ÉÉ„ÇØÔºàÂé≥ÂÆàÔºâ
- Next.js 14 App Router
- React 18 + TypeScript
- Tailwind CSS
- Supabase (PostgreSQL + Auth + Storage)
- next-pwa (Service Worker)
- Playwright + Jest
- Zod
- html5-qrcode
- Leaflet.jsÔºàÂú∞Âõ≥Ôºâ
- IndexedDBÔºà„Ç™„Éï„É©„Ç§„É≥Ôºâ

## ÂÆüË£ÖÈñãÂßã„Ç≥„Éû„É≥„Éâ

```bash
npx create-next-app@latest triage-system --typescript --tailwind --app
cd triage-system
npm install @supabase/supabase-js @supabase/ssr
npm install zod
npm install html5-qrcode
npm install leaflet @types/leaflet react-leaflet
npm install idb
npm install next-pwa
npm install -D @playwright/test
```

## ÊúÄÂàù„ÅÆ„Çø„Çπ„ÇØ

1. SupabaseË®≠ÂÆöÔºàSQL„Çπ„Ç≠„Éº„ÉûÂÆüË°åÔºâ
2. `.env.local`‰ΩúÊàê
3. `lib/supabase/client.ts`Á≠â„ÅÆSupabaseÁµ±Âêà
4. Ë™çË®º„Éö„Éº„Ç∏ÂÆüË£Ö
5. QR„Çπ„Ç≠„É£„Éä„ÉºÂÆüË£Ö
6. STARTÊ≥ï„Ç¶„Ç£„Ç∂„Éº„ÉâÂÆüË£Ö

```

---