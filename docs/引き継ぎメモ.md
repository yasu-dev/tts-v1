# 本番移行ロードマップ

**最終更新日**: 2025年10月5日  
**現在の状況**: 開発環境完成、本番移行準備段階

## 📋 移行ステータス

### ✅ 完了済み
- 基本機能実装（商品管理、在庫管理、検品システム）
- 階層的検品システム・AI品質検査機能
- アクティビティログ・履歴追跡機能
- バーコードスキャン・ロケーション管理
- 2要素認証・JWT認証システム
- リアルタイム通知システム（Socket.io）
- PDF生成機能（出荷ラベル、レポート）
- 動画記録機能（WebRTC対応）
- 機能フラグ管理システム
- E2Eテスト環境（Playwright）

### 🔄 進行中
- eBay連携（基本実装済み、実API連携は未完了）
- FedX配送連携（モック実装、実API連携は未完了）
- 通知システム（UI実装済み、SSE連携は準備中）

### 📋 計画中
- AWS環境移行
- PostgreSQL移行
- 外部サービス実連携
- 決済システム統合

## 🚀 本番移行計画

### Phase 1: インフラ準備（1-2週間）
- AWS環境へ移行（開発環境）
  - 現状のリポジトリには AWS 向けの IaC/デプロイ設定は存在しません。`netlify.toml` はありますが、AWS 用の定義は未整備です。デプロイ先決定後に環境変数セット、ビルド/起動スクリプト、ヘルスチェック、監視（Sentry/Datadog は `config/environments/production.ts` にキー定義あり）を実装する必要あり。

### Phase 2: データベース移行（1週間）
- DB移行（SQLite→PostgreSQL/Supabase）
  - Prisma の `datasource db` は `sqlite` 固定（`prisma/schema.prisma`）。PostgreSQL へ移行するには:
    - `schema.prisma` の `provider: postgresql` と `DATABASE_URL` を切替
    - 既存多数の API が各所で `new PrismaClient()` を生成（例: `app/api/**/route.ts`）。PostgreSQL では接続プール考慮が必要のため、`lib/database.ts` の共有クライアントへ統一するリファクタが必須
    - 本番向け `config/environments/production.ts` は Postgres 前提だが、スキーマ側が SQLite のままという差異があるため、移行計画に「スキーマ切替+移行（migrate）」を明記すべき
  - **マスタデータ・初期ユーザーの準備**：認証実装はDBユーザー・セッション前提（`lib/auth.ts`）。本番でも最低限の管理者/スタッフ/セラーの初期ユーザー、マスタデータは必要。`prisma/seed-master-data.ts` でマスタを、`prisma/seed-with-images.ts` で初期ユーザー作成が可能。
  - **ファイルストレージ移行**：画像・ラベル等のローカルFS依存（`uploads/` や `fs.*`）は S3 へ移行。参照/保存の全箇所をS3クライアントに差し替えること。

### Phase 3: 外部サービス連携（2-3週間）
- **FedX連携**（配送プラン、出荷伝票出力）
  - 現状 `app/api/shipping/fedx/route.ts` はモック/フォールバック実装。実連携は未実装。`Shipment` モデル（追跡番号/キャリア）と `shipping/label/*` ルート（PDF取得/アップロード）はあるため、実装方針は「既存 Shipment を基にFedX API(認証→レート/出荷/ラベル)を段階的に置換」が適切。資格情報は `production.ts` に追加して環境変数管理へ。

- **eBay連携**（出品、取り下げ、購入者決定、配送完了）
  - 現状 `app/api/ebay/listing/route.ts` と `/api/mock/ebay/listing` はDB更新中心の内部処理で、外部 eBay API 呼び出しそのものは未実装。`product-status-flow.drawio`/HTMLにも「アダプター準備中」と記載。
  - 実API連携は `lib/services/adapters/ebay.adapter.ts` を基盤として段階的に実装予定。

- **AI連携**（画質補正・品質検査）
  - `lib/services/config.ts` に `ai.openai` 設定はあるが、実処理は `app/components/features/inspection/PhotoUploader.tsx` でデモ的に扱うのみ。実運用には `/api/ai/...` のサーバー実装（入力バリデーション・署名・サイズ制限等）と、ストレージ（S3など）保存フローが必要。

### Phase 4: 機能拡充（4-6週間）
- **スタッフのセラー管理機能**
  - `app/api/user/staff/route.ts` はありますが、「セラー管理一覧/詳細モーダル」専用のUI・APIは未実装。新規に `app/staff/sellers/page.tsx` と `SellerDetailModal`、対応する `/api/staff/sellers`（検索/ページネーション/詳細）追加が必要。

- **運営通知システム完成**（ベル、一覧、モーダル）
  - 通知APIは `app/api/notifications/route.ts`、`mark-as-read`、`dynamic` があり、UIは `app/components/EnhancedNotificationPanel.tsx` が存在。SSE は「準備中」と明記あり。ヘッダのベルアイコン連携や一覧・モーダルの結線は未完部分があるため、`DashboardLayout` への組込み、SSE本実装が必要。

- **決済システム統合**（サブスク、都度課金）
  - `lib/services/config.ts` に Stripe のキー定義のみ。決済API・Webhookは未実装。サブスク/都度課金向けのAPI・UIは新規実装が必要（顧客/プラン/課金状態の保持は `SystemSetting` または新テーブルを検討）。

- **ラベル出力機能拡張**（納品用/保管用）
  - 既存: 出荷ラベル関連は `/api/shipping/label/*`、商品バーコードは `/api/products/barcode` 系、UI は `app/components/features/BarcodePrintButton.tsx` 等があるものの、「納品用A4」「保管用シール」テンプレートは未実装。要件に沿って:
    - A4/シール用の印刷ビュー（例: `app/labels/product-a4/page.tsx`, `app/labels/product-sticker/page.tsx`）
    - PDF生成（`pdfkit`/`pdfmake` 依存は既存）・ブラウザ印刷両対応
    - バーコードから `ProductDetailModal` へ遷移（現実装の `/api/products/[id]` 既存）

## ⚠️ 本番移行前の重要課題

### セキュリティ・認証
- **認証フォールバックの無効化**
  - `ALLOW_FIXED_AUTH` を本番で false、`app/api/**` の「デモ環境」分岐（認証バイパス/固定ユーザー）を本番では通らないよう統制すること。

### データベース最適化
- **接続管理の統一**
  - `new PrismaClient()` 乱立を `lib/database.ts` 共有クライアントに統一（PostgreSQL運用の安定化）。

### 環境設定
- **設定の一貫性確保**
  - `config/environments/production.ts` と Prisma スキーマの不一致（postgresql/SQLite）解消。マイグレーション手順をドキュメント化。

### 監視・運用
- **監視システム実装**
  - `production.ts` に Sentry/Datadog 定義があるが、実アプリへの組込み（DSN/APIキーの注入、エラーハンドリングの送出）は未確認。採番・PII 配慮も要整理。

- **内部通信の本番対応**
  - API 内部で `http://localhost:*` をfetchする箇所を排除。本番では内部URLやキュー/イベントで代替。

## 🎯 推奨実装順序

### 優先度1: セキュリティ基盤（1週間）
1. **本番ガード設定**（固定認証とデモ分岐の停止）
2. **Prisma クライアント統一**（`lib/database.ts` 共有クライアント）
3. **環境変数の本番設定**

### 優先度2: データベース移行（1週間）
1. **PostgreSQL切替**→マイグレーション→マスタ/初期ユーザーの最小シード
2. **ファイルストレージのS3移行**

### 優先度3: 監視・安定性（1週間）
1. **監視・ログ実装**（Sentry/Datadog）＋ヘルスチェック
2. **内部通信の本番対応**

### 優先度4: 機能拡充（4-6週間）
1. **ラベル出力拡張**（商品A4/シール）とバーコード遷移
2. **通知システム完成**（ベル/一覧/モーダル）を `EnhancedNotificationPanel` ベースで結線、SSE実装
3. **外部サービス連携**：FedX → eBay → AI の順で段階的実装

## 📋 本番環境必須設定

### 環境変数一覧
```env
# データベース
DATABASE_URL="postgresql://..."

# 認証
JWT_SECRET="secure-random-string"
ALLOW_FIXED_AUTH=false

# メール送信
SENDGRID_API_KEY="SG.xxx"
SENDGRID_FROM_EMAIL="noreply@company.com"

# ストレージ
AWS_ACCESS_KEY_ID="AKIA..."
AWS_SECRET_ACCESS_KEY="xxx"
AWS_REGION="ap-northeast-1"
S3_BUCKET_NAME="fbt-production"

# キャッシュ
REDIS_URL="redis://..."

# 監視
SENTRY_DSN="https://..."
DATADOG_API_KEY="xxx"

# 外部連携（段階的実装）
EBAY_APP_ID="xxx"
EBAY_DEV_ID="xxx"
EBAY_CERT_ID="xxx"
FEDX_API_KEY="xxx"
FEDX_SECRET_KEY="xxx"
FEDX_ACCOUNT_NUMBER="xxx"
FEDX_METER_NUMBER="xxx"
OPENAI_API_KEY="sk-xxx"

# 環境設定
NODE_ENV=production
```

## 📚 参考情報

- **技術詳細**: `docs/system-architecture-audit.html` の各テーブルに詳細分析あり
- **実装状況**: `docs/技術スタック一覧.md` に最新の実装状況を記載
- **本番移行**: `docs/production-deployment-guide.md` に詳細な移行手順を記載