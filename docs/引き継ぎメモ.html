<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>引き継ぎメモ - フルフィルメント BY THE WORLD DOOR</title>
  <style>
    :root { color-scheme: light; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", Meiryo, sans-serif; line-height: 1.7; margin: 0; padding: 0; background: #f6f7f9; color: #212529; }
    header { padding: 24px; background: #0b7285; color: #fff; }
    header h1 { margin: 0 0 8px 0; font-size: 22px; }
    header .meta { opacity: .9; font-size: 13px; }
    main { padding: 24px; max-width: 1100px; margin: 0 auto; }
    section { margin: 24px 0; background: #fff; border: 1px solid #dee2e6; border-radius: 8px; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    h2 { font-size: 18px; margin: 0 0 12px 0; color: #0b7285; }
    h3 { font-size: 16px; margin: 18px 0 8px 0; }
    ul { margin-left: 1.2rem; }
    code, .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background: #f1f3f5; border: 1px solid #dee2e6; border-radius: 4px; padding: 0 4px; font-size: 12px; }
    .note { font-size: 13px; color: #495057; }
    .list-tight li { margin: 6px 0; }
  </style>
</head>
<body>
  <header>
    <h1>引き継ぎメモ</h1>
    <div class="meta">本番移行の必須改修/ブロッカー/環境変数/実装順序の要点を集約（監査詳細は <a href="system-architecture-audit.html" style="color:#fff;text-decoration:underline">system-architecture-audit.html</a> 参照）</div>
  </header>
  <main>

    <section>
      <h2>本番移行</h2>
      <h3>AWS環境へ移行（開発環境）</h3>
      <ul class="list-tight">
        <li>AWS向けのIaC/デプロイ設定は未同梱。デプロイ先決定後に環境変数設定・ビルド/起動・ヘルスチェック・監視（Sentry/Datadog）の組込みが必要。</li>
      </ul>
      <h3>DB移行（SQLite → Supabase/PostgreSQL）</h3>
      <ul class="list-tight">
        <li><code>prisma/schema.prisma</code> の <code>provider: sqlite</code> を <code>postgresql</code> へ切替し、<code>DATABASE_URL</code> を設定・マイグレーション実施。</li>
        <li>多数APIでの <code>new PrismaClient()</code> 乱立を <code>lib/database.ts</code> の共有クライアントに統一（接続プール・安定化）。</li>
        <li>本番でも最低限の初期ユーザー/ロール/マスタは必要。<code>prisma/seed-master-data.ts</code> と <code>prisma/seed-with-images.ts</code> を本番用に調整し投入。</li>
        <li>画像/ラベル等のローカルFS依存（<code>uploads/</code> と <code>fs.*</code>）はS3へ移行。参照/保存の全箇所をS3クライアントへ差し替え。</li>
      </ul>
      <h3>FedEx連携（配送プラン/出荷伝票）</h3>
      <ul class="list-tight">
        <li><code>app/api/shipping/fedx/route.ts</code> はモック/フォールバック。資格情報を環境変数化し、レート→出荷→ラベルの順で実APIへ置換。ラベル保存はS3。</li>
      </ul>
      <h3>AI連携（画質補正）</h3>
      <ul class="list-tight">
        <li><code>lib/services/config.ts</code> に設定はあるが、/api 実装は未整備。サイズ制限/署名/S3保存を含むAPIを新設。</li>
      </ul>
      <h3>eBay連携（出品フォーム/出品/取り下げ/購入者決定/配送完了）</h3>
      <ul class="list-tight">
        <li>現状はDB更新中心のモック。カテゴリ/スペック取得、下書き/出品/変更/取り下げ、注文/配送反映を実APIへ置換。</li>
        <li>「出品フォームをAPIで取得」の可否は本リポジトリでは判断不可。要件を「フォーム項目メタデータのAPI取得」に言い換えるのが現実的。</li>
      </ul>
    </section>

    <section>
      <h2>機能拡充</h2>
      <ul class="list-tight">
        <li>スタッフのセラー管理（一覧/詳細モーダル）：<code>/api/staff/sellers</code> 新設、<code>app/staff/sellers/page.tsx</code> とモーダル実装。</li>
        <li>運営からのお知らせ通知（ベル/一覧/モーダル）：既存API結線、SSE（または代替基盤）本実装、<code>DashboardLayout</code> 組込み。</li>
        <li>決済サービス（サブスク/ロボットペイメント）：決済API・Webhook・プラン/課金状態の永続化（新テーブルまたは <code>SystemSetting</code>）。</li>
        <li>ラベル出力（納品A4/保管シール）：印刷ビュー（例 <code>app/labels/*</code>）、PDF/印刷両対応、バーコード→商品詳細モーダル遷移。</li>
      </ul>
    </section>

    <section>
      <h2>本番前のブロッカー/リスク</h2>
      <ul class="list-tight">
        <li>認証フォールバック/デモ分岐の無効化：<code>ALLOW_FIXED_AUTH=false</code>、APIの「デモ環境」分岐を本番で通さない。</li>
        <li>Prismaクライアントの生成統一：<code>lib/database.ts</code> に集約。</li>
        <li>設定一貫性：<code>production.ts</code> と Prisma スキーマのDB種別を統一。移行手順を明文化。</li>
        <li>監視/ログ：Sentry/Datadog 初期化・送出、PII/採番ポリシー整備。</li>
        <li>localhost参照の除去：内部 <code>fetch('http://localhost:...')</code> を排除（内部URL/キュー等に置換）。</li>
      </ul>
      <p class="note">監査の根拠は <a href="system-architecture-audit.html">system-architecture-audit.html</a> と各 drawio を参照。</p>
    </section>

    <section>
      <h2>実装順序（推奨）</h2>
      <ol>
        <li>本番ガード（固定認証とデモ分岐の停止）と Prisma クライアント統一</li>
        <li>Prisma を PostgreSQL（Supabase）へ切替 → マイグレーション → マスタ/初期ユーザーの最小シード</li>
        <li>監視・ログの注入（Sentry/Datadog）＋ヘルスチェック</li>
        <li>ラベル出力（商品A4/シール）とバーコード遷移の実装</li>
        <li>通知（ベル/一覧/モーダル）を既存UIで結線、SSE本実装</li>
        <li>FedEx → eBay → AI の順でモック置換</li>
      </ol>
    </section>

    <section>
      <h2>本番環境用の必須環境変数</h2>
      <ul class="list-tight">
        <li>DB: <code>DATABASE_URL</code></li>
        <li>Auth: <code>JWT_SECRET</code></li>
        <li>メール: <code>SENDGRID_API_KEY</code>, <code>SENDGRID_FROM_EMAIL</code></li>
        <li>ストレージ: <code>AWS_ACCESS_KEY_ID</code>, <code>AWS_SECRET_ACCESS_KEY</code>, <code>AWS_REGION</code>, <code>S3_BUCKET_NAME</code></li>
        <li>キャッシュ: <code>REDIS_URL</code></li>
        <li>監視: <code>SENTRY_DSN</code>, <code>DATADOG_API_KEY</code></li>
        <li>eBay: <code>EBAY_APP_ID</code>, <code>EBAY_DEV_ID</code>, <code>EBAY_CERT_ID</code>（実装時はOAuthクレデンシャル類）</li>
        <li>FedEx: <code>FEDX_API_KEY</code>, <code>FEDX_SECRET_KEY</code>, <code>FEDX_ACCOUNT_NUMBER</code>, <code>FEDX_METER_NUMBER</code>, <code>FEDX_ENVIRONMENT</code>, <code>FEDX_BASE_URL</code></li>
        <li>AI: <code>OPENAI_API_KEY</code></li>
        <li>フラグ: <code>NODE_ENV=production</code>, <code>ALLOW_FIXED_AUTH=false</code></li>
      </ul>
    </section>

  </main>
</body>
</html>



