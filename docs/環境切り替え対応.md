# 環境切り替え対応ドキュメント

**最終更新日**: 2025年10月3日

## 概要

THE WORLD DOORシステムは、開発環境と本番環境で異なるサービスを透過的に切り替えることができるように設計・実装されています。

## 実装済み機能

### 1. eBay API連携 ⚠️ 部分実装
- **開発環境**: 簡易実装（`/api/ebay/*`）
- **本番環境**: 実際のeBay API連携（未実装）
- **切り替え方法**: 環境変数による制御（現在は未使用）
- **実装状況**: カスタムアダプター（`lib/services/adapters/ebay.adapter.ts`）は存在するが、実際のeBay API連携は未完成

### 2. 配送業者API連携 ⚠️ 準備中
- **開発環境**: 簡易実装（`/api/shipping/*`）
- **本番環境**: FedEx、ヤマト運輸、佐川急便API（未実装）
- **切り替え方法**: 環境変数による制御（未実装）
- **実装状況**: FedExアダプター（`lib/services/adapters/fedex.adapter.ts`）は存在するが、実際のAPI連携は未完成

### 3. メール送信 ✅ 実装済み
- **開発環境**: SendGrid（@sendgrid/mail 8.1.3）
- **本番環境**: SendGrid
- **切り替え方法**: 環境変数で API Key を設定
- **実装状況**: メールアダプター（`lib/services/adapters/email.adapter.ts`）で実装、2要素認証メール対応

### 4. ファイルストレージ ⚠️ ローカルのみ実装
- **開発環境**: ローカルファイルシステム（`uploads/`）
- **本番環境**: AWS S3（@aws-sdk/client-s3 3.500.0インストール済みだが未使用）
- **切り替え方法**: 未実装（環境変数も未設定）
- **実装状況**:
  - 画像: ローカルファイルシステムに保存 (`process.cwd()/uploads/`)
  - 動画: モックURL（公開サンプル動画へのリンク）
  - AWS SDK コードは全てコメントアウト
  - **AWSアカウント未設定**

### 5. 認証システム ✅ 実装済み
- **開発環境**: JWT認証（jsonwebtoken 9.0.2）+ 簡易認証モード
- **本番環境**: JWT + 2要素認証（メールベース）
- **切り替え方法**: 環境変数 FIXED_AUTH_ENABLED で簡易認証モードを制御
- **実装状況**:
  - JWT + bcryptjs によるセキュアな認証
  - 2要素認証システム（TwoFactorAuth model）
  - ロールベースアクセス制御（seller/staff/admin）
  - セッション管理（Session model）

### 6. バーコードスキャン ✅ 実装済み
- **開発環境**: キーボードエミュレーション
- **本番環境**: 実機バーコードスキャナー対応
- **実装状況**: 商品バーコード、ロケーションバーコード検索機能

### 7. 動画管理システム ✅ 実装済み
- **開発環境**: ローカルファイル保存
- **本番環境**: S3ストリーミング
- **実装状況**: WebRTC、MediaRecorder API、メタデータ管理

### 8. 決済処理 🗓️ 計画中
- **予定**: Stripe連携
- **現状**: モック実装のみ

## 実装方法

### サービスアダプターパターン

```typescript
// lib/services/adapters/ebay.adapter.ts
export class EbayAdapter {
  async createListing(data: EbayListingData): Promise<EbayListingResponse> {
    const endpoint = getApiEndpoint('ebay', '/listing');
    // 環境に応じてモックまたは実APIを呼び出し
  }
}
```

### 環境変数設定

```env
# .env.local (開発環境)
USE_MOCK_SERVICES=true
NODE_ENV=development

# .env.production (本番環境)
USE_MOCK_SERVICES=false
NODE_ENV=production
EBAY_API_URL=https://api.ebay.com/v1
EBAY_APP_ID=your-app-id
# ... その他の本番環境設定
```

## 新機能追加

### 1. バーコードスキャン対応
- キーボードエミュレーション型スキャナーに対応
- 商品バーコード（JAN/EAN/UPC）とロケーションバーコードの検証
- 自動フォーカスと高速入力検知

### 2. 動画管理システム
- 作業動画のメタデータ管理
- S3連携準備済み（本番環境）
- 検品・梱包・出荷の作業証跡として利用

### 3. 2段階認証（メール認証）
- 環境変数 `TWO_FACTOR_AUTH_ENABLED` で有効/無効切り替え
- 開発環境ではコンソールに認証コード出力
- 本番環境ではSendGrid経由でメール送信

## データベースモデル追加

```prisma
// 動画記録
model VideoRecord {
  id          String   @id @default(cuid())
  productId   String?
  orderId     String?
  type        String   // inspection, packing, shipping, etc.
  fileName    String
  fileUrl     String
  // ...
}

// 2段階認証
model TwoFactorAuth {
  id          String   @id @default(cuid())
  userId      String
  code        String
  expiresAt   DateTime
  verified    Boolean  @default(false)
  // ...
}

// 外部サービスログ
model ExternalService {
  id          String   @id @default(cuid())
  service     String   // ebay, yamato, sagawa, stripe, etc.
  type        String   // api_call, webhook, etc.
  // ...
}

// バーコードスキャナー
model BarcodeScanner {
  id          String   @id @default(cuid())
  locationId  String
  deviceName  String
  // ...
}
```

## 使用方法

### 開発環境でのテスト

```bash
# 環境変数を設定
cp .env.example .env.local

# Prismaマイグレーション実行
npm run db:migrate

# 開発サーバー起動
npm run dev
```

### 本番環境への移行

1. 環境変数を本番用に設定
2. 外部サービスのAPIキーを設定
3. PostgreSQLデータベースを設定
4. S3バケットを作成・設定
5. SendGridアカウントを設定

## 注意事項

### 開発環境
- 全ての外部サービスがモックされ、ローカルで完全に動作します
- SQLiteデータベースで軽量かつ高速な開発環境を提供
- 2要素認証はデフォルトで無効化

### 本番環境
- 全ての外部サービスが実際のAPIと連携
- PostgreSQLで本格的なデータ管理
- 2要素認証が有効化されセキュリティが強化

### テスト戦略
- E2EテストでUI動作を必ず確認（Playwright）
- モックサービスで外部依存を排除したテスト
- ステージング環境で本番同等のテストを実施

### メンテナンス
- 環境切り替えロジックの中央集中管理
- モックレスポンスの定期的な更新
- ログ監視とエラーハンドリングの充実

---

**更新履歴**
- 2024-06-21: 初版作成
- 2025-01-13: 実装状況に合わせて全面更新、実装済み機能を明記 