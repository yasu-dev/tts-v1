# 🧭 トリアージタグ・システム 機能仕様書

## 1. 目的・概要

本システムは、災害・事故などの大規模救護現場において、**トリアージタグ情報の電子化・リアルタイム共有・搬送管理**を実現するもの。
従来の紙タグ運用に加え、PWAを中心としたモバイル端末上での迅速な登録・更新・集計を可能にし、情報の一元管理・誤記防止・搬送最適化を目的とする。

---

## 2. システム構成と利用者

### 2.1 利用ロール

| ロール                         | 主な利用場面         | 権限範囲             |
| --------------------------- | -------------- | ---------------- |
| **IC (Incident Commander)** | 本部での統制・状況把握    | 全データ閲覧・搬送指示・分析   |
| **TRI (Triage Team)**       | 現場でのタグ登録・再判定   | タグ登録／更新（自担当エリア）  |
| **TRN (Transport Team)**    | 搬送車両でのQRスキャン更新 | 担当タグの搬送状態更新      |
| **HSP (Hospital)**          | 受入・収容報告        | 搬送対象タグの最終ステータス更新 |
| **AUD (Auditor)**           | 運用・監査          | 読取専用（改ざん検出監査）    |

---

## 3. 業務フロー（上位）

1. **発災登録**

   * ICがイベント情報を作成（イベント名・地域範囲・通信モード）。
2. **トリアージ登録**

   * TRIがQRタグをスキャンし、被災者情報（最小30秒）を登録。
   * STARTウィザードで分類（歩行→呼吸→脈→指示）。
3. **再判定（再トリアージ）**

   * 再評価時に人による再分類・理由記録・履歴保持。
4. **搬送指示／更新**

   * ICまたはTRNが搬送指示を出し、搬送中・到着・収容まで更新。
5. **医療機関受入**

   * HSPがQRスキャンで受入完了を報告。
6. **監査／報告**

   * AUDまたはICが集計結果を閲覧、改ざん検証、PDF出力。

---

## 4. 機能一覧

### 4.1 イベント管理機能

| 機能      | 概要                    | ロール |
| ------- | --------------------- | --- |
| イベント登録  | 発災イベントの作成（名称・範囲・通信方式） | IC  |
| 通信モード選択 | 通常／衛星／メッシュ切替          | IC  |
| エリア設定   | エリアポリゴンを描画・保存         | IC  |

---

### 4.2 トリアージ登録機能

| 機能         | 概要                    | 詳細要件             |
| ---------- | --------------------- | ---------------- |
| QRスキャン登録   | 紙タグのQRを読み込み、タグIDを生成   | カメラ／外部QRリーダー対応   |
| 最小登録（30秒）  | 必須項目：タグID・区分・位置・写真1枚  | オフライン保存可         |
| STARTウィザード | 歩行可否→呼吸→脈→指示の4段階判定    | Yes/No UI＋音声読み上げ |
| 判定理由       | AI判定との不一致時は理由必須       | 履歴自動保存           |
| 位置記録       | GPS／Wi-Fi／手動補正可、精度値保持 | Mapピン表示          |
| 受傷部位記録     | 人体図へのタッチマーク           | PDFにサムネ反映        |

---

### 4.3 再トリアージ機能

| 機能   | 内容             |
| ---- | -------------- |
| 判定変更 | 区分変更時、理由入力必須   |
| 履歴保持 | 変更履歴を時系列で全保存   |
| 表示   | 最新区分＋履歴リストを参照可 |
| 権限   | TRIまたはICのみ変更可  |

---

### 4.4 搬送管理機能

| 機能       | 内容                                    |
| -------- | ------------------------------------- |
| 搬送指示     | IC/TRNが対象タグを選択し、搬送先を指定                |
| 搬送先レコメンド | 距離・受入枠・専門・安定性からスコア算出                  |
| ステータス更新  | waiting→transporting→arrived→admitted |
| QR更新     | 各段階でQR再スキャンで確定                        |
| 到着報告     | HSPが到着・収容を報告                          |

---

### 4.5 地図表示機能

| 要素      | 内容              |
| ------- | --------------- |
| ピン表示    | タグ位置（色：区分、形：状態） |
| クラスタリング | 近接地点を自動統合       |
| 隊位置表示   | TRI/TRNの現在地を表示  |
| フィルタ    | 区分・エリア・搬送状態・時間帯 |
| 表示更新    | CRDT同期後に自動反映    |

---

### 4.6 リスト／検索機能

| 要素     | 内容               |
| ------ | ---------------- |
| 未搬送リスト | 未搬送×重症順（デフォルト）   |
| フィルタ条件 | 状態／区分／地域／病院      |
| 検索     | タグID・匿名ID・備考から検索 |
| ソート    | 区分→更新時刻→搬送状態     |

---

### 4.7 統計・分析機能

| 機能      | 内容             |
| ------- | -------------- |
| 区分別集計   | 黒・赤・黄・緑タグ人数／変遷 |
| 医療機関別   | 受入数／稼働率／平均搬送時間 |
| 時系列分析   | 登録・搬送推移／更新頻度   |
| ダッシュボード | リアルタイム更新／Map連動 |

---

### 4.8 出力・報告機能

| 出力物   | 内容                   |
| ----- | -------------------- |
| 個票PDF | 紙様式互換：QR・区分色・打刻欄・人体図 |
| 一覧CSV | 全タグデータ（フィルタ条件反映）     |
| 改ざん検証 | 監査ログのハッシュ整合性チェック     |

---

### 4.9 オフライン・同期機能

| 要素           | 内容                     |
| ------------ | ---------------------- |
| IndexedDB暗号化 | 端末内でAES-GCM暗号化保存       |
| 同期方式         | write-behind／ベクタ時計CRDT |
| 衝突解決         | 人決定フィールドはサーバ優先／差分履歴保存  |
| 復旧動作         | 回線復旧後5分以内に整合保証         |

---

### 4.10 セキュリティ・監査機能

| 要素        | 内容                          |
| --------- | --------------------------- |
| RBAC＋ABAC | ロール＋イベント属性で制御               |
| 監査ログ      | append-only JSONL＋ハッシュチェーン  |
| 改ざん検証API  | `/api/audit/verify` により検証可能 |
| 暗号鍵管理     | 端末ローカル鍵をユーザ鍵でラップ            |

---

### 4.11 運用・監視機能

| 項目           | 内容                       |
| ------------ | ------------------------ |
| メトリクス        | 登録件数、同期遅延、P95応答時間        |
| DR／バックアップ    | RPO≤5分、RTO≤30分、マルチAZ冗長構成 |
| Blue/Green切替 | Phase2で導入予定              |
| Runbook      | 通信切断・競合・DB障害時対応を手順化      |

---

## 5. 非機能要件まとめ（見解1補強済）

| 区分     | 要件値               | 出典  |
| ------ | ----------------- | --- |
| 検索性能   | P95 ≤ 1.0s        | 見解1 |
| 登録性能   | P95 ≤ 1.5s        | 見解1 |
| 地図描画   | 1,000ピン ≤ 1.5s    | 見解1 |
| 同期時間   | オフライン100件→5分整合    | 見解1 |
| 稼働率    | 通常99.9%、災害時99.95% | 見解1 |
| DR     | RPO 5分 / RTO 30分  | 見解1 |
| 改ざん防止  | ハッシュチェーン整合        | 見解1 |
| 紙互換    | PDFレイアウト一致        | 見解1 |
| イベント隔離 | eventId単位         | 見解4 |

---

## 6. 開発環境・構成（drawio準拠）

* **フロント**：Next.js 14 + TypeScript + Material-UI + Zustand + Dexie + automerge
* **バックエンド**：Next.js Route Handler (API層) → AWS Lambda想定
* **DB**：RDS(MySQL)＋S3＋CloudFront／CloudWatch監視
* **CI/CD**：GitHub Actions（lint/test/e2e）＋署名アーティファクト
* **PWA**：Workbox＋IndexedDB＋CRDT同期
* **E2Eテスト**：Playwright（通信断・100件同期・改ざん検証）

---

## 7. MVP範囲

* ロール：IC/TRI/TRN/HSP
* 対応機能：登録／再判定／搬送／地図／出力／同期／監査
* 対象件数：最大2,000タグ／イベント
* 目標：E2E受入基準5項目をGREEN化

---

## 8. 将来拡張（Phase2以降）

* AI姿勢分類補助（TensorFlow Liteモデル）
* ドローン位置送信API連携
* 巡回最適化（Greedy+2-opt）
* MFA認証・OIDC統合
* 外部病院システム連携（FHIRベース）

---

## 9. 受入基準（自動検証）

1. オフライン100件登録→復旧5分以内整合
2. 未搬送赤タグ検索 P95 ≤ 1.0s
3. 画像付登録 P95 ≤ 1.5s
4. 改ざん検証 = OK
5. 地図1000ピン描画 P95 ≤ 1.5s

---

## 10. トレースマトリクス（要求→仕様→受入）

| 要求ID  | 機能項目    | 該当仕様章    | テスト項目      |
| ----- | ------- | -------- | ---------- |
| RQ-01 | オフライン登録 | 4.2, 4.9 | TC01, TC02 |
| RQ-02 | START判定 | 4.2, 4.3 | TC03       |
| RQ-03 | 搬送管理    | 4.4      | TC04       |
| RQ-04 | PDF出力   | 4.8      | TC05       |
| RQ-05 | 改ざん検証   | 4.10     | TC06       |

---
